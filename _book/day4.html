<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Day 4: Introduction to 3D Rendering – GPU-Accelerated Mathematical Illustration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./day5a.html" rel="next">
<link href="./day3.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-86daaaaad7353f9cc0c554efc1dd6d94.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-f8dc6eab18fde03278982b0b35885446.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed04f5f1653af6df52378e13bfdac05e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d37bfdfd9a2222927534875c15a9020f.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./day4.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Day 4: Introduction to 3D Rendering</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">GPU-Accelerated Mathematical Illustration</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/yourusername/shader-course" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./GPU-Accelerated-Mathematical-Illustration.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./outline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Outline</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Day 1: Introduction to Shader Programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Day 2: Complex Dynamics and Iterated Inversions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Day 3: Geometric Tilings in Euclidean and Hyperbolic Space</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Day 4: Introduction to 3D Rendering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day5a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Day 5a</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./day5b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Day 5bs</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glsl-reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">GLSL</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./debug-reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Debugging</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./folding-fractals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Folding Fractals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schottky.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Schottky Groups, Möbius Maps, and GLSL</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">4.1</span> Overview</a></li>
  <li><a href="#part-1-analytical-ray-tracing" id="toc-part-1-analytical-ray-tracing" class="nav-link" data-scroll-target="#part-1-analytical-ray-tracing"><span class="header-section-number">4.2</span> Part 1: Analytical Ray Tracing</a>
  <ul class="collapse">
  <li><a href="#camera-and-ray-setup" id="toc-camera-and-ray-setup" class="nav-link" data-scroll-target="#camera-and-ray-setup">Camera and Ray Setup</a></li>
  <li><a href="#ray-sphere-intersection" id="toc-ray-sphere-intersection" class="nav-link" data-scroll-target="#ray-sphere-intersection">Ray-Sphere Intersection</a></li>
  <li><a href="#adding-lighting" id="toc-adding-lighting" class="nav-link" data-scroll-target="#adding-lighting">Adding Lighting</a></li>
  <li><a href="#ray-torus-intersection-where-analytical-gets-complex" id="toc-ray-torus-intersection-where-analytical-gets-complex" class="nav-link" data-scroll-target="#ray-torus-intersection-where-analytical-gets-complex">Ray-Torus Intersection: Where Analytical Gets Complex</a></li>
  </ul></li>
  <li><a href="#part-2-signed-distance-functions-and-raymarching" id="toc-part-2-signed-distance-functions-and-raymarching" class="nav-link" data-scroll-target="#part-2-signed-distance-functions-and-raymarching"><span class="header-section-number">4.3</span> Part 2: Signed Distance Functions and Raymarching</a>
  <ul class="collapse">
  <li><a href="#introduction-to-sdfs" id="toc-introduction-to-sdfs" class="nav-link" data-scroll-target="#introduction-to-sdfs">Introduction to SDFs</a></li>
  <li><a href="#the-raymarching-algorithm" id="toc-the-raymarching-algorithm" class="nav-link" data-scroll-target="#the-raymarching-algorithm">The Raymarching Algorithm</a></li>
  <li><a href="#the-power-of-sdfs-instant-shape-swapping" id="toc-the-power-of-sdfs-instant-shape-swapping" class="nav-link" data-scroll-target="#the-power-of-sdfs-instant-shape-swapping">The Power of SDFs: Instant Shape Swapping</a></li>
  <li><a href="#composing-multiple-objects" id="toc-composing-multiple-objects" class="nav-link" data-scroll-target="#composing-multiple-objects">Composing Multiple Objects</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">4.4</span> Summary</a></li>
  <li><a href="#homework" id="toc-homework" class="nav-link" data-scroll-target="#homework"><span class="header-section-number">4.5</span> Homework</a>
  <ul class="collapse">
  <li><a href="#required-algebraic-variety-rendering" id="toc-required-algebraic-variety-rendering" class="nav-link" data-scroll-target="#required-algebraic-variety-rendering">Required: Algebraic Variety Rendering</a></li>
  <li><a href="#optional-exercises" id="toc-optional-exercises" class="nav-link" data-scroll-target="#optional-exercises">Optional Exercises</a></li>
  </ul></li>
  <li><a href="#looking-ahead-to-day-5" id="toc-looking-ahead-to-day-5" class="nav-link" data-scroll-target="#looking-ahead-to-day-5"><span class="header-section-number">4.6</span> Looking Ahead to Day 5</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Day 4: Introduction to 3D Rendering</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">4.1</span> Overview</h2>
<p>Today we enter the third dimension! We’ll learn how to cast rays from a camera and test for intersections with 3D objects. We’ll start with analytical methods (solving equations directly) for spheres and tori, then transition to raymarching with signed distance functions—a more flexible approach that enables complex procedural scenes.</p>
<p>By the end of today, you’ll understand: - How to set up a camera and generate rays for each pixel - Analytical ray-object intersection for simple surfaces - Why analytical methods become challenging for complex geometry - Signed distance functions as an alternative representation - The raymarching algorithm (sphere tracing) - How to compose multiple objects and assign materials</p>
<hr>
</section>
<section id="part-1-analytical-ray-tracing" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="part-1-analytical-ray-tracing"><span class="header-section-number">4.2</span> Part 1: Analytical Ray Tracing</h2>
<section id="camera-and-ray-setup" class="level3">
<h3 class="anchored" data-anchor-id="camera-and-ray-setup">Camera and Ray Setup</h3>
<section id="the-rendering-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="the-rendering-pipeline">The Rendering Pipeline</h4>
<p>For each pixel, we need to: 1. Generate a ray from the camera through that pixel 2. Find where (if anywhere) the ray intersects scene geometry 3. Compute color based on surface properties and lighting</p>
</section>
<section id="coordinate-system" class="level4">
<h4 class="anchored" data-anchor-id="coordinate-system">Coordinate System</h4>
<p>We’ll use the standard graphics convention: - <strong>Y-axis</strong> points up - <strong>Z-axis</strong> points toward the camera (out of the screen) - <strong>X-axis</strong> points right - Right-handed coordinate system</p>
</section>
<section id="pinhole-camera-model" class="level4">
<h4 class="anchored" data-anchor-id="pinhole-camera-model">Pinhole Camera Model</h4>
<p>Our camera sits at the origin looking down the negative Z-axis. For a pixel at normalized coordinates <span class="math inline">\((u, v) \in [-1, 1]^2\)</span>, we generate a ray:</p>
<p><strong>Ray origin:</strong> <span class="math inline">\(\mathbf{o} = (0, 0, 0)\)</span> (camera position)<br>
<strong>Ray direction:</strong> <span class="math inline">\(\mathbf{d} = \text{normalize}(u, v, -f)\)</span></p>
<p>where <span class="math inline">\(f\)</span> is the focal length, related to field of view by: <span class="math inline">\(f = 1/\tan(\text{FOV}/2)\)</span>.</p>
</section>
<section id="parametric-ray-equation" class="level4">
<h4 class="anchored" data-anchor-id="parametric-ray-equation">Parametric Ray Equation</h4>
<p>A ray can be written as: <span class="math display">\[\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}\]</span></p>
<p>where <span class="math inline">\(t \geq 0\)</span> is the parameter. Points along the ray correspond to different values of <span class="math inline">\(t\)</span>.</p>
</section>
<section id="implementation" class="level4">
<h4 class="anchored" data-anchor-id="implementation">Implementation</h4>
<p>Let’s start by visualizing our rays without any intersections:</p>
<p><strong>Shader 1: Ray Visualization</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Normalize pixel coordinates to [-1, 1]</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Correct for aspect ratio</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Field of view</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ray direction (camera at origin, looking down -Z)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Color based on ray direction (visualize the rays)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color <span class="op">=</span> rayDir <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see a colorful gradient showing the direction of each ray. This confirms our camera setup is working!</p>
<hr>
</section>
</section>
<section id="ray-sphere-intersection" class="level3">
<h3 class="anchored" data-anchor-id="ray-sphere-intersection">Ray-Sphere Intersection</h3>
<section id="the-sphere-equation" class="level4">
<h4 class="anchored" data-anchor-id="the-sphere-equation">The Sphere Equation</h4>
<p>A sphere of radius <span class="math inline">\(r\)</span> centered at position <span class="math inline">\(\mathbf{c}\)</span> is defined by: <span class="math display">\[|\mathbf{p} - \mathbf{c}|^2 = r^2\]</span></p>
<p>All points <span class="math inline">\(\mathbf{p}\)</span> satisfying this equation lie on the sphere’s surface.</p>
</section>
<section id="finding-the-intersection" class="level4">
<h4 class="anchored" data-anchor-id="finding-the-intersection">Finding the Intersection</h4>
<p>We want to find where our ray <span class="math inline">\(\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}\)</span> intersects the sphere. Substituting the ray equation into the sphere equation: <span class="math display">\[|\mathbf{o} + t\mathbf{d} - \mathbf{c}|^2 = r^2\]</span></p>
<p>Let <span class="math inline">\(\mathbf{oc} = \mathbf{o} - \mathbf{c}\)</span> (vector from sphere center to ray origin). Expanding: <span class="math display">\[|\mathbf{oc} + t\mathbf{d}|^2 = r^2\]</span> <span class="math display">\[|\mathbf{oc}|^2 + 2t(\mathbf{oc} \cdot \mathbf{d}) + t^2|\mathbf{d}|^2 = r^2\]</span></p>
<p>This is a quadratic equation in <span class="math inline">\(t\)</span>: <span class="math display">\[at^2 + bt + c = 0\]</span></p>
<p>where: - <span class="math inline">\(a = |\mathbf{d}|^2\)</span> (equals 1 if direction is normalized) - <span class="math inline">\(b = 2(\mathbf{oc} \cdot \mathbf{d})\)</span> - <span class="math inline">\(c = |\mathbf{oc}|^2 - r^2\)</span></p>
<p>The <strong>discriminant</strong> <span class="math inline">\(\Delta = b^2 - 4ac\)</span> tells us: - <span class="math inline">\(\Delta &lt; 0\)</span>: no intersection (ray misses sphere) - <span class="math inline">\(\Delta = 0\)</span>: one intersection (ray grazes sphere) - <span class="math inline">\(\Delta &gt; 0\)</span>: two intersections (ray enters and exits)</p>
<p>We want the smaller positive <span class="math inline">\(t\)</span> (the entry point).</p>
</section>
<section id="implementation-1" class="level4">
<h4 class="anchored" data-anchor-id="implementation-1">Implementation</h4>
<p><strong>Shader 2: Basic Sphere</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">intersectSphere</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">,</span> <span class="dt">vec3</span> sphereCenter<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> oc <span class="op">=</span> rayOrigin <span class="op">-</span> sphereCenter<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> a <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>rayDir<span class="op">,</span> rayDir<span class="op">);</span>  <span class="co">// Should be 1.0 if rayDir is normalized</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> b <span class="op">=</span> <span class="fl">2.0</span> <span class="op">*</span> <span class="bu">dot</span><span class="op">(</span>oc<span class="op">,</span> rayDir<span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>oc<span class="op">,</span> oc<span class="op">)</span> <span class="op">-</span> radius <span class="op">*</span> radius<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> discriminant <span class="op">=</span> b <span class="op">*</span> b <span class="op">-</span> <span class="fl">4.0</span> <span class="op">*</span> a <span class="op">*</span> c<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>discriminant <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>  <span class="co">// No intersection</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return the closer intersection</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t1 <span class="op">=</span> <span class="op">(-</span>b <span class="op">-</span> <span class="bu">sqrt</span><span class="op">(</span>discriminant<span class="op">))</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> a<span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t2 <span class="op">=</span> <span class="op">(-</span>b <span class="op">+</span> <span class="bu">sqrt</span><span class="op">(</span>discriminant<span class="op">))</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> a<span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return closest positive t</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> t1<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> t2<span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>  <span class="co">// Both behind camera</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup ray</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sphere parameters</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> sphereCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphereRadius <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Test intersection</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectSphere</span><span class="op">(</span>rayOrigin<span class="op">,</span> rayDir<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hit the sphere</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span>  <span class="co">// Red</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Background</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span>  <span class="co">// Dark blue</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see a flat red disk! It looks 2D because we don’t have lighting yet—we can’t see the sphere’s curvature.</p>
<hr>
</section>
</section>
<section id="adding-lighting" class="level3">
<h3 class="anchored" data-anchor-id="adding-lighting">Adding Lighting</h3>
<p>To see the 3D structure, we need to compute lighting based on the <strong>surface normal</strong>.</p>
<section id="surface-normal" class="level4">
<h4 class="anchored" data-anchor-id="surface-normal">Surface Normal</h4>
<p>For a sphere centered at <span class="math inline">\(\mathbf{c}\)</span>, the outward normal at surface point <span class="math inline">\(\mathbf{p}\)</span> is: <span class="math display">\[\mathbf{n} = \frac{\mathbf{p} - \mathbf{c}}{r}\]</span></p>
<p>This is just the vector from center to surface, normalized.</p>
</section>
<section id="diffuse-lighting" class="level4">
<h4 class="anchored" data-anchor-id="diffuse-lighting">Diffuse Lighting</h4>
<p>The simplest lighting model: <strong>Lambertian diffuse shading</strong>. Surface brightness depends on the angle between the normal <span class="math inline">\(\mathbf{n}\)</span> and light direction <span class="math inline">\(\mathbf{l}\)</span>: <span class="math display">\[\text{brightness} = \max(0, \mathbf{n} \cdot \mathbf{l})\]</span></p>
<p>The <span class="math inline">\(\max(0, \cdots)\)</span> ensures surfaces facing away from the light remain dark.</p>
<p><strong>Shader 3: Sphere with Lighting</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">intersectSphere</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">,</span> <span class="dt">vec3</span> sphereCenter<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> oc <span class="op">=</span> rayOrigin <span class="op">-</span> sphereCenter<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> a <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>rayDir<span class="op">,</span> rayDir<span class="op">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> b <span class="op">=</span> <span class="fl">2.0</span> <span class="op">*</span> <span class="bu">dot</span><span class="op">(</span>oc<span class="op">,</span> rayDir<span class="op">);</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>oc<span class="op">,</span> oc<span class="op">)</span> <span class="op">-</span> radius <span class="op">*</span> radius<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> discriminant <span class="op">=</span> b <span class="op">*</span> b <span class="op">-</span> <span class="fl">4.0</span> <span class="op">*</span> a <span class="op">*</span> c<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>discriminant <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t1 <span class="op">=</span> <span class="op">(-</span>b <span class="op">-</span> <span class="bu">sqrt</span><span class="op">(</span>discriminant<span class="op">))</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> a<span class="op">);</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t2 <span class="op">=</span> <span class="op">(-</span>b <span class="op">+</span> <span class="bu">sqrt</span><span class="op">(</span>discriminant<span class="op">))</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> a<span class="op">);</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> t1<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> t2<span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">sphereNormal</span><span class="op">(</span><span class="dt">vec3</span> hitPoint<span class="op">,</span> <span class="dt">vec3</span> sphereCenter<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">(</span>hitPoint <span class="op">-</span> sphereCenter<span class="op">)</span> <span class="op">/</span> radius<span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup ray</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sphere</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> sphereCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphereRadius <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectSphere</span><span class="op">(</span>rayOrigin<span class="op">,</span> rayDir<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hit point</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> rayOrigin <span class="op">+</span> t <span class="op">*</span> rayDir<span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Surface normal</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">sphereNormal</span><span class="op">(</span>hitPoint<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Light direction (from above and to the right)</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Diffuse lighting</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sphere color</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> sphereColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span>  <span class="co">// Red</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> sphereColor <span class="op">*</span> diffuse<span class="op">;</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add ambient light so dark side isn't completely black</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        color <span class="op">+=</span> sphereColor <span class="op">*</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now the sphere looks 3D! The lighting reveals its curvature. Beautiful!</p>
<hr>
</section>
</section>
<section id="ray-torus-intersection-where-analytical-gets-complex" class="level3">
<h3 class="anchored" data-anchor-id="ray-torus-intersection-where-analytical-gets-complex">Ray-Torus Intersection: Where Analytical Gets Complex</h3>
<section id="the-torus-equation" class="level4">
<h4 class="anchored" data-anchor-id="the-torus-equation">The Torus Equation</h4>
<p>A torus with major radius <span class="math inline">\(R\)</span> (distance from center to tube center) and minor radius <span class="math inline">\(r\)</span> (tube thickness) has the implicit equation: <span class="math display">\[\left(\sqrt{x^2 + z^2} - R\right)^2 + y^2 = r^2\]</span></p>
<p>Or in vector form: <span class="math display">\[\left(|\mathbf{p}_{xz}| - R\right)^2 + p_y^2 = r^2\]</span></p>
<p>where <span class="math inline">\(\mathbf{p}_{xz} = (p_x, p_z)\)</span> is the projection onto the XZ-plane.</p>
</section>
<section id="the-challenge" class="level4">
<h4 class="anchored" data-anchor-id="the-challenge">The Challenge</h4>
<p>Substituting our ray equation into this gives a <strong>quartic polynomial</strong> (degree 4): <span class="math display">\[at^4 + bt^3 + ct^2 + dt + e = 0\]</span></p>
<p>Unlike quadratics (which have a simple formula), quartic equations require sophisticated algebraic methods. Here’s what solving it actually looks like:</p>
<p><strong>Shader 4: Analytical Torus</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From Inigo Quilez - https://www.shadertoy.com/view/XdSGWy</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Analytical quartic solver for torus intersection</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">intersectTorus</span><span class="op">(</span><span class="dt">vec3</span> ro<span class="op">,</span> <span class="dt">vec3</span> rd<span class="op">,</span> <span class="dt">vec2</span> tor<span class="op">)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> po <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Ra2 <span class="op">=</span> tor<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> tor<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> ra2 <span class="op">=</span> tor<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> m <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>ro<span class="op">,</span> ro<span class="op">);</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> n <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>ro<span class="op">,</span> rd<span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bounding sphere check</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> h <span class="op">=</span> n<span class="op">*</span>n <span class="op">-</span> m <span class="op">+</span> <span class="op">(</span>tor<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>tor<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find quartic coefficients</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k <span class="op">=</span> <span class="op">(</span>m <span class="op">-</span> ra2 <span class="op">-</span> Ra2<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k3 <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k2 <span class="op">=</span> n<span class="op">*</span>n <span class="op">+</span> Ra2<span class="op">*</span>rd<span class="op">.</span><span class="fu">z</span><span class="op">*</span>rd<span class="op">.</span><span class="fu">z</span> <span class="op">+</span> k<span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k1 <span class="op">=</span> k<span class="op">*</span>n <span class="op">+</span> Ra2<span class="op">*</span>ro<span class="op">.</span><span class="fu">z</span><span class="op">*</span>rd<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k0 <span class="op">=</span> k<span class="op">*</span>k <span class="op">+</span> Ra2<span class="op">*</span>ro<span class="op">.</span><span class="fu">z</span><span class="op">*</span>ro<span class="op">.</span><span class="fu">z</span> <span class="op">-</span> Ra2<span class="op">*</span>ra2<span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prevent numerical issues</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>k3<span class="op">*(</span>k3<span class="op">*</span>k3 <span class="op">-</span> k2<span class="op">)</span> <span class="op">+</span> k1<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        po <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> tmp <span class="op">=</span> k1<span class="op">;</span> k1 <span class="op">=</span> k3<span class="op">;</span> k3 <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        k0 <span class="op">=</span> <span class="fl">1.0</span><span class="op">/</span>k0<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        k1 <span class="op">=</span> k1<span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        k2 <span class="op">=</span> k2<span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        k3 <span class="op">=</span> k3<span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c2 <span class="op">=</span> <span class="fl">2.0</span><span class="op">*</span>k2 <span class="op">-</span> <span class="fl">3.0</span><span class="op">*</span>k3<span class="op">*</span>k3<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c1 <span class="op">=</span> k3<span class="op">*(</span>k3<span class="op">*</span>k3 <span class="op">-</span> k2<span class="op">)</span> <span class="op">+</span> k1<span class="op">;</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c0 <span class="op">=</span> k3<span class="op">*(</span>k3<span class="op">*(-</span><span class="fl">3.0</span><span class="op">*</span>k3<span class="op">*</span>k3 <span class="op">+</span> <span class="fl">4.0</span><span class="op">*</span>k2<span class="op">)</span> <span class="op">-</span> <span class="fl">8.0</span><span class="op">*</span>k1<span class="op">)</span> <span class="op">+</span> <span class="fl">4.0</span><span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    c2 <span class="op">/=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">*=</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">/=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Q <span class="op">=</span> c2<span class="op">*</span>c2 <span class="op">+</span> c0<span class="op">;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> R <span class="op">=</span> <span class="fl">3.0</span><span class="op">*</span>c0<span class="op">*</span>c2 <span class="op">-</span> c2<span class="op">*</span>c2<span class="op">*</span>c2 <span class="op">-</span> c1<span class="op">*</span>c1<span class="op">;</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> h2 <span class="op">=</span> R<span class="op">*</span>R <span class="op">-</span> Q<span class="op">*</span>Q<span class="op">*</span>Q<span class="op">;</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h2 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4 intersections</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> sQ <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>Q<span class="op">);</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="fl">2.0</span><span class="op">*</span>sQ<span class="op">*</span><span class="bu">cos</span><span class="op">(</span><span class="bu">acos</span><span class="op">(</span>R<span class="op">/(</span>sQ<span class="op">*</span>Q<span class="op">))</span> <span class="op">/</span> <span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2 intersections</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> sQ <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">sqrt</span><span class="op">(</span>h2<span class="op">)</span> <span class="op">+</span> <span class="bu">abs</span><span class="op">(</span>R<span class="op">),</span> <span class="fl">1.0</span><span class="op">/</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="bu">sign</span><span class="op">(</span>R<span class="op">)*</span><span class="bu">abs</span><span class="op">(</span>sQ <span class="op">+</span> Q<span class="op">/</span>sQ<span class="op">);</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> c2 <span class="op">-</span> z<span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d1 <span class="op">=</span> z <span class="op">-</span> <span class="fl">3.0</span><span class="op">*</span>c2<span class="op">;</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d2 <span class="op">=</span> z<span class="op">*</span>z <span class="op">-</span> <span class="fl">3.0</span><span class="op">*</span>c0<span class="op">;</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>d1<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1.0e-4</span><span class="op">)</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>d2 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>d2<span class="op">);</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>d1 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        d1 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>d1<span class="op">/</span><span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> c1<span class="op">/</span>d1<span class="op">;</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> result <span class="op">=</span> <span class="fl">1e20</span><span class="op">;</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> d1<span class="op">*</span>d1 <span class="op">-</span> z <span class="op">+</span> d2<span class="op">;</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>h2<span class="op">);</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t1 <span class="op">=</span> <span class="op">-</span>d1 <span class="op">-</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t2 <span class="op">=</span> <span class="op">-</span>d1 <span class="op">+</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        t1 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t1 <span class="op">:</span> t1<span class="op">;</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        t2 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t2 <span class="op">:</span> t2<span class="op">;</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> t1<span class="op">;</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>result<span class="op">,</span> t2<span class="op">);</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> d1<span class="op">*</span>d1 <span class="op">-</span> z <span class="op">-</span> d2<span class="op">;</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>h2<span class="op">);</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t1 <span class="op">=</span> d1 <span class="op">-</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t2 <span class="op">=</span> d1 <span class="op">+</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        t1 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t1 <span class="op">:</span> t1<span class="op">;</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        t2 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t2 <span class="op">:</span> t2<span class="op">;</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>result<span class="op">,</span> t1<span class="op">);</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>result<span class="op">,</span> t2<span class="op">);</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> result<span class="op">;</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">torusNormal</span><span class="op">(</span><span class="dt">vec3</span> pos<span class="op">,</span> <span class="dt">vec2</span> tor<span class="op">)</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span>pos <span class="op">*</span> <span class="op">(</span><span class="bu">dot</span><span class="op">(</span>pos<span class="op">,</span>pos<span class="op">)</span> <span class="op">-</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">*</span>tor<span class="op">.</span><span class="fu">y</span> <span class="op">-</span> tor<span class="op">.</span><span class="fu">x</span><span class="op">*</span>tor<span class="op">.</span><span class="fu">x</span><span class="op">*</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">)));</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup ray</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Torus parameters</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> torus <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">);</span>  <span class="co">// (major radius, minor radius)</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> torusCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.5</span><span class="op">);</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust ray for torus position</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> ro <span class="op">=</span> rayOrigin <span class="op">-</span> torusCenter<span class="op">;</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectTorus</span><span class="op">(</span>ro<span class="op">,</span> rayDir<span class="op">,</span> torus<span class="op">);</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ro <span class="op">+</span> t <span class="op">*</span> rayDir<span class="op">;</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">torusNormal</span><span class="op">(</span>hitPoint<span class="op">,</span> torus<span class="op">);</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> torusColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span>  <span class="co">// Cyan</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> torusColor <span class="op">*</span> diffuse <span class="op">+</span> torusColor <span class="op">*</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Look at that intersection code! Over 80 lines of complex algebra just to render one torus. And this is still a relatively simple surface—imagine arbitrary algebraic varieties, or trying to combine multiple objects with boolean operations.</p>
<p>Analytical methods work beautifully for simple geometry, but we need a more flexible approach for complex scenes.</p>
<hr>
</section>
</section>
</section>
<section id="part-2-signed-distance-functions-and-raymarching" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="part-2-signed-distance-functions-and-raymarching"><span class="header-section-number">4.3</span> Part 2: Signed Distance Functions and Raymarching</h2>
<section id="introduction-to-sdfs" class="level3">
<h3 class="anchored" data-anchor-id="introduction-to-sdfs">Introduction to SDFs</h3>
<p>A <strong>signed distance function</strong> (SDF) gives the distance from any point in space to the nearest surface:</p>
<p><span class="math display">\[d(\mathbf{p}) = \begin{cases}
&gt; 0 &amp; \text{outside surface} \\
= 0 &amp; \text{on surface} \\
&lt; 0 &amp; \text{inside surface}
\end{cases}\]</span></p>
<p>Crucially, <span class="math inline">\(|d(\mathbf{p})|\)</span> is the actual Euclidean distance to the surface.</p>
<section id="why-sdfs" class="level4">
<h4 class="anchored" data-anchor-id="why-sdfs">Why SDFs?</h4>
<p>SDFs have a powerful property: if we’re at point <span class="math inline">\(\mathbf{p}\)</span> and the surface is distance <span class="math inline">\(d\)</span> away, we can safely move <span class="math inline">\(d\)</span> units in <em>any</em> direction without hitting anything. This enables <strong>sphere tracing</strong>—we march along the ray taking steps proportional to the SDF value.</p>
</section>
<section id="sdf-examples" class="level4">
<h4 class="anchored" data-anchor-id="sdf-examples">SDF Examples</h4>
<p>Let’s see SDFs for shapes we’ve already rendered analytically:</p>
<p><strong>Sphere:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Compare this to our 30+ line analytical intersection! Much simpler.</p>
<p><strong>Torus:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdTorus</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> majorRadius<span class="op">,</span> <span class="dt">float</span> minorRadius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> q <span class="op">=</span> p <span class="op">-</span> center<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> pxz <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span>q<span class="op">.</span><span class="fu">x</span><span class="op">,</span> q<span class="op">.</span><span class="fu">z</span><span class="op">);</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d <span class="op">=</span> <span class="bu">length</span><span class="op">(</span>pxz<span class="op">)</span> <span class="op">-</span> majorRadius<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span><span class="dt">vec2</span><span class="op">(</span>d<span class="op">,</span> q<span class="op">.</span><span class="fu">y</span><span class="op">))</span> <span class="op">-</span> minorRadius<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Again, dramatically simpler than the quartic solver!</p>
<p><strong>Other Primitives</strong></p>
<p>Many more SDFs exist: boxes, cylinders, capsules, cones, pyramids, etc. See <a href="https://iquilezles.org/articles/distfunctions/">Inigo Quilez’s comprehensive library</a> for a complete reference. Each SDF is typically just a few lines of code.</p>
<hr>
</section>
</section>
<section id="the-raymarching-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="the-raymarching-algorithm">The Raymarching Algorithm</h3>
<p><strong>Sphere tracing</strong> works like this:</p>
<ol type="1">
<li>Start at the ray origin</li>
<li>Evaluate the SDF at current position</li>
<li>March forward along the ray by that distance (safe step!)</li>
<li>Repeat until:
<ul>
<li>Very close to surface (SDF ≈ 0) → hit!</li>
<li>Too far away → miss</li>
<li>Too many steps → give up</li>
</ul></li>
</ol>
<p>Here’s the algorithm:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define scene geometry (we'll implement this)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> <span class="fu">raymarch</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">,</span> <span class="dt">out</span> <span class="dt">float</span> hitDist<span class="op">,</span> <span class="dt">out</span> <span class="dt">vec3</span> hitPos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> pos <span class="op">=</span> rayOrigin <span class="op">+</span> t <span class="op">*</span> rayDir<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Close enough to surface?</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>d<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            hitDist <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            hitPos <span class="op">=</span> pos<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// March forward</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Too far?</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">100.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="normal-estimation-via-gradient" class="level4">
<h4 class="anchored" data-anchor-id="normal-estimation-via-gradient">Normal Estimation via Gradient</h4>
<p>For an SDF <span class="math inline">\(d(\mathbf{p})\)</span>, the gradient <span class="math inline">\(\nabla d\)</span> points perpendicular to the surface (it’s the normal direction). We estimate it using finite differences:</p>
<p><span class="math display">\[\frac{\partial d}{\partial x} \approx \frac{d(x + \epsilon, y, z) - d(x - \epsilon, y, z)}{2\epsilon}\]</span></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">estimateNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dx <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dy <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dz <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">));</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>dx<span class="op">,</span> dy<span class="op">,</span> dz<span class="op">));</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="first-raymarch-shader" class="level4">
<h4 class="anchored" data-anchor-id="first-raymarch-shader">First Raymarch Shader</h4>
<p><strong>Shader 5: Single Sphere with Raymarching</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">estimateNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dx <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dy <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dz <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">));</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>dx<span class="op">,</span> dy<span class="op">,</span> dz<span class="op">));</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> <span class="fu">raymarch</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">,</span> <span class="dt">out</span> <span class="dt">vec3</span> hitPos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> pos <span class="op">=</span> rayOrigin <span class="op">+</span> t <span class="op">*</span> rayDir<span class="op">;</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>d<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>            hitPos <span class="op">=</span> pos<span class="op">;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">100.0</span><span class="op">)</span> <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup ray</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Raymarch</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> hitPos<span class="op">;</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> hit <span class="op">=</span> <span class="fu">raymarch</span><span class="op">(</span>rayOrigin<span class="op">,</span> rayDir<span class="op">,</span> hitPos<span class="op">);</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>hit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">estimateNormal</span><span class="op">(</span>hitPos<span class="op">);</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> sphereColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> sphereColor <span class="op">*</span> diffuse <span class="op">+</span> sphereColor <span class="op">*</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Same result as the analytical sphere, but now we have a flexible framework!</p>
<hr>
</section>
</section>
<section id="the-power-of-sdfs-instant-shape-swapping" class="level3">
<h3 class="anchored" data-anchor-id="the-power-of-sdfs-instant-shape-swapping">The Power of SDFs: Instant Shape Swapping</h3>
<p>Here’s where SDFs shine: <strong>changing shapes is trivial</strong>. Just swap out one SDF for another!</p>
<p><strong>Shader 6: Shapeshifting</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdTorus</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> majorRadius<span class="op">,</span> <span class="dt">float</span> minorRadius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> q <span class="op">=</span> p <span class="op">-</span> center<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> pxz <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span>q<span class="op">.</span><span class="fu">x</span><span class="op">,</span> q<span class="op">.</span><span class="fu">z</span><span class="op">);</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d <span class="op">=</span> <span class="bu">length</span><span class="op">(</span>pxz<span class="op">)</span> <span class="op">-</span> majorRadius<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span><span class="dt">vec2</span><span class="op">(</span>d<span class="op">,</span> q<span class="op">.</span><span class="fu">y</span><span class="op">))</span> <span class="op">-</span> minorRadius<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdBox</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">vec3</span> halfExtents<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> q <span class="op">=</span> <span class="bu">abs</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> halfExtents<span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>q<span class="op">,</span> <span class="fl">0.0</span><span class="op">))</span> <span class="op">+</span> <span class="bu">min</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>q<span class="op">.</span><span class="fu">x</span><span class="op">,</span> <span class="bu">max</span><span class="op">(</span>q<span class="op">.</span><span class="fu">y</span><span class="op">,</span> q<span class="op">.</span><span class="fu">z</span><span class="op">)),</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Uncomment ONE of these to see different shapes!</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Everything else stays the same - same raymarch, same lighting, same normal calculation</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">//return sdTorus(p, vec3(0.0, 0.0, -3.0), 1.0, 0.4);</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//return sdBox(p, vec3(0.0, 0.0, -3.0), vec3(0.8, 0.8, 0.8));</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try any SDF from https://iquilezles.org/articles/distfunctions/</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">estimateNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dx <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dy <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dz <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">));</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>dx<span class="op">,</span> dy<span class="op">,</span> dz<span class="op">));</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> <span class="fu">raymarch</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">,</span> <span class="dt">out</span> <span class="dt">vec3</span> hitPos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> pos <span class="op">=</span> rayOrigin <span class="op">+</span> t <span class="op">*</span> rayDir<span class="op">;</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>d<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            hitPos <span class="op">=</span> pos<span class="op">;</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">100.0</span><span class="op">)</span> <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> hitPos<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> hit <span class="op">=</span> <span class="fu">raymarch</span><span class="op">(</span>rayOrigin<span class="op">,</span> rayDir<span class="op">,</span> hitPos<span class="op">);</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>hit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">estimateNormal</span><span class="op">(</span>hitPos<span class="op">);</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> objectColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span>  <span class="co">// Cyan</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> objectColor <span class="op">*</span> diffuse <span class="op">+</span> objectColor <span class="op">*</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Comment/uncomment different SDFs in <code>sceneSDF()</code> to instantly see different shapes! Try adding more from Quilez’s library. The raymarching algorithm doesn’t care what shape you use—it just follows the distance field.</p>
<hr>
</section>
<section id="composing-multiple-objects" class="level3">
<h3 class="anchored" data-anchor-id="composing-multiple-objects">Composing Multiple Objects</h3>
<p>To combine multiple objects, we simply take the <strong>minimum distance</strong> to any object. The closest surface wins!</p>
<p><strong>Shader 7: Multiple Objects with Materials</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdTorus</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> majorRadius<span class="op">,</span> <span class="dt">float</span> minorRadius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> q <span class="op">=</span> p <span class="op">-</span> center<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> pxz <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span>q<span class="op">.</span><span class="fu">x</span><span class="op">,</span> q<span class="op">.</span><span class="fu">z</span><span class="op">);</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d <span class="op">=</span> <span class="bu">length</span><span class="op">(</span>pxz<span class="op">)</span> <span class="op">-</span> majorRadius<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span><span class="dt">vec2</span><span class="op">(</span>d<span class="op">,</span> q<span class="op">.</span><span class="fu">y</span><span class="op">))</span> <span class="op">-</span> minorRadius<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdPlane</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">float</span> height<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> p<span class="op">.</span><span class="fu">y</span> <span class="op">-</span> height<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Global variable to track which object we hit</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> gMaterialID<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d <span class="op">=</span> <span class="fl">1e10</span><span class="op">;</span>  <span class="co">// Start with very large distance</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sphere</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphere <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(-</span><span class="fl">1.2</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.5</span><span class="op">),</span> <span class="fl">0.8</span><span class="op">);</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>sphere <span class="op">&lt;</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> sphere<span class="op">;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        gMaterialID <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Torus</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> torus <span class="op">=</span> <span class="fu">sdTorus</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.2</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.5</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.3</span><span class="op">);</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>torus <span class="op">&lt;</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> torus<span class="op">;</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        gMaterialID <span class="op">=</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ground plane</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> plane <span class="op">=</span> <span class="fu">sdPlane</span><span class="op">(</span>p<span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>plane <span class="op">&lt;</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> plane<span class="op">;</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        gMaterialID <span class="op">=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> d<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">getMaterialColor</span><span class="op">(</span><span class="dt">float</span> matID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>matID <span class="op">&lt;</span> <span class="fl">1.5</span><span class="op">)</span> <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span>      <span class="co">// Sphere: red</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>matID <span class="op">&lt;</span> <span class="fl">2.5</span><span class="op">)</span> <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span>      <span class="co">// Torus: cyan</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">);</span>                       <span class="co">// Plane: gray</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">estimateNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dx <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dy <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dz <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">));</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>dx<span class="op">,</span> dy<span class="op">,</span> dz<span class="op">));</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> <span class="fu">raymarch</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">,</span> <span class="dt">out</span> <span class="dt">vec3</span> hitPos<span class="op">,</span> <span class="dt">out</span> <span class="dt">float</span> matID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> pos <span class="op">=</span> rayOrigin <span class="op">+</span> t <span class="op">*</span> rayDir<span class="op">;</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>d<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>            hitPos <span class="op">=</span> pos<span class="op">;</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>            matID <span class="op">=</span> gMaterialID<span class="op">;</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">100.0</span><span class="op">)</span> <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">45.0</span><span class="op">;</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> focalLength <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> rayDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">,</span> uv<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">-</span>focalLength<span class="op">));</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> hitPos<span class="op">;</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> matID<span class="op">;</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> hit <span class="op">=</span> <span class="fu">raymarch</span><span class="op">(</span>rayOrigin<span class="op">,</span> rayDir<span class="op">,</span> hitPos<span class="op">,</span> matID<span class="op">);</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>hit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">estimateNormal</span><span class="op">(</span>hitPos<span class="op">);</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> objectColor <span class="op">=</span> <span class="fu">getMaterialColor</span><span class="op">(</span>matID<span class="op">);</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> objectColor <span class="op">*</span> diffuse <span class="op">+</span> objectColor <span class="op">*</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Three objects with different colors! Adding more objects is trivial—just add another SDF check in <code>sceneSDF()</code>. Compare this to analytical methods where combining objects requires sophisticated CSG (constructive solid geometry) techniques.</p>
<hr>
</section>
</section>
<section id="summary" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="summary"><span class="header-section-number">4.4</span> Summary</h2>
<p>Today we learned two approaches to 3D rendering:</p>
<p><strong>Analytical Ray Tracing:</strong> - Solve equations directly for ray-surface intersection - Exact solutions, very efficient for simple geometry - Sphere: straightforward quadratic equation - Torus: complex quartic equation requiring sophisticated algebra - Becomes increasingly difficult for complex surfaces - Standard in production ray tracers for well-defined geometry</p>
<p><strong>SDF-Based Raymarching:</strong> - Represent surfaces as distance fields - March along rays using sphere tracing - Simple, uniform code for any geometry - Easy composition: just take minimum distance - Flexible—works for procedural, implicit, or arbitrary surfaces - Slightly slower than analytical, but much more versatile</p>
<p><strong>Key Concepts:</strong> - Camera setup and ray generation - Parametric ray equation: <span class="math inline">\(\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}\)</span> - Surface normals for lighting - Diffuse (Lambertian) shading - Signed distance functions (SDFs) - Sphere tracing algorithm - Normal estimation via gradient (finite differences) - Material tracking for multiple objects</p>
<p>Tomorrow we’ll explore advanced raymarching: domain operations for infinite repetition, boolean operations for smooth blending, and 3D fractals!</p>
<hr>
</section>
<section id="homework" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="homework"><span class="header-section-number">4.5</span> Homework</h2>
<section id="required-algebraic-variety-rendering" class="level3">
<h3 class="anchored" data-anchor-id="required-algebraic-variety-rendering">Required: Algebraic Variety Rendering</h3>
<p>Implement analytical ray tracing for an interesting polynomial implicit surface.</p>
<p><strong>Goal:</strong> Experience the challenges of analytical methods firsthand, then appreciate SDFs even more!</p>
<p><strong>Suggested surfaces:</strong> - <strong>Degree 3</strong>: Saddle surfaces, cubic varieties - <strong>Degree 4</strong>: Klein bottle projections, quartic surfaces with interesting topology - <strong>Cassini ovals</strong> in 3D: <span class="math inline">\((x^2 + y^2 + z^2)^2 - 2a^2(x^2 - y^2) = b^4 - a^4\)</span></p>
<p><strong>Implementation steps:</strong></p>
<ol type="1">
<li><strong>Define your implicit function</strong> <span class="math inline">\(F(x,y,z) = 0\)</span></li>
</ol>
<p>Example—a quartic surface:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">implicitFunction</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> r2 <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>p<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> r2 <span class="op">*</span> r2 <span class="op">-</span> <span class="op">(</span>p<span class="op">.</span><span class="fu">x</span><span class="op">*</span>p<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> p<span class="op">.</span><span class="fu">y</span><span class="op">*</span>p<span class="op">.</span><span class="fu">y</span> <span class="op">-</span> <span class="fl">2.0</span><span class="op">*</span>p<span class="op">.</span><span class="fu">z</span><span class="op">*</span>p<span class="op">.</span><span class="fu">z</span><span class="op">);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li><strong>Implement root finding</strong> (bisection method)</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">intersectImplicit</span><span class="op">(</span><span class="dt">vec3</span> rayOrigin<span class="op">,</span> <span class="dt">vec3</span> rayDir<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> tMin <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> tMax <span class="op">=</span> <span class="fl">10.0</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for sign change</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fMin <span class="op">=</span> <span class="fu">implicitFunction</span><span class="op">(</span>rayOrigin <span class="op">+</span> tMin <span class="op">*</span> rayDir<span class="op">);</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fMax <span class="op">=</span> <span class="fu">implicitFunction</span><span class="op">(</span>rayOrigin <span class="op">+</span> tMax <span class="op">*</span> rayDir<span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>fMin <span class="op">*</span> fMax <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>  <span class="co">// No root</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bisection</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">50</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> tMid <span class="op">=</span> <span class="op">(</span>tMin <span class="op">+</span> tMax<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> fMid <span class="op">=</span> <span class="fu">implicitFunction</span><span class="op">(</span>rayOrigin <span class="op">+</span> tMid <span class="op">*</span> rayDir<span class="op">);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>fMid<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="kw">return</span> tMid<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>fMin <span class="op">*</span> fMid <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            tMax <span class="op">=</span> tMid<span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            fMax <span class="op">=</span> fMid<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            tMin <span class="op">=</span> tMid<span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>            fMin <span class="op">=</span> fMid<span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">(</span>tMin <span class="op">+</span> tMax<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li><strong>Compute normal via gradient</strong></li>
</ol>
<div class="sourceCode" id="cb14"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">implicitNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dx <span class="op">=</span> <span class="fu">implicitFunction</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">implicitFunction</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dy <span class="op">=</span> <span class="fu">implicitFunction</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">implicitFunction</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dz <span class="op">=</span> <span class="fu">implicitFunction</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">implicitFunction</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">));</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>dx<span class="op">,</span> dy<span class="op">,</span> dz<span class="op">));</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li><strong>Optimization: Bounding volume</strong> (optional but recommended)</li>
</ol>
<p>Use a bounding sphere to avoid checking the entire ray:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// First check if ray intersects bounding sphere</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Only compute implicit function if inside bounds</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Expected output:</strong> A rendered algebraic surface with proper lighting showing its geometric features.</p>
<p><strong>Reflection question:</strong> After implementing this, compare the effort to using SDFs. Which approach would you prefer for a complex scene with many objects?</p>
<hr>
</section>
<section id="optional-exercises" class="level3">
<h3 class="anchored" data-anchor-id="optional-exercises">Optional Exercises</h3>
<section id="specular-lighting-phong-model" class="level4">
<h4 class="anchored" data-anchor-id="specular-lighting-phong-model">1. Specular Lighting (Phong Model)</h4>
<p>Add shiny highlights using the Phong reflection model:</p>
<p><span class="math display">\[\text{specular} = (R \cdot V)^n\]</span></p>
<p>where <span class="math inline">\(R\)</span> is reflected light direction, <span class="math inline">\(V\)</span> is view direction, <span class="math inline">\(n\)</span> is shininess.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> R <span class="op">=</span> <span class="bu">reflect</span><span class="op">(-</span>lightDir<span class="op">,</span> normal<span class="op">);</span>  <span class="co">// Reflected light</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> V <span class="op">=</span> <span class="op">-</span>rayDir<span class="op">;</span>                      <span class="co">// View direction</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> spec <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>R<span class="op">,</span> V<span class="op">)),</span> <span class="fl">32.0</span><span class="op">);</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>color <span class="op">+=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> spec <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span>  <span class="co">// White specular highlight</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Try different shininess values (8, 16, 32, 64, 128) to see the effect!</p>
</section>
<section id="camera-movement" class="level4">
<h4 class="anchored" data-anchor-id="camera-movement">2. Camera Movement</h4>
<p>Implement an orbiting camera using time:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> angle <span class="op">=</span> iTime <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> rayOrigin <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">3.0</span> <span class="op">*</span> <span class="bu">cos</span><span class="op">(</span>angle<span class="op">),</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">3.0</span> <span class="op">*</span> <span class="bu">sin</span><span class="op">(</span>angle<span class="op">));</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Look-at matrix</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> target <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> forward <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span>target <span class="op">-</span> rayOrigin<span class="op">);</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> right <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="bu">cross</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">),</span> forward<span class="op">));</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> up <span class="op">=</span> <span class="bu">cross</span><span class="op">(</span>forward<span class="op">,</span> right<span class="op">);</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Transform ray direction</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> rd <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span>uv<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> right <span class="op">+</span> uv<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> up <span class="op">+</span> focalLength <span class="op">*</span> forward<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="complex-sdf-scene" class="level4">
<h4 class="anchored" data-anchor-id="complex-sdf-scene">3. Complex SDF Scene</h4>
<p>Create a scene with 5+ objects using different SDFs from <a href="https://iquilezles.org/articles/distfunctions/">Quilez’s library</a>: - Mix primitives: spheres, boxes, cylinders, tori, cones - Position them creatively - Use different materials - Add interesting lighting</p>
</section>
<section id="soft-shadows-preview-of-day-5" class="level4">
<h4 class="anchored" data-anchor-id="soft-shadows-preview-of-day-5">4. Soft Shadows (Preview of Day 5)</h4>
<p>Cast rays from the surface toward the light to check for occlusion:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">softShadow</span><span class="op">(</span><span class="dt">vec3</span> pos<span class="op">,</span> <span class="dt">vec3</span> lightDir<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span>  <span class="co">// Start slightly above surface</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> shadow <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">50</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>pos <span class="op">+</span> lightDir <span class="op">*</span> t<span class="op">);</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        shadow <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>shadow<span class="op">,</span> <span class="fl">8.0</span> <span class="op">*</span> d <span class="op">/</span> t<span class="op">);</span>  <span class="co">// Penumbra factor</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">10.0</span> <span class="op">||</span> d <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="kw">break</span><span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">clamp</span><span class="op">(</span>shadow<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Apply this to your diffuse lighting for more realistic shadows!</p>
<hr>
</section>
</section>
</section>
<section id="looking-ahead-to-day-5" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="looking-ahead-to-day-5"><span class="header-section-number">4.6</span> Looking Ahead to Day 5</h2>
<p>Tomorrow we’ll explore advanced raymarching techniques that would be nearly impossible with analytical methods:</p>
<ul>
<li><strong>Domain operations</strong>: Infinite repetition, symmetry, twisting</li>
<li><strong>Boolean operations</strong>: Union, intersection, smooth blending</li>
<li><strong>3D fractals</strong>: Menger sponge, Mandelbulb via iterated transformations</li>
<li><strong>Advanced lighting</strong>: Ambient occlusion, global illumination</li>
</ul>
<p>Make sure you’re comfortable with: - The raymarching algorithm (it’s the foundation) - How SDFs compose (taking minimum/maximum) - Normal estimation via gradients - The material tracking pattern we developed</p>
<p>See you tomorrow!</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./day3.html" class="pagination-link" aria-label="Day 3: Geometric Tilings in Euclidean and Hyperbolic Space">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Day 3: Geometric Tilings in Euclidean and Hyperbolic Space</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./day5a.html" class="pagination-link" aria-label="Day 5a">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Day 5a</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb19" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Day 4: Introduction to 3D Rendering</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>Today we enter the third dimension! We'll learn how to cast rays from a camera and test for intersections with 3D objects. We'll start with analytical methods (solving equations directly) for spheres and tori, then transition to raymarching with signed distance functions—a more flexible approach that enables complex procedural scenes.</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>By the end of today, you'll understand:</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to set up a camera and generate rays for each pixel</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Analytical ray-object intersection for simple surfaces</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Why analytical methods become challenging for complex geometry</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Signed distance functions as an alternative representation</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The raymarching algorithm (sphere tracing)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to compose multiple objects and assign materials</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 1: Analytical Ray Tracing</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="fu">### Camera and Ray Setup</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="fu">#### The Rendering Pipeline</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>For each pixel, we need to:</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Generate a ray from the camera through that pixel</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Find where (if anywhere) the ray intersects scene geometry</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Compute color based on surface properties and lighting</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Coordinate System</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>We'll use the standard graphics convention:</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Y-axis** points up</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Z-axis** points toward the camera (out of the screen)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**X-axis** points right</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Right-handed coordinate system</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Pinhole Camera Model</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>Our camera sits at the origin looking down the negative Z-axis. For a pixel at normalized coordinates $(u, v) \in <span class="co">[</span><span class="ot">-1, 1</span><span class="co">]</span>^2$, we generate a ray:</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>**Ray origin:** $\mathbf{o} = (0, 0, 0)$ (camera position)  </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>**Ray direction:** $\mathbf{d} = \text{normalize}(u, v, -f)$</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>where $f$ is the focal length, related to field of view by: $f = 1/\tan(\text{FOV}/2)$.</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Parametric Ray Equation</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>A ray can be written as:</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>$$\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}$$</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>where $t \geq 0$ is the parameter. Points along the ray correspond to different values of $t$.</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>Let's start by visualizing our rays without any intersections:</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>**Shader 1: Ray Visualization**</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="in">    // Normalize pixel coordinates to [-1, 1]</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="in">    // Correct for aspect ratio</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="in">    // Field of view</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="in">    // Ray direction (camera at origin, looking down -Z)</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a><span class="in">    // Color based on ray direction (visualize the rays)</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color = rayDir * 0.5 + 0.5;</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>You should see a colorful gradient showing the direction of each ray. This confirms our camera setup is working!</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ray-Sphere Intersection</span></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a><span class="fu">#### The Sphere Equation</span></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>A sphere of radius $r$ centered at position $\mathbf{c}$ is defined by:</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>$$|\mathbf{p} - \mathbf{c}|^2 = r^2$$</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>All points $\mathbf{p}$ satisfying this equation lie on the sphere's surface.</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Finding the Intersection</span></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>We want to find where our ray $\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}$ intersects the sphere. Substituting the ray equation into the sphere equation:</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>$$|\mathbf{o} + t\mathbf{d} - \mathbf{c}|^2 = r^2$$</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>Let $\mathbf{oc} = \mathbf{o} - \mathbf{c}$ (vector from sphere center to ray origin). Expanding:</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>$$|\mathbf{oc} + t\mathbf{d}|^2 = r^2$$</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>$$|\mathbf{oc}|^2 + 2t(\mathbf{oc} \cdot \mathbf{d}) + t^2|\mathbf{d}|^2 = r^2$$</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>This is a quadratic equation in $t$:</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>$$at^2 + bt + c = 0$$</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$a = |\mathbf{d}|^2$ (equals 1 if direction is normalized)</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$b = 2(\mathbf{oc} \cdot \mathbf{d})$</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$c = |\mathbf{oc}|^2 - r^2$</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>The **discriminant** $\Delta = b^2 - 4ac$ tells us:</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\Delta &lt; 0$: no intersection (ray misses sphere)</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\Delta = 0$: one intersection (ray grazes sphere)</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\Delta &gt; 0$: two intersections (ray enters and exits)</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>We want the smaller positive $t$ (the entry point).</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>**Shader 2: Basic Sphere**</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a><span class="in">float intersectSphere(vec3 rayOrigin, vec3 rayDir, vec3 sphereCenter, float radius) {</span></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 oc = rayOrigin - sphereCenter;</span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a><span class="in">    float a = dot(rayDir, rayDir);  // Should be 1.0 if rayDir is normalized</span></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a><span class="in">    float b = 2.0 * dot(oc, rayDir);</span></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="in">    float c = dot(oc, oc) - radius * radius;</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a><span class="in">    float discriminant = b * b - 4.0 * a * c;</span></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a><span class="in">    if (discriminant &lt; 0.0) {</span></span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a><span class="in">        return -1.0;  // No intersection</span></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a><span class="in">    // Return the closer intersection</span></span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a><span class="in">    float t1 = (-b - sqrt(discriminant)) / (2.0 * a);</span></span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a><span class="in">    float t2 = (-b + sqrt(discriminant)) / (2.0 * a);</span></span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a><span class="in">    // Return closest positive t</span></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t1 &gt; 0.0) return t1;</span></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t2 &gt; 0.0) return t2;</span></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a><span class="in">    return -1.0;  // Both behind camera</span></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a><span class="in">    // Setup ray</span></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayOrigin = vec3(0.0, 0.0, 0.0);</span></span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a><span class="in">    // Sphere parameters</span></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 sphereCenter = vec3(0.0, 0.0, -3.0);</span></span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a><span class="in">    float sphereRadius = 1.0;</span></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a><span class="in">    // Test intersection</span></span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = intersectSphere(rayOrigin, rayDir, sphereCenter, sphereRadius);</span></span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color;</span></span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t &gt; 0.0) {</span></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a><span class="in">        // Hit the sphere</span></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(1.0, 0.0, 0.0);  // Red</span></span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a><span class="in">        // Background</span></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(0.1, 0.1, 0.2);  // Dark blue</span></span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a>You should see a flat red disk! It looks 2D because we don't have lighting yet—we can't see the sphere's curvature.</span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding Lighting</span></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>To see the 3D structure, we need to compute lighting based on the **surface normal**.</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Surface Normal</span></span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a>For a sphere centered at $\mathbf{c}$, the outward normal at surface point $\mathbf{p}$ is:</span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>$$\mathbf{n} = \frac{\mathbf{p} - \mathbf{c}}{r}$$</span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a>This is just the vector from center to surface, normalized.</span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Diffuse Lighting</span></span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>The simplest lighting model: **Lambertian diffuse shading**. Surface brightness depends on the angle between the normal $\mathbf{n}$ and light direction $\mathbf{l}$:</span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>$$\text{brightness} = \max(0, \mathbf{n} \cdot \mathbf{l})$$</span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a>The $\max(0, \cdots)$ ensures surfaces facing away from the light remain dark.</span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a>**Shader 3: Sphere with Lighting**</span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a><span class="in">float intersectSphere(vec3 rayOrigin, vec3 rayDir, vec3 sphereCenter, float radius) {</span></span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 oc = rayOrigin - sphereCenter;</span></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a><span class="in">    float a = dot(rayDir, rayDir);</span></span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a><span class="in">    float b = 2.0 * dot(oc, rayDir);</span></span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a><span class="in">    float c = dot(oc, oc) - radius * radius;</span></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a><span class="in">    float discriminant = b * b - 4.0 * a * c;</span></span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a><span class="in">    if (discriminant &lt; 0.0) return -1.0;</span></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a><span class="in">    float t1 = (-b - sqrt(discriminant)) / (2.0 * a);</span></span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a><span class="in">    float t2 = (-b + sqrt(discriminant)) / (2.0 * a);</span></span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t1 &gt; 0.0) return t1;</span></span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t2 &gt; 0.0) return t2;</span></span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a><span class="in">    return -1.0;</span></span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 sphereNormal(vec3 hitPoint, vec3 sphereCenter, float radius) {</span></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a><span class="in">    return (hitPoint - sphereCenter) / radius;</span></span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a><span class="in">    // Setup ray</span></span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayOrigin = vec3(0.0, 0.0, 0.0);</span></span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a><span class="in">    // Sphere</span></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 sphereCenter = vec3(0.0, 0.0, -3.0);</span></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a><span class="in">    float sphereRadius = 1.0;</span></span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = intersectSphere(rayOrigin, rayDir, sphereCenter, sphereRadius);</span></span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color;</span></span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t &gt; 0.0) {</span></span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a><span class="in">        // Hit point</span></span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 hitPoint = rayOrigin + t * rayDir;</span></span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a><span class="in">        // Surface normal</span></span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 normal = sphereNormal(hitPoint, sphereCenter, sphereRadius);</span></span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a><span class="in">        // Light direction (from above and to the right)</span></span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));</span></span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a><span class="in">        // Diffuse lighting</span></span>
<span id="cb19-251"><a href="#cb19-251" aria-hidden="true" tabindex="-1"></a><span class="in">        float diffuse = max(0.0, dot(normal, lightDir));</span></span>
<span id="cb19-252"><a href="#cb19-252" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a><span class="in">        // Sphere color</span></span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 sphereColor = vec3(1.0, 0.0, 0.0);  // Red</span></span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a><span class="in">        color = sphereColor * diffuse;</span></span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a><span class="in">        // Add ambient light so dark side isn't completely black</span></span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a><span class="in">        color += sphereColor * 0.1;</span></span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(0.1, 0.1, 0.2);</span></span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a>Now the sphere looks 3D! The lighting reveals its curvature. Beautiful!</span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-271"><a href="#cb19-271" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ray-Torus Intersection: Where Analytical Gets Complex</span></span>
<span id="cb19-272"><a href="#cb19-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a><span class="fu">#### The Torus Equation</span></span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a>A torus with major radius $R$ (distance from center to tube center) and minor radius $r$ (tube thickness) has the implicit equation:</span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a>$$\left(\sqrt{x^2 + z^2} - R\right)^2 + y^2 = r^2$$</span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a>Or in vector form:</span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a>$$\left(|\mathbf{p}_{xz}| - R\right)^2 + p_y^2 = r^2$$</span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a>where $\mathbf{p}_{xz} = (p_x, p_z)$ is the projection onto the XZ-plane.</span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a><span class="fu">#### The Challenge</span></span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a>Substituting our ray equation into this gives a **quartic polynomial** (degree 4):</span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a>$$at^4 + bt^3 + ct^2 + dt + e = 0$$</span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a>Unlike quadratics (which have a simple formula), quartic equations require sophisticated algebraic methods. Here's what solving it actually looks like:</span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a>**Shader 4: Analytical Torus**</span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a><span class="in">// From Inigo Quilez - https://www.shadertoy.com/view/XdSGWy</span></span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a><span class="in">// Analytical quartic solver for torus intersection</span></span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a><span class="in">float intersectTorus(vec3 ro, vec3 rd, vec2 tor)</span></span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a><span class="in">    float po = 1.0;</span></span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a><span class="in">    float Ra2 = tor.x * tor.x;</span></span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a><span class="in">    float ra2 = tor.y * tor.y;</span></span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a><span class="in">    float m = dot(ro, ro);</span></span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a><span class="in">    float n = dot(ro, rd);</span></span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a><span class="in">    // Bounding sphere check</span></span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a><span class="in">    float h = n*n - m + (tor.x + tor.y) * (tor.x + tor.y);</span></span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a><span class="in">    if(h &lt; 0.0) return -1.0;</span></span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a><span class="in">    // Find quartic coefficients</span></span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a><span class="in">    float k = (m - ra2 - Ra2) / 2.0;</span></span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a><span class="in">    float k3 = n;</span></span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a><span class="in">    float k2 = n*n + Ra2*rd.z*rd.z + k;</span></span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a><span class="in">    float k1 = k*n + Ra2*ro.z*rd.z;</span></span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a><span class="in">    float k0 = k*k + Ra2*ro.z*ro.z - Ra2*ra2;</span></span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-314"><a href="#cb19-314" aria-hidden="true" tabindex="-1"></a><span class="in">    // Prevent numerical issues</span></span>
<span id="cb19-315"><a href="#cb19-315" aria-hidden="true" tabindex="-1"></a><span class="in">    if(abs(k3*(k3*k3 - k2) + k1) &lt; 0.01)</span></span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a><span class="in">        po = -1.0;</span></span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a><span class="in">        float tmp = k1; k1 = k3; k3 = tmp;</span></span>
<span id="cb19-319"><a href="#cb19-319" aria-hidden="true" tabindex="-1"></a><span class="in">        k0 = 1.0/k0;</span></span>
<span id="cb19-320"><a href="#cb19-320" aria-hidden="true" tabindex="-1"></a><span class="in">        k1 = k1*k0;</span></span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a><span class="in">        k2 = k2*k0;</span></span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a><span class="in">        k3 = k3*k0;</span></span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a><span class="in">    float c2 = 2.0*k2 - 3.0*k3*k3;</span></span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a><span class="in">    float c1 = k3*(k3*k3 - k2) + k1;</span></span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a><span class="in">    float c0 = k3*(k3*(-3.0*k3*k3 + 4.0*k2) - 8.0*k1) + 4.0*k0;</span></span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a><span class="in">    c2 /= 3.0;</span></span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a><span class="in">    c1 *= 2.0;</span></span>
<span id="cb19-331"><a href="#cb19-331" aria-hidden="true" tabindex="-1"></a><span class="in">    c0 /= 3.0;</span></span>
<span id="cb19-332"><a href="#cb19-332" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-333"><a href="#cb19-333" aria-hidden="true" tabindex="-1"></a><span class="in">    float Q = c2*c2 + c0;</span></span>
<span id="cb19-334"><a href="#cb19-334" aria-hidden="true" tabindex="-1"></a><span class="in">    float R = 3.0*c0*c2 - c2*c2*c2 - c1*c1;</span></span>
<span id="cb19-335"><a href="#cb19-335" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-336"><a href="#cb19-336" aria-hidden="true" tabindex="-1"></a><span class="in">    float h2 = R*R - Q*Q*Q;</span></span>
<span id="cb19-337"><a href="#cb19-337" aria-hidden="true" tabindex="-1"></a><span class="in">    float z = 0.0;</span></span>
<span id="cb19-338"><a href="#cb19-338" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-339"><a href="#cb19-339" aria-hidden="true" tabindex="-1"></a><span class="in">    if(h2 &lt; 0.0)</span></span>
<span id="cb19-340"><a href="#cb19-340" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-341"><a href="#cb19-341" aria-hidden="true" tabindex="-1"></a><span class="in">        // 4 intersections</span></span>
<span id="cb19-342"><a href="#cb19-342" aria-hidden="true" tabindex="-1"></a><span class="in">        float sQ = sqrt(Q);</span></span>
<span id="cb19-343"><a href="#cb19-343" aria-hidden="true" tabindex="-1"></a><span class="in">        z = 2.0*sQ*cos(acos(R/(sQ*Q)) / 3.0);</span></span>
<span id="cb19-344"><a href="#cb19-344" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-345"><a href="#cb19-345" aria-hidden="true" tabindex="-1"></a><span class="in">    else</span></span>
<span id="cb19-346"><a href="#cb19-346" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-347"><a href="#cb19-347" aria-hidden="true" tabindex="-1"></a><span class="in">        // 2 intersections</span></span>
<span id="cb19-348"><a href="#cb19-348" aria-hidden="true" tabindex="-1"></a><span class="in">        float sQ = pow(sqrt(h2) + abs(R), 1.0/3.0);</span></span>
<span id="cb19-349"><a href="#cb19-349" aria-hidden="true" tabindex="-1"></a><span class="in">        z = sign(R)*abs(sQ + Q/sQ);</span></span>
<span id="cb19-350"><a href="#cb19-350" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-351"><a href="#cb19-351" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-352"><a href="#cb19-352" aria-hidden="true" tabindex="-1"></a><span class="in">    z = c2 - z;</span></span>
<span id="cb19-353"><a href="#cb19-353" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-354"><a href="#cb19-354" aria-hidden="true" tabindex="-1"></a><span class="in">    float d1 = z - 3.0*c2;</span></span>
<span id="cb19-355"><a href="#cb19-355" aria-hidden="true" tabindex="-1"></a><span class="in">    float d2 = z*z - 3.0*c0;</span></span>
<span id="cb19-356"><a href="#cb19-356" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-357"><a href="#cb19-357" aria-hidden="true" tabindex="-1"></a><span class="in">    if(abs(d1) &lt; 1.0e-4)</span></span>
<span id="cb19-358"><a href="#cb19-358" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-359"><a href="#cb19-359" aria-hidden="true" tabindex="-1"></a><span class="in">        if(d2 &lt; 0.0) return -1.0;</span></span>
<span id="cb19-360"><a href="#cb19-360" aria-hidden="true" tabindex="-1"></a><span class="in">        d2 = sqrt(d2);</span></span>
<span id="cb19-361"><a href="#cb19-361" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-362"><a href="#cb19-362" aria-hidden="true" tabindex="-1"></a><span class="in">    else</span></span>
<span id="cb19-363"><a href="#cb19-363" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-364"><a href="#cb19-364" aria-hidden="true" tabindex="-1"></a><span class="in">        if(d1 &lt; 0.0) return -1.0;</span></span>
<span id="cb19-365"><a href="#cb19-365" aria-hidden="true" tabindex="-1"></a><span class="in">        d1 = sqrt(d1/2.0);</span></span>
<span id="cb19-366"><a href="#cb19-366" aria-hidden="true" tabindex="-1"></a><span class="in">        d2 = c1/d1;</span></span>
<span id="cb19-367"><a href="#cb19-367" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-368"><a href="#cb19-368" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-369"><a href="#cb19-369" aria-hidden="true" tabindex="-1"></a><span class="in">    float result = 1e20;</span></span>
<span id="cb19-370"><a href="#cb19-370" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-371"><a href="#cb19-371" aria-hidden="true" tabindex="-1"></a><span class="in">    h2 = d1*d1 - z + d2;</span></span>
<span id="cb19-372"><a href="#cb19-372" aria-hidden="true" tabindex="-1"></a><span class="in">    if(h2 &gt; 0.0)</span></span>
<span id="cb19-373"><a href="#cb19-373" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-374"><a href="#cb19-374" aria-hidden="true" tabindex="-1"></a><span class="in">        h2 = sqrt(h2);</span></span>
<span id="cb19-375"><a href="#cb19-375" aria-hidden="true" tabindex="-1"></a><span class="in">        float t1 = -d1 - h2 - k3;</span></span>
<span id="cb19-376"><a href="#cb19-376" aria-hidden="true" tabindex="-1"></a><span class="in">        float t2 = -d1 + h2 - k3;</span></span>
<span id="cb19-377"><a href="#cb19-377" aria-hidden="true" tabindex="-1"></a><span class="in">        t1 = (po &lt; 0.0) ? 2.0/t1 : t1;</span></span>
<span id="cb19-378"><a href="#cb19-378" aria-hidden="true" tabindex="-1"></a><span class="in">        t2 = (po &lt; 0.0) ? 2.0/t2 : t2;</span></span>
<span id="cb19-379"><a href="#cb19-379" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t1 &gt; 0.0) result = t1;</span></span>
<span id="cb19-380"><a href="#cb19-380" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t2 &gt; 0.0) result = min(result, t2);</span></span>
<span id="cb19-381"><a href="#cb19-381" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-382"><a href="#cb19-382" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-383"><a href="#cb19-383" aria-hidden="true" tabindex="-1"></a><span class="in">    h2 = d1*d1 - z - d2;</span></span>
<span id="cb19-384"><a href="#cb19-384" aria-hidden="true" tabindex="-1"></a><span class="in">    if(h2 &gt; 0.0)</span></span>
<span id="cb19-385"><a href="#cb19-385" aria-hidden="true" tabindex="-1"></a><span class="in">    {</span></span>
<span id="cb19-386"><a href="#cb19-386" aria-hidden="true" tabindex="-1"></a><span class="in">        h2 = sqrt(h2);</span></span>
<span id="cb19-387"><a href="#cb19-387" aria-hidden="true" tabindex="-1"></a><span class="in">        float t1 = d1 - h2 - k3;</span></span>
<span id="cb19-388"><a href="#cb19-388" aria-hidden="true" tabindex="-1"></a><span class="in">        float t2 = d1 + h2 - k3;</span></span>
<span id="cb19-389"><a href="#cb19-389" aria-hidden="true" tabindex="-1"></a><span class="in">        t1 = (po &lt; 0.0) ? 2.0/t1 : t1;</span></span>
<span id="cb19-390"><a href="#cb19-390" aria-hidden="true" tabindex="-1"></a><span class="in">        t2 = (po &lt; 0.0) ? 2.0/t2 : t2;</span></span>
<span id="cb19-391"><a href="#cb19-391" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t1 &gt; 0.0) result = min(result, t1);</span></span>
<span id="cb19-392"><a href="#cb19-392" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t2 &gt; 0.0) result = min(result, t2);</span></span>
<span id="cb19-393"><a href="#cb19-393" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-394"><a href="#cb19-394" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-395"><a href="#cb19-395" aria-hidden="true" tabindex="-1"></a><span class="in">    return result;</span></span>
<span id="cb19-396"><a href="#cb19-396" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-397"><a href="#cb19-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-398"><a href="#cb19-398" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 torusNormal(vec3 pos, vec2 tor)</span></span>
<span id="cb19-399"><a href="#cb19-399" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-400"><a href="#cb19-400" aria-hidden="true" tabindex="-1"></a><span class="in">    return normalize(pos * (dot(pos,pos) - tor.y*tor.y - tor.x*tor.x*vec3(1.0,1.0,-1.0)));</span></span>
<span id="cb19-401"><a href="#cb19-401" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-402"><a href="#cb19-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-403"><a href="#cb19-403" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-404"><a href="#cb19-404" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-405"><a href="#cb19-405" aria-hidden="true" tabindex="-1"></a><span class="in">    // Setup ray</span></span>
<span id="cb19-406"><a href="#cb19-406" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-407"><a href="#cb19-407" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-408"><a href="#cb19-408" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-409"><a href="#cb19-409" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-410"><a href="#cb19-410" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-411"><a href="#cb19-411" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-412"><a href="#cb19-412" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayOrigin = vec3(0.0, 0.0, 0.0);</span></span>
<span id="cb19-413"><a href="#cb19-413" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-414"><a href="#cb19-414" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-415"><a href="#cb19-415" aria-hidden="true" tabindex="-1"></a><span class="in">    // Torus parameters</span></span>
<span id="cb19-416"><a href="#cb19-416" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 torus = vec2(1.0, 0.4);  // (major radius, minor radius)</span></span>
<span id="cb19-417"><a href="#cb19-417" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 torusCenter = vec3(0.0, 0.0, -3.5);</span></span>
<span id="cb19-418"><a href="#cb19-418" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-419"><a href="#cb19-419" aria-hidden="true" tabindex="-1"></a><span class="in">    // Adjust ray for torus position</span></span>
<span id="cb19-420"><a href="#cb19-420" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 ro = rayOrigin - torusCenter;</span></span>
<span id="cb19-421"><a href="#cb19-421" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-422"><a href="#cb19-422" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = intersectTorus(ro, rayDir, torus);</span></span>
<span id="cb19-423"><a href="#cb19-423" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-424"><a href="#cb19-424" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color;</span></span>
<span id="cb19-425"><a href="#cb19-425" aria-hidden="true" tabindex="-1"></a><span class="in">    if (t &gt; 0.0) {</span></span>
<span id="cb19-426"><a href="#cb19-426" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 hitPoint = ro + t * rayDir;</span></span>
<span id="cb19-427"><a href="#cb19-427" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 normal = torusNormal(hitPoint, torus);</span></span>
<span id="cb19-428"><a href="#cb19-428" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-429"><a href="#cb19-429" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));</span></span>
<span id="cb19-430"><a href="#cb19-430" aria-hidden="true" tabindex="-1"></a><span class="in">        float diffuse = max(0.0, dot(normal, lightDir));</span></span>
<span id="cb19-431"><a href="#cb19-431" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-432"><a href="#cb19-432" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 torusColor = vec3(0.0, 0.7, 1.0);  // Cyan</span></span>
<span id="cb19-433"><a href="#cb19-433" aria-hidden="true" tabindex="-1"></a><span class="in">        color = torusColor * diffuse + torusColor * 0.1;</span></span>
<span id="cb19-434"><a href="#cb19-434" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb19-435"><a href="#cb19-435" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(0.1, 0.1, 0.2);</span></span>
<span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-441"><a href="#cb19-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-442"><a href="#cb19-442" aria-hidden="true" tabindex="-1"></a>Look at that intersection code! Over 80 lines of complex algebra just to render one torus. And this is still a relatively simple surface—imagine arbitrary algebraic varieties, or trying to combine multiple objects with boolean operations.</span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a>Analytical methods work beautifully for simple geometry, but we need a more flexible approach for complex scenes.</span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 2: Signed Distance Functions and Raymarching</span></span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a><span class="fu">### Introduction to SDFs</span></span>
<span id="cb19-451"><a href="#cb19-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-452"><a href="#cb19-452" aria-hidden="true" tabindex="-1"></a>A **signed distance function** (SDF) gives the distance from any point in space to the nearest surface:</span>
<span id="cb19-453"><a href="#cb19-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-454"><a href="#cb19-454" aria-hidden="true" tabindex="-1"></a>$$d(\mathbf{p}) = \begin{cases}</span>
<span id="cb19-455"><a href="#cb19-455" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 0 &amp; \text{outside surface} </span><span class="sc">\\</span></span>
<span id="cb19-456"><a href="#cb19-456" aria-hidden="true" tabindex="-1"></a><span class="at">= 0 &amp; \text{on surface} </span><span class="sc">\\</span></span>
<span id="cb19-457"><a href="#cb19-457" aria-hidden="true" tabindex="-1"></a><span class="at">&lt; 0 &amp; \text{inside surface}</span></span>
<span id="cb19-458"><a href="#cb19-458" aria-hidden="true" tabindex="-1"></a><span class="at">\end{cases}$$</span></span>
<span id="cb19-459"><a href="#cb19-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-460"><a href="#cb19-460" aria-hidden="true" tabindex="-1"></a>Crucially, $|d(\mathbf{p})|$ is the actual Euclidean distance to the surface.</span>
<span id="cb19-461"><a href="#cb19-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-462"><a href="#cb19-462" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Why SDFs?</span></span>
<span id="cb19-463"><a href="#cb19-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-464"><a href="#cb19-464" aria-hidden="true" tabindex="-1"></a>SDFs have a powerful property: if we're at point $\mathbf{p}$ and the surface is distance $d$ away, we can safely move $d$ units in *any* direction without hitting anything. This enables **sphere tracing**—we march along the ray taking steps proportional to the SDF value.</span>
<span id="cb19-465"><a href="#cb19-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-466"><a href="#cb19-466" aria-hidden="true" tabindex="-1"></a><span class="fu">#### SDF Examples</span></span>
<span id="cb19-467"><a href="#cb19-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-468"><a href="#cb19-468" aria-hidden="true" tabindex="-1"></a>Let's see SDFs for shapes we've already rendered analytically:</span>
<span id="cb19-469"><a href="#cb19-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-470"><a href="#cb19-470" aria-hidden="true" tabindex="-1"></a>**Sphere:**</span>
<span id="cb19-471"><a href="#cb19-471" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-472"><a href="#cb19-472" aria-hidden="true" tabindex="-1"></a><span class="in">float sdSphere(vec3 p, vec3 center, float radius) {</span></span>
<span id="cb19-473"><a href="#cb19-473" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(p - center) - radius;</span></span>
<span id="cb19-474"><a href="#cb19-474" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-475"><a href="#cb19-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-476"><a href="#cb19-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-477"><a href="#cb19-477" aria-hidden="true" tabindex="-1"></a>Compare this to our 30+ line analytical intersection! Much simpler.</span>
<span id="cb19-478"><a href="#cb19-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-479"><a href="#cb19-479" aria-hidden="true" tabindex="-1"></a>**Torus:**</span>
<span id="cb19-480"><a href="#cb19-480" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-481"><a href="#cb19-481" aria-hidden="true" tabindex="-1"></a><span class="in">float sdTorus(vec3 p, vec3 center, float majorRadius, float minorRadius) {</span></span>
<span id="cb19-482"><a href="#cb19-482" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 q = p - center;</span></span>
<span id="cb19-483"><a href="#cb19-483" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 pxz = vec2(q.x, q.z);</span></span>
<span id="cb19-484"><a href="#cb19-484" aria-hidden="true" tabindex="-1"></a><span class="in">    float d = length(pxz) - majorRadius;</span></span>
<span id="cb19-485"><a href="#cb19-485" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(vec2(d, q.y)) - minorRadius;</span></span>
<span id="cb19-486"><a href="#cb19-486" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-487"><a href="#cb19-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-488"><a href="#cb19-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-489"><a href="#cb19-489" aria-hidden="true" tabindex="-1"></a>Again, dramatically simpler than the quartic solver!</span>
<span id="cb19-490"><a href="#cb19-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-491"><a href="#cb19-491" aria-hidden="true" tabindex="-1"></a>**Other Primitives**</span>
<span id="cb19-492"><a href="#cb19-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-493"><a href="#cb19-493" aria-hidden="true" tabindex="-1"></a>Many more SDFs exist: boxes, cylinders, capsules, cones, pyramids, etc. See <span class="co">[</span><span class="ot">Inigo Quilez's comprehensive library</span><span class="co">](https://iquilezles.org/articles/distfunctions/)</span> for a complete reference. Each SDF is typically just a few lines of code.</span>
<span id="cb19-494"><a href="#cb19-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-495"><a href="#cb19-495" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-496"><a href="#cb19-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-497"><a href="#cb19-497" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Raymarching Algorithm</span></span>
<span id="cb19-498"><a href="#cb19-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-499"><a href="#cb19-499" aria-hidden="true" tabindex="-1"></a>**Sphere tracing** works like this:</span>
<span id="cb19-500"><a href="#cb19-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-501"><a href="#cb19-501" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Start at the ray origin</span>
<span id="cb19-502"><a href="#cb19-502" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Evaluate the SDF at current position</span>
<span id="cb19-503"><a href="#cb19-503" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>March forward along the ray by that distance (safe step!)</span>
<span id="cb19-504"><a href="#cb19-504" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Repeat until:</span>
<span id="cb19-505"><a href="#cb19-505" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Very close to surface (SDF ≈ 0) → hit!</span>
<span id="cb19-506"><a href="#cb19-506" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Too far away → miss</span>
<span id="cb19-507"><a href="#cb19-507" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Too many steps → give up</span>
<span id="cb19-508"><a href="#cb19-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-509"><a href="#cb19-509" aria-hidden="true" tabindex="-1"></a>Here's the algorithm:</span>
<span id="cb19-510"><a href="#cb19-510" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-511"><a href="#cb19-511" aria-hidden="true" tabindex="-1"></a><span class="in">float sceneSDF(vec3 p) {</span></span>
<span id="cb19-512"><a href="#cb19-512" aria-hidden="true" tabindex="-1"></a><span class="in">    // Define scene geometry (we'll implement this)</span></span>
<span id="cb19-513"><a href="#cb19-513" aria-hidden="true" tabindex="-1"></a><span class="in">    return 0.0;</span></span>
<span id="cb19-514"><a href="#cb19-514" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-515"><a href="#cb19-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-516"><a href="#cb19-516" aria-hidden="true" tabindex="-1"></a><span class="in">bool raymarch(vec3 rayOrigin, vec3 rayDir, out float hitDist, out vec3 hitPos) {</span></span>
<span id="cb19-517"><a href="#cb19-517" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = 0.0;</span></span>
<span id="cb19-518"><a href="#cb19-518" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-519"><a href="#cb19-519" aria-hidden="true" tabindex="-1"></a><span class="in">    for(int i = 0; i &lt; 100; i++) {</span></span>
<span id="cb19-520"><a href="#cb19-520" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 pos = rayOrigin + t * rayDir;</span></span>
<span id="cb19-521"><a href="#cb19-521" aria-hidden="true" tabindex="-1"></a><span class="in">        float d = sceneSDF(pos);</span></span>
<span id="cb19-522"><a href="#cb19-522" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-523"><a href="#cb19-523" aria-hidden="true" tabindex="-1"></a><span class="in">        // Close enough to surface?</span></span>
<span id="cb19-524"><a href="#cb19-524" aria-hidden="true" tabindex="-1"></a><span class="in">        if(abs(d) &lt; 0.001) {</span></span>
<span id="cb19-525"><a href="#cb19-525" aria-hidden="true" tabindex="-1"></a><span class="in">            hitDist = t;</span></span>
<span id="cb19-526"><a href="#cb19-526" aria-hidden="true" tabindex="-1"></a><span class="in">            hitPos = pos;</span></span>
<span id="cb19-527"><a href="#cb19-527" aria-hidden="true" tabindex="-1"></a><span class="in">            return true;</span></span>
<span id="cb19-528"><a href="#cb19-528" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb19-529"><a href="#cb19-529" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-530"><a href="#cb19-530" aria-hidden="true" tabindex="-1"></a><span class="in">        // March forward</span></span>
<span id="cb19-531"><a href="#cb19-531" aria-hidden="true" tabindex="-1"></a><span class="in">        t += d;</span></span>
<span id="cb19-532"><a href="#cb19-532" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-533"><a href="#cb19-533" aria-hidden="true" tabindex="-1"></a><span class="in">        // Too far?</span></span>
<span id="cb19-534"><a href="#cb19-534" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t &gt; 100.0) {</span></span>
<span id="cb19-535"><a href="#cb19-535" aria-hidden="true" tabindex="-1"></a><span class="in">            return false;</span></span>
<span id="cb19-536"><a href="#cb19-536" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb19-537"><a href="#cb19-537" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-538"><a href="#cb19-538" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-539"><a href="#cb19-539" aria-hidden="true" tabindex="-1"></a><span class="in">    return false;</span></span>
<span id="cb19-540"><a href="#cb19-540" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-541"><a href="#cb19-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-542"><a href="#cb19-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-543"><a href="#cb19-543" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Normal Estimation via Gradient</span></span>
<span id="cb19-544"><a href="#cb19-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-545"><a href="#cb19-545" aria-hidden="true" tabindex="-1"></a>For an SDF $d(\mathbf{p})$, the gradient $\nabla d$ points perpendicular to the surface (it's the normal direction). We estimate it using finite differences:</span>
<span id="cb19-546"><a href="#cb19-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-547"><a href="#cb19-547" aria-hidden="true" tabindex="-1"></a>$$\frac{\partial d}{\partial x} \approx \frac{d(x + \epsilon, y, z) - d(x - \epsilon, y, z)}{2\epsilon}$$</span>
<span id="cb19-548"><a href="#cb19-548" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-549"><a href="#cb19-549" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 estimateNormal(vec3 p) {</span></span>
<span id="cb19-550"><a href="#cb19-550" aria-hidden="true" tabindex="-1"></a><span class="in">    float eps = 0.001;</span></span>
<span id="cb19-551"><a href="#cb19-551" aria-hidden="true" tabindex="-1"></a><span class="in">    float dx = sceneSDF(p + vec3(eps, 0, 0)) - sceneSDF(p - vec3(eps, 0, 0));</span></span>
<span id="cb19-552"><a href="#cb19-552" aria-hidden="true" tabindex="-1"></a><span class="in">    float dy = sceneSDF(p + vec3(0, eps, 0)) - sceneSDF(p - vec3(0, eps, 0));</span></span>
<span id="cb19-553"><a href="#cb19-553" aria-hidden="true" tabindex="-1"></a><span class="in">    float dz = sceneSDF(p + vec3(0, 0, eps)) - sceneSDF(p - vec3(0, 0, eps));</span></span>
<span id="cb19-554"><a href="#cb19-554" aria-hidden="true" tabindex="-1"></a><span class="in">    return normalize(vec3(dx, dy, dz));</span></span>
<span id="cb19-555"><a href="#cb19-555" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-556"><a href="#cb19-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-557"><a href="#cb19-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-558"><a href="#cb19-558" aria-hidden="true" tabindex="-1"></a><span class="fu">#### First Raymarch Shader</span></span>
<span id="cb19-559"><a href="#cb19-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-560"><a href="#cb19-560" aria-hidden="true" tabindex="-1"></a>**Shader 5: Single Sphere with Raymarching**</span>
<span id="cb19-561"><a href="#cb19-561" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-562"><a href="#cb19-562" aria-hidden="true" tabindex="-1"></a><span class="in">float sdSphere(vec3 p, vec3 center, float radius) {</span></span>
<span id="cb19-563"><a href="#cb19-563" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(p - center) - radius;</span></span>
<span id="cb19-564"><a href="#cb19-564" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-565"><a href="#cb19-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-566"><a href="#cb19-566" aria-hidden="true" tabindex="-1"></a><span class="in">float sceneSDF(vec3 p) {</span></span>
<span id="cb19-567"><a href="#cb19-567" aria-hidden="true" tabindex="-1"></a><span class="in">    return sdSphere(p, vec3(0.0, 0.0, -3.0), 1.0);</span></span>
<span id="cb19-568"><a href="#cb19-568" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-569"><a href="#cb19-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-570"><a href="#cb19-570" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 estimateNormal(vec3 p) {</span></span>
<span id="cb19-571"><a href="#cb19-571" aria-hidden="true" tabindex="-1"></a><span class="in">    float eps = 0.001;</span></span>
<span id="cb19-572"><a href="#cb19-572" aria-hidden="true" tabindex="-1"></a><span class="in">    float dx = sceneSDF(p + vec3(eps, 0, 0)) - sceneSDF(p - vec3(eps, 0, 0));</span></span>
<span id="cb19-573"><a href="#cb19-573" aria-hidden="true" tabindex="-1"></a><span class="in">    float dy = sceneSDF(p + vec3(0, eps, 0)) - sceneSDF(p - vec3(0, eps, 0));</span></span>
<span id="cb19-574"><a href="#cb19-574" aria-hidden="true" tabindex="-1"></a><span class="in">    float dz = sceneSDF(p + vec3(0, 0, eps)) - sceneSDF(p - vec3(0, 0, eps));</span></span>
<span id="cb19-575"><a href="#cb19-575" aria-hidden="true" tabindex="-1"></a><span class="in">    return normalize(vec3(dx, dy, dz));</span></span>
<span id="cb19-576"><a href="#cb19-576" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-577"><a href="#cb19-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-578"><a href="#cb19-578" aria-hidden="true" tabindex="-1"></a><span class="in">bool raymarch(vec3 rayOrigin, vec3 rayDir, out vec3 hitPos) {</span></span>
<span id="cb19-579"><a href="#cb19-579" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = 0.0;</span></span>
<span id="cb19-580"><a href="#cb19-580" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-581"><a href="#cb19-581" aria-hidden="true" tabindex="-1"></a><span class="in">    for(int i = 0; i &lt; 100; i++) {</span></span>
<span id="cb19-582"><a href="#cb19-582" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 pos = rayOrigin + t * rayDir;</span></span>
<span id="cb19-583"><a href="#cb19-583" aria-hidden="true" tabindex="-1"></a><span class="in">        float d = sceneSDF(pos);</span></span>
<span id="cb19-584"><a href="#cb19-584" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-585"><a href="#cb19-585" aria-hidden="true" tabindex="-1"></a><span class="in">        if(abs(d) &lt; 0.001) {</span></span>
<span id="cb19-586"><a href="#cb19-586" aria-hidden="true" tabindex="-1"></a><span class="in">            hitPos = pos;</span></span>
<span id="cb19-587"><a href="#cb19-587" aria-hidden="true" tabindex="-1"></a><span class="in">            return true;</span></span>
<span id="cb19-588"><a href="#cb19-588" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb19-589"><a href="#cb19-589" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-590"><a href="#cb19-590" aria-hidden="true" tabindex="-1"></a><span class="in">        t += d;</span></span>
<span id="cb19-591"><a href="#cb19-591" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-592"><a href="#cb19-592" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t &gt; 100.0) return false;</span></span>
<span id="cb19-593"><a href="#cb19-593" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-594"><a href="#cb19-594" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-595"><a href="#cb19-595" aria-hidden="true" tabindex="-1"></a><span class="in">    return false;</span></span>
<span id="cb19-596"><a href="#cb19-596" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-597"><a href="#cb19-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-598"><a href="#cb19-598" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-599"><a href="#cb19-599" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-600"><a href="#cb19-600" aria-hidden="true" tabindex="-1"></a><span class="in">    // Setup ray</span></span>
<span id="cb19-601"><a href="#cb19-601" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-602"><a href="#cb19-602" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-603"><a href="#cb19-603" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-604"><a href="#cb19-604" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-605"><a href="#cb19-605" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-606"><a href="#cb19-606" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-607"><a href="#cb19-607" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayOrigin = vec3(0.0, 0.0, 0.0);</span></span>
<span id="cb19-608"><a href="#cb19-608" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-609"><a href="#cb19-609" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-610"><a href="#cb19-610" aria-hidden="true" tabindex="-1"></a><span class="in">    // Raymarch</span></span>
<span id="cb19-611"><a href="#cb19-611" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 hitPos;</span></span>
<span id="cb19-612"><a href="#cb19-612" aria-hidden="true" tabindex="-1"></a><span class="in">    bool hit = raymarch(rayOrigin, rayDir, hitPos);</span></span>
<span id="cb19-613"><a href="#cb19-613" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-614"><a href="#cb19-614" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color;</span></span>
<span id="cb19-615"><a href="#cb19-615" aria-hidden="true" tabindex="-1"></a><span class="in">    if(hit) {</span></span>
<span id="cb19-616"><a href="#cb19-616" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 normal = estimateNormal(hitPos);</span></span>
<span id="cb19-617"><a href="#cb19-617" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));</span></span>
<span id="cb19-618"><a href="#cb19-618" aria-hidden="true" tabindex="-1"></a><span class="in">        float diffuse = max(0.0, dot(normal, lightDir));</span></span>
<span id="cb19-619"><a href="#cb19-619" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-620"><a href="#cb19-620" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 sphereColor = vec3(1.0, 0.0, 0.0);</span></span>
<span id="cb19-621"><a href="#cb19-621" aria-hidden="true" tabindex="-1"></a><span class="in">        color = sphereColor * diffuse + sphereColor * 0.1;</span></span>
<span id="cb19-622"><a href="#cb19-622" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb19-623"><a href="#cb19-623" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(0.1, 0.1, 0.2);</span></span>
<span id="cb19-624"><a href="#cb19-624" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-625"><a href="#cb19-625" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-626"><a href="#cb19-626" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-627"><a href="#cb19-627" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-628"><a href="#cb19-628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-629"><a href="#cb19-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-630"><a href="#cb19-630" aria-hidden="true" tabindex="-1"></a>Same result as the analytical sphere, but now we have a flexible framework!</span>
<span id="cb19-631"><a href="#cb19-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-632"><a href="#cb19-632" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-633"><a href="#cb19-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-634"><a href="#cb19-634" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Power of SDFs: Instant Shape Swapping</span></span>
<span id="cb19-635"><a href="#cb19-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-636"><a href="#cb19-636" aria-hidden="true" tabindex="-1"></a>Here's where SDFs shine: **changing shapes is trivial**. Just swap out one SDF for another!</span>
<span id="cb19-637"><a href="#cb19-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-638"><a href="#cb19-638" aria-hidden="true" tabindex="-1"></a>**Shader 6: Shapeshifting**</span>
<span id="cb19-639"><a href="#cb19-639" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-640"><a href="#cb19-640" aria-hidden="true" tabindex="-1"></a><span class="in">float sdSphere(vec3 p, vec3 center, float radius) {</span></span>
<span id="cb19-641"><a href="#cb19-641" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(p - center) - radius;</span></span>
<span id="cb19-642"><a href="#cb19-642" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-643"><a href="#cb19-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-644"><a href="#cb19-644" aria-hidden="true" tabindex="-1"></a><span class="in">float sdTorus(vec3 p, vec3 center, float majorRadius, float minorRadius) {</span></span>
<span id="cb19-645"><a href="#cb19-645" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 q = p - center;</span></span>
<span id="cb19-646"><a href="#cb19-646" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 pxz = vec2(q.x, q.z);</span></span>
<span id="cb19-647"><a href="#cb19-647" aria-hidden="true" tabindex="-1"></a><span class="in">    float d = length(pxz) - majorRadius;</span></span>
<span id="cb19-648"><a href="#cb19-648" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(vec2(d, q.y)) - minorRadius;</span></span>
<span id="cb19-649"><a href="#cb19-649" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-650"><a href="#cb19-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-651"><a href="#cb19-651" aria-hidden="true" tabindex="-1"></a><span class="in">float sdBox(vec3 p, vec3 center, vec3 halfExtents) {</span></span>
<span id="cb19-652"><a href="#cb19-652" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 q = abs(p - center) - halfExtents;</span></span>
<span id="cb19-653"><a href="#cb19-653" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0);</span></span>
<span id="cb19-654"><a href="#cb19-654" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-655"><a href="#cb19-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-656"><a href="#cb19-656" aria-hidden="true" tabindex="-1"></a><span class="in">float sceneSDF(vec3 p) {</span></span>
<span id="cb19-657"><a href="#cb19-657" aria-hidden="true" tabindex="-1"></a><span class="in">    // Uncomment ONE of these to see different shapes!</span></span>
<span id="cb19-658"><a href="#cb19-658" aria-hidden="true" tabindex="-1"></a><span class="in">    // Everything else stays the same - same raymarch, same lighting, same normal calculation</span></span>
<span id="cb19-659"><a href="#cb19-659" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-660"><a href="#cb19-660" aria-hidden="true" tabindex="-1"></a><span class="in">    return sdSphere(p, vec3(0.0, 0.0, -3.0), 1.0);</span></span>
<span id="cb19-661"><a href="#cb19-661" aria-hidden="true" tabindex="-1"></a><span class="in">    //return sdTorus(p, vec3(0.0, 0.0, -3.0), 1.0, 0.4);</span></span>
<span id="cb19-662"><a href="#cb19-662" aria-hidden="true" tabindex="-1"></a><span class="in">    //return sdBox(p, vec3(0.0, 0.0, -3.0), vec3(0.8, 0.8, 0.8));</span></span>
<span id="cb19-663"><a href="#cb19-663" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-664"><a href="#cb19-664" aria-hidden="true" tabindex="-1"></a><span class="in">    // Try any SDF from https://iquilezles.org/articles/distfunctions/</span></span>
<span id="cb19-665"><a href="#cb19-665" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-666"><a href="#cb19-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-667"><a href="#cb19-667" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 estimateNormal(vec3 p) {</span></span>
<span id="cb19-668"><a href="#cb19-668" aria-hidden="true" tabindex="-1"></a><span class="in">    float eps = 0.001;</span></span>
<span id="cb19-669"><a href="#cb19-669" aria-hidden="true" tabindex="-1"></a><span class="in">    float dx = sceneSDF(p + vec3(eps, 0, 0)) - sceneSDF(p - vec3(eps, 0, 0));</span></span>
<span id="cb19-670"><a href="#cb19-670" aria-hidden="true" tabindex="-1"></a><span class="in">    float dy = sceneSDF(p + vec3(0, eps, 0)) - sceneSDF(p - vec3(0, eps, 0));</span></span>
<span id="cb19-671"><a href="#cb19-671" aria-hidden="true" tabindex="-1"></a><span class="in">    float dz = sceneSDF(p + vec3(0, 0, eps)) - sceneSDF(p - vec3(0, 0, eps));</span></span>
<span id="cb19-672"><a href="#cb19-672" aria-hidden="true" tabindex="-1"></a><span class="in">    return normalize(vec3(dx, dy, dz));</span></span>
<span id="cb19-673"><a href="#cb19-673" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-674"><a href="#cb19-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-675"><a href="#cb19-675" aria-hidden="true" tabindex="-1"></a><span class="in">bool raymarch(vec3 rayOrigin, vec3 rayDir, out vec3 hitPos) {</span></span>
<span id="cb19-676"><a href="#cb19-676" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = 0.0;</span></span>
<span id="cb19-677"><a href="#cb19-677" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-678"><a href="#cb19-678" aria-hidden="true" tabindex="-1"></a><span class="in">    for(int i = 0; i &lt; 100; i++) {</span></span>
<span id="cb19-679"><a href="#cb19-679" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 pos = rayOrigin + t * rayDir;</span></span>
<span id="cb19-680"><a href="#cb19-680" aria-hidden="true" tabindex="-1"></a><span class="in">        float d = sceneSDF(pos);</span></span>
<span id="cb19-681"><a href="#cb19-681" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-682"><a href="#cb19-682" aria-hidden="true" tabindex="-1"></a><span class="in">        if(abs(d) &lt; 0.001) {</span></span>
<span id="cb19-683"><a href="#cb19-683" aria-hidden="true" tabindex="-1"></a><span class="in">            hitPos = pos;</span></span>
<span id="cb19-684"><a href="#cb19-684" aria-hidden="true" tabindex="-1"></a><span class="in">            return true;</span></span>
<span id="cb19-685"><a href="#cb19-685" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb19-686"><a href="#cb19-686" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-687"><a href="#cb19-687" aria-hidden="true" tabindex="-1"></a><span class="in">        t += d;</span></span>
<span id="cb19-688"><a href="#cb19-688" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t &gt; 100.0) return false;</span></span>
<span id="cb19-689"><a href="#cb19-689" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-690"><a href="#cb19-690" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-691"><a href="#cb19-691" aria-hidden="true" tabindex="-1"></a><span class="in">    return false;</span></span>
<span id="cb19-692"><a href="#cb19-692" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-693"><a href="#cb19-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-694"><a href="#cb19-694" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-695"><a href="#cb19-695" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-696"><a href="#cb19-696" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-697"><a href="#cb19-697" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-698"><a href="#cb19-698" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-699"><a href="#cb19-699" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-700"><a href="#cb19-700" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-701"><a href="#cb19-701" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-702"><a href="#cb19-702" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayOrigin = vec3(0.0, 0.0, 0.0);</span></span>
<span id="cb19-703"><a href="#cb19-703" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-704"><a href="#cb19-704" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-705"><a href="#cb19-705" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 hitPos;</span></span>
<span id="cb19-706"><a href="#cb19-706" aria-hidden="true" tabindex="-1"></a><span class="in">    bool hit = raymarch(rayOrigin, rayDir, hitPos);</span></span>
<span id="cb19-707"><a href="#cb19-707" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-708"><a href="#cb19-708" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color;</span></span>
<span id="cb19-709"><a href="#cb19-709" aria-hidden="true" tabindex="-1"></a><span class="in">    if(hit) {</span></span>
<span id="cb19-710"><a href="#cb19-710" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 normal = estimateNormal(hitPos);</span></span>
<span id="cb19-711"><a href="#cb19-711" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));</span></span>
<span id="cb19-712"><a href="#cb19-712" aria-hidden="true" tabindex="-1"></a><span class="in">        float diffuse = max(0.0, dot(normal, lightDir));</span></span>
<span id="cb19-713"><a href="#cb19-713" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-714"><a href="#cb19-714" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 objectColor = vec3(0.0, 0.7, 1.0);  // Cyan</span></span>
<span id="cb19-715"><a href="#cb19-715" aria-hidden="true" tabindex="-1"></a><span class="in">        color = objectColor * diffuse + objectColor * 0.1;</span></span>
<span id="cb19-716"><a href="#cb19-716" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb19-717"><a href="#cb19-717" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(0.1, 0.1, 0.2);</span></span>
<span id="cb19-718"><a href="#cb19-718" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-719"><a href="#cb19-719" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-720"><a href="#cb19-720" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-721"><a href="#cb19-721" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-722"><a href="#cb19-722" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-723"><a href="#cb19-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-724"><a href="#cb19-724" aria-hidden="true" tabindex="-1"></a>Comment/uncomment different SDFs in <span class="in">`sceneSDF()`</span> to instantly see different shapes! Try adding more from Quilez's library. The raymarching algorithm doesn't care what shape you use—it just follows the distance field.</span>
<span id="cb19-725"><a href="#cb19-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-726"><a href="#cb19-726" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-727"><a href="#cb19-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-728"><a href="#cb19-728" aria-hidden="true" tabindex="-1"></a><span class="fu">### Composing Multiple Objects</span></span>
<span id="cb19-729"><a href="#cb19-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-730"><a href="#cb19-730" aria-hidden="true" tabindex="-1"></a>To combine multiple objects, we simply take the **minimum distance** to any object. The closest surface wins!</span>
<span id="cb19-731"><a href="#cb19-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-732"><a href="#cb19-732" aria-hidden="true" tabindex="-1"></a>**Shader 7: Multiple Objects with Materials**</span>
<span id="cb19-733"><a href="#cb19-733" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-734"><a href="#cb19-734" aria-hidden="true" tabindex="-1"></a><span class="in">float sdSphere(vec3 p, vec3 center, float radius) {</span></span>
<span id="cb19-735"><a href="#cb19-735" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(p - center) - radius;</span></span>
<span id="cb19-736"><a href="#cb19-736" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-737"><a href="#cb19-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-738"><a href="#cb19-738" aria-hidden="true" tabindex="-1"></a><span class="in">float sdTorus(vec3 p, vec3 center, float majorRadius, float minorRadius) {</span></span>
<span id="cb19-739"><a href="#cb19-739" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 q = p - center;</span></span>
<span id="cb19-740"><a href="#cb19-740" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 pxz = vec2(q.x, q.z);</span></span>
<span id="cb19-741"><a href="#cb19-741" aria-hidden="true" tabindex="-1"></a><span class="in">    float d = length(pxz) - majorRadius;</span></span>
<span id="cb19-742"><a href="#cb19-742" aria-hidden="true" tabindex="-1"></a><span class="in">    return length(vec2(d, q.y)) - minorRadius;</span></span>
<span id="cb19-743"><a href="#cb19-743" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-744"><a href="#cb19-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-745"><a href="#cb19-745" aria-hidden="true" tabindex="-1"></a><span class="in">float sdPlane(vec3 p, float height) {</span></span>
<span id="cb19-746"><a href="#cb19-746" aria-hidden="true" tabindex="-1"></a><span class="in">    return p.y - height;</span></span>
<span id="cb19-747"><a href="#cb19-747" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-748"><a href="#cb19-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-749"><a href="#cb19-749" aria-hidden="true" tabindex="-1"></a><span class="in">// Global variable to track which object we hit</span></span>
<span id="cb19-750"><a href="#cb19-750" aria-hidden="true" tabindex="-1"></a><span class="in">float gMaterialID;</span></span>
<span id="cb19-751"><a href="#cb19-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-752"><a href="#cb19-752" aria-hidden="true" tabindex="-1"></a><span class="in">float sceneSDF(vec3 p) {</span></span>
<span id="cb19-753"><a href="#cb19-753" aria-hidden="true" tabindex="-1"></a><span class="in">    float d = 1e10;  // Start with very large distance</span></span>
<span id="cb19-754"><a href="#cb19-754" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-755"><a href="#cb19-755" aria-hidden="true" tabindex="-1"></a><span class="in">    // Sphere</span></span>
<span id="cb19-756"><a href="#cb19-756" aria-hidden="true" tabindex="-1"></a><span class="in">    float sphere = sdSphere(p, vec3(-1.2, 0.0, -3.5), 0.8);</span></span>
<span id="cb19-757"><a href="#cb19-757" aria-hidden="true" tabindex="-1"></a><span class="in">    if(sphere &lt; d) {</span></span>
<span id="cb19-758"><a href="#cb19-758" aria-hidden="true" tabindex="-1"></a><span class="in">        d = sphere;</span></span>
<span id="cb19-759"><a href="#cb19-759" aria-hidden="true" tabindex="-1"></a><span class="in">        gMaterialID = 1.0;</span></span>
<span id="cb19-760"><a href="#cb19-760" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-761"><a href="#cb19-761" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-762"><a href="#cb19-762" aria-hidden="true" tabindex="-1"></a><span class="in">    // Torus</span></span>
<span id="cb19-763"><a href="#cb19-763" aria-hidden="true" tabindex="-1"></a><span class="in">    float torus = sdTorus(p, vec3(1.2, 0.0, -3.5), 1.0, 0.3);</span></span>
<span id="cb19-764"><a href="#cb19-764" aria-hidden="true" tabindex="-1"></a><span class="in">    if(torus &lt; d) {</span></span>
<span id="cb19-765"><a href="#cb19-765" aria-hidden="true" tabindex="-1"></a><span class="in">        d = torus;</span></span>
<span id="cb19-766"><a href="#cb19-766" aria-hidden="true" tabindex="-1"></a><span class="in">        gMaterialID = 2.0;</span></span>
<span id="cb19-767"><a href="#cb19-767" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-768"><a href="#cb19-768" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-769"><a href="#cb19-769" aria-hidden="true" tabindex="-1"></a><span class="in">    // Ground plane</span></span>
<span id="cb19-770"><a href="#cb19-770" aria-hidden="true" tabindex="-1"></a><span class="in">    float plane = sdPlane(p, -1.0);</span></span>
<span id="cb19-771"><a href="#cb19-771" aria-hidden="true" tabindex="-1"></a><span class="in">    if(plane &lt; d) {</span></span>
<span id="cb19-772"><a href="#cb19-772" aria-hidden="true" tabindex="-1"></a><span class="in">        d = plane;</span></span>
<span id="cb19-773"><a href="#cb19-773" aria-hidden="true" tabindex="-1"></a><span class="in">        gMaterialID = 3.0;</span></span>
<span id="cb19-774"><a href="#cb19-774" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-775"><a href="#cb19-775" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-776"><a href="#cb19-776" aria-hidden="true" tabindex="-1"></a><span class="in">    return d;</span></span>
<span id="cb19-777"><a href="#cb19-777" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-778"><a href="#cb19-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-779"><a href="#cb19-779" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 getMaterialColor(float matID) {</span></span>
<span id="cb19-780"><a href="#cb19-780" aria-hidden="true" tabindex="-1"></a><span class="in">    if(matID &lt; 1.5) return vec3(1.0, 0.0, 0.0);      // Sphere: red</span></span>
<span id="cb19-781"><a href="#cb19-781" aria-hidden="true" tabindex="-1"></a><span class="in">    if(matID &lt; 2.5) return vec3(0.0, 0.7, 1.0);      // Torus: cyan</span></span>
<span id="cb19-782"><a href="#cb19-782" aria-hidden="true" tabindex="-1"></a><span class="in">    return vec3(0.5, 0.5, 0.5);                       // Plane: gray</span></span>
<span id="cb19-783"><a href="#cb19-783" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-784"><a href="#cb19-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-785"><a href="#cb19-785" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 estimateNormal(vec3 p) {</span></span>
<span id="cb19-786"><a href="#cb19-786" aria-hidden="true" tabindex="-1"></a><span class="in">    float eps = 0.001;</span></span>
<span id="cb19-787"><a href="#cb19-787" aria-hidden="true" tabindex="-1"></a><span class="in">    float dx = sceneSDF(p + vec3(eps, 0, 0)) - sceneSDF(p - vec3(eps, 0, 0));</span></span>
<span id="cb19-788"><a href="#cb19-788" aria-hidden="true" tabindex="-1"></a><span class="in">    float dy = sceneSDF(p + vec3(0, eps, 0)) - sceneSDF(p - vec3(0, eps, 0));</span></span>
<span id="cb19-789"><a href="#cb19-789" aria-hidden="true" tabindex="-1"></a><span class="in">    float dz = sceneSDF(p + vec3(0, 0, eps)) - sceneSDF(p - vec3(0, 0, eps));</span></span>
<span id="cb19-790"><a href="#cb19-790" aria-hidden="true" tabindex="-1"></a><span class="in">    return normalize(vec3(dx, dy, dz));</span></span>
<span id="cb19-791"><a href="#cb19-791" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-792"><a href="#cb19-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-793"><a href="#cb19-793" aria-hidden="true" tabindex="-1"></a><span class="in">bool raymarch(vec3 rayOrigin, vec3 rayDir, out vec3 hitPos, out float matID) {</span></span>
<span id="cb19-794"><a href="#cb19-794" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = 0.0;</span></span>
<span id="cb19-795"><a href="#cb19-795" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-796"><a href="#cb19-796" aria-hidden="true" tabindex="-1"></a><span class="in">    for(int i = 0; i &lt; 100; i++) {</span></span>
<span id="cb19-797"><a href="#cb19-797" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 pos = rayOrigin + t * rayDir;</span></span>
<span id="cb19-798"><a href="#cb19-798" aria-hidden="true" tabindex="-1"></a><span class="in">        float d = sceneSDF(pos);</span></span>
<span id="cb19-799"><a href="#cb19-799" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-800"><a href="#cb19-800" aria-hidden="true" tabindex="-1"></a><span class="in">        if(abs(d) &lt; 0.001) {</span></span>
<span id="cb19-801"><a href="#cb19-801" aria-hidden="true" tabindex="-1"></a><span class="in">            hitPos = pos;</span></span>
<span id="cb19-802"><a href="#cb19-802" aria-hidden="true" tabindex="-1"></a><span class="in">            matID = gMaterialID;</span></span>
<span id="cb19-803"><a href="#cb19-803" aria-hidden="true" tabindex="-1"></a><span class="in">            return true;</span></span>
<span id="cb19-804"><a href="#cb19-804" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb19-805"><a href="#cb19-805" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-806"><a href="#cb19-806" aria-hidden="true" tabindex="-1"></a><span class="in">        t += d;</span></span>
<span id="cb19-807"><a href="#cb19-807" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t &gt; 100.0) return false;</span></span>
<span id="cb19-808"><a href="#cb19-808" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-809"><a href="#cb19-809" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-810"><a href="#cb19-810" aria-hidden="true" tabindex="-1"></a><span class="in">    return false;</span></span>
<span id="cb19-811"><a href="#cb19-811" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-812"><a href="#cb19-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-813"><a href="#cb19-813" aria-hidden="true" tabindex="-1"></a><span class="in">void mainImage(out vec4 fragColor, in vec2 fragCoord)</span></span>
<span id="cb19-814"><a href="#cb19-814" aria-hidden="true" tabindex="-1"></a><span class="in">{</span></span>
<span id="cb19-815"><a href="#cb19-815" aria-hidden="true" tabindex="-1"></a><span class="in">    vec2 uv = (fragCoord / iResolution.xy) * 2.0 - 1.0;</span></span>
<span id="cb19-816"><a href="#cb19-816" aria-hidden="true" tabindex="-1"></a><span class="in">    uv.x *= iResolution.x / iResolution.y;</span></span>
<span id="cb19-817"><a href="#cb19-817" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-818"><a href="#cb19-818" aria-hidden="true" tabindex="-1"></a><span class="in">    float fov = 45.0;</span></span>
<span id="cb19-819"><a href="#cb19-819" aria-hidden="true" tabindex="-1"></a><span class="in">    float focalLength = 1.0 / tan(radians(fov) / 2.0);</span></span>
<span id="cb19-820"><a href="#cb19-820" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-821"><a href="#cb19-821" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayOrigin = vec3(0.0, 0.0, 0.0);</span></span>
<span id="cb19-822"><a href="#cb19-822" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 rayDir = normalize(vec3(uv.x, uv.y, -focalLength));</span></span>
<span id="cb19-823"><a href="#cb19-823" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-824"><a href="#cb19-824" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 hitPos;</span></span>
<span id="cb19-825"><a href="#cb19-825" aria-hidden="true" tabindex="-1"></a><span class="in">    float matID;</span></span>
<span id="cb19-826"><a href="#cb19-826" aria-hidden="true" tabindex="-1"></a><span class="in">    bool hit = raymarch(rayOrigin, rayDir, hitPos, matID);</span></span>
<span id="cb19-827"><a href="#cb19-827" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-828"><a href="#cb19-828" aria-hidden="true" tabindex="-1"></a><span class="in">    vec3 color;</span></span>
<span id="cb19-829"><a href="#cb19-829" aria-hidden="true" tabindex="-1"></a><span class="in">    if(hit) {</span></span>
<span id="cb19-830"><a href="#cb19-830" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 normal = estimateNormal(hitPos);</span></span>
<span id="cb19-831"><a href="#cb19-831" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));</span></span>
<span id="cb19-832"><a href="#cb19-832" aria-hidden="true" tabindex="-1"></a><span class="in">        float diffuse = max(0.0, dot(normal, lightDir));</span></span>
<span id="cb19-833"><a href="#cb19-833" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-834"><a href="#cb19-834" aria-hidden="true" tabindex="-1"></a><span class="in">        vec3 objectColor = getMaterialColor(matID);</span></span>
<span id="cb19-835"><a href="#cb19-835" aria-hidden="true" tabindex="-1"></a><span class="in">        color = objectColor * diffuse + objectColor * 0.1;</span></span>
<span id="cb19-836"><a href="#cb19-836" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb19-837"><a href="#cb19-837" aria-hidden="true" tabindex="-1"></a><span class="in">        color = vec3(0.1, 0.1, 0.2);</span></span>
<span id="cb19-838"><a href="#cb19-838" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-839"><a href="#cb19-839" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-840"><a href="#cb19-840" aria-hidden="true" tabindex="-1"></a><span class="in">    fragColor = vec4(color, 1.0);</span></span>
<span id="cb19-841"><a href="#cb19-841" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-842"><a href="#cb19-842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-843"><a href="#cb19-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-844"><a href="#cb19-844" aria-hidden="true" tabindex="-1"></a>Three objects with different colors! Adding more objects is trivial—just add another SDF check in <span class="in">`sceneSDF()`</span>. Compare this to analytical methods where combining objects requires sophisticated CSG (constructive solid geometry) techniques.</span>
<span id="cb19-845"><a href="#cb19-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-846"><a href="#cb19-846" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-847"><a href="#cb19-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-848"><a href="#cb19-848" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb19-849"><a href="#cb19-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-850"><a href="#cb19-850" aria-hidden="true" tabindex="-1"></a>Today we learned two approaches to 3D rendering:</span>
<span id="cb19-851"><a href="#cb19-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-852"><a href="#cb19-852" aria-hidden="true" tabindex="-1"></a>**Analytical Ray Tracing:**</span>
<span id="cb19-853"><a href="#cb19-853" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Solve equations directly for ray-surface intersection</span>
<span id="cb19-854"><a href="#cb19-854" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Exact solutions, very efficient for simple geometry</span>
<span id="cb19-855"><a href="#cb19-855" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sphere: straightforward quadratic equation</span>
<span id="cb19-856"><a href="#cb19-856" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Torus: complex quartic equation requiring sophisticated algebra</span>
<span id="cb19-857"><a href="#cb19-857" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Becomes increasingly difficult for complex surfaces</span>
<span id="cb19-858"><a href="#cb19-858" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Standard in production ray tracers for well-defined geometry</span>
<span id="cb19-859"><a href="#cb19-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-860"><a href="#cb19-860" aria-hidden="true" tabindex="-1"></a>**SDF-Based Raymarching:**</span>
<span id="cb19-861"><a href="#cb19-861" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Represent surfaces as distance fields</span>
<span id="cb19-862"><a href="#cb19-862" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>March along rays using sphere tracing</span>
<span id="cb19-863"><a href="#cb19-863" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simple, uniform code for any geometry</span>
<span id="cb19-864"><a href="#cb19-864" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Easy composition: just take minimum distance</span>
<span id="cb19-865"><a href="#cb19-865" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Flexible—works for procedural, implicit, or arbitrary surfaces</span>
<span id="cb19-866"><a href="#cb19-866" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Slightly slower than analytical, but much more versatile</span>
<span id="cb19-867"><a href="#cb19-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-868"><a href="#cb19-868" aria-hidden="true" tabindex="-1"></a>**Key Concepts:**</span>
<span id="cb19-869"><a href="#cb19-869" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Camera setup and ray generation</span>
<span id="cb19-870"><a href="#cb19-870" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Parametric ray equation: $\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}$</span>
<span id="cb19-871"><a href="#cb19-871" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Surface normals for lighting</span>
<span id="cb19-872"><a href="#cb19-872" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Diffuse (Lambertian) shading</span>
<span id="cb19-873"><a href="#cb19-873" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Signed distance functions (SDFs)</span>
<span id="cb19-874"><a href="#cb19-874" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sphere tracing algorithm</span>
<span id="cb19-875"><a href="#cb19-875" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Normal estimation via gradient (finite differences)</span>
<span id="cb19-876"><a href="#cb19-876" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Material tracking for multiple objects</span>
<span id="cb19-877"><a href="#cb19-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-878"><a href="#cb19-878" aria-hidden="true" tabindex="-1"></a>Tomorrow we'll explore advanced raymarching: domain operations for infinite repetition, boolean operations for smooth blending, and 3D fractals!</span>
<span id="cb19-879"><a href="#cb19-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-880"><a href="#cb19-880" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-881"><a href="#cb19-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-882"><a href="#cb19-882" aria-hidden="true" tabindex="-1"></a><span class="fu">## Homework</span></span>
<span id="cb19-883"><a href="#cb19-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-884"><a href="#cb19-884" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required: Algebraic Variety Rendering</span></span>
<span id="cb19-885"><a href="#cb19-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-886"><a href="#cb19-886" aria-hidden="true" tabindex="-1"></a>Implement analytical ray tracing for an interesting polynomial implicit surface.</span>
<span id="cb19-887"><a href="#cb19-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-888"><a href="#cb19-888" aria-hidden="true" tabindex="-1"></a>**Goal:** Experience the challenges of analytical methods firsthand, then appreciate SDFs even more!</span>
<span id="cb19-889"><a href="#cb19-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-890"><a href="#cb19-890" aria-hidden="true" tabindex="-1"></a>**Suggested surfaces:**</span>
<span id="cb19-891"><a href="#cb19-891" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Degree 3**: Saddle surfaces, cubic varieties</span>
<span id="cb19-892"><a href="#cb19-892" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Degree 4**: Klein bottle projections, quartic surfaces with interesting topology</span>
<span id="cb19-893"><a href="#cb19-893" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Cassini ovals** in 3D: $(x^2 + y^2 + z^2)^2 - 2a^2(x^2 - y^2) = b^4 - a^4$</span>
<span id="cb19-894"><a href="#cb19-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-895"><a href="#cb19-895" aria-hidden="true" tabindex="-1"></a>**Implementation steps:**</span>
<span id="cb19-896"><a href="#cb19-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-897"><a href="#cb19-897" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Define your implicit function** $F(x,y,z) = 0$</span>
<span id="cb19-898"><a href="#cb19-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-899"><a href="#cb19-899" aria-hidden="true" tabindex="-1"></a>Example—a quartic surface:</span>
<span id="cb19-900"><a href="#cb19-900" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-901"><a href="#cb19-901" aria-hidden="true" tabindex="-1"></a><span class="in">float implicitFunction(vec3 p) {</span></span>
<span id="cb19-902"><a href="#cb19-902" aria-hidden="true" tabindex="-1"></a><span class="in">    float r2 = dot(p, p);</span></span>
<span id="cb19-903"><a href="#cb19-903" aria-hidden="true" tabindex="-1"></a><span class="in">    return r2 * r2 - (p.x*p.x + p.y*p.y - 2.0*p.z*p.z);</span></span>
<span id="cb19-904"><a href="#cb19-904" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-905"><a href="#cb19-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-906"><a href="#cb19-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-907"><a href="#cb19-907" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Implement root finding** (bisection method)</span>
<span id="cb19-908"><a href="#cb19-908" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-909"><a href="#cb19-909" aria-hidden="true" tabindex="-1"></a><span class="in">float intersectImplicit(vec3 rayOrigin, vec3 rayDir) {</span></span>
<span id="cb19-910"><a href="#cb19-910" aria-hidden="true" tabindex="-1"></a><span class="in">    float tMin = 0.0;</span></span>
<span id="cb19-911"><a href="#cb19-911" aria-hidden="true" tabindex="-1"></a><span class="in">    float tMax = 10.0;</span></span>
<span id="cb19-912"><a href="#cb19-912" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-913"><a href="#cb19-913" aria-hidden="true" tabindex="-1"></a><span class="in">    // Check for sign change</span></span>
<span id="cb19-914"><a href="#cb19-914" aria-hidden="true" tabindex="-1"></a><span class="in">    float fMin = implicitFunction(rayOrigin + tMin * rayDir);</span></span>
<span id="cb19-915"><a href="#cb19-915" aria-hidden="true" tabindex="-1"></a><span class="in">    float fMax = implicitFunction(rayOrigin + tMax * rayDir);</span></span>
<span id="cb19-916"><a href="#cb19-916" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-917"><a href="#cb19-917" aria-hidden="true" tabindex="-1"></a><span class="in">    if(fMin * fMax &gt; 0.0) return -1.0;  // No root</span></span>
<span id="cb19-918"><a href="#cb19-918" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-919"><a href="#cb19-919" aria-hidden="true" tabindex="-1"></a><span class="in">    // Bisection</span></span>
<span id="cb19-920"><a href="#cb19-920" aria-hidden="true" tabindex="-1"></a><span class="in">    for(int i = 0; i &lt; 50; i++) {</span></span>
<span id="cb19-921"><a href="#cb19-921" aria-hidden="true" tabindex="-1"></a><span class="in">        float tMid = (tMin + tMax) / 2.0;</span></span>
<span id="cb19-922"><a href="#cb19-922" aria-hidden="true" tabindex="-1"></a><span class="in">        float fMid = implicitFunction(rayOrigin + tMid * rayDir);</span></span>
<span id="cb19-923"><a href="#cb19-923" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-924"><a href="#cb19-924" aria-hidden="true" tabindex="-1"></a><span class="in">        if(abs(fMid) &lt; 0.001) return tMid;</span></span>
<span id="cb19-925"><a href="#cb19-925" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb19-926"><a href="#cb19-926" aria-hidden="true" tabindex="-1"></a><span class="in">        if(fMin * fMid &lt; 0.0) {</span></span>
<span id="cb19-927"><a href="#cb19-927" aria-hidden="true" tabindex="-1"></a><span class="in">            tMax = tMid;</span></span>
<span id="cb19-928"><a href="#cb19-928" aria-hidden="true" tabindex="-1"></a><span class="in">            fMax = fMid;</span></span>
<span id="cb19-929"><a href="#cb19-929" aria-hidden="true" tabindex="-1"></a><span class="in">        } else {</span></span>
<span id="cb19-930"><a href="#cb19-930" aria-hidden="true" tabindex="-1"></a><span class="in">            tMin = tMid;</span></span>
<span id="cb19-931"><a href="#cb19-931" aria-hidden="true" tabindex="-1"></a><span class="in">            fMin = fMid;</span></span>
<span id="cb19-932"><a href="#cb19-932" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb19-933"><a href="#cb19-933" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-934"><a href="#cb19-934" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-935"><a href="#cb19-935" aria-hidden="true" tabindex="-1"></a><span class="in">    return (tMin + tMax) / 2.0;</span></span>
<span id="cb19-936"><a href="#cb19-936" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-937"><a href="#cb19-937" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-938"><a href="#cb19-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-939"><a href="#cb19-939" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Compute normal via gradient**</span>
<span id="cb19-940"><a href="#cb19-940" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-941"><a href="#cb19-941" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 implicitNormal(vec3 p) {</span></span>
<span id="cb19-942"><a href="#cb19-942" aria-hidden="true" tabindex="-1"></a><span class="in">    float eps = 0.001;</span></span>
<span id="cb19-943"><a href="#cb19-943" aria-hidden="true" tabindex="-1"></a><span class="in">    float dx = implicitFunction(p + vec3(eps, 0, 0)) - implicitFunction(p - vec3(eps, 0, 0));</span></span>
<span id="cb19-944"><a href="#cb19-944" aria-hidden="true" tabindex="-1"></a><span class="in">    float dy = implicitFunction(p + vec3(0, eps, 0)) - implicitFunction(p - vec3(0, eps, 0));</span></span>
<span id="cb19-945"><a href="#cb19-945" aria-hidden="true" tabindex="-1"></a><span class="in">    float dz = implicitFunction(p + vec3(0, 0, eps)) - implicitFunction(p - vec3(0, 0, eps));</span></span>
<span id="cb19-946"><a href="#cb19-946" aria-hidden="true" tabindex="-1"></a><span class="in">    return normalize(vec3(dx, dy, dz));</span></span>
<span id="cb19-947"><a href="#cb19-947" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-948"><a href="#cb19-948" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-949"><a href="#cb19-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-950"><a href="#cb19-950" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Optimization: Bounding volume** (optional but recommended)</span>
<span id="cb19-951"><a href="#cb19-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-952"><a href="#cb19-952" aria-hidden="true" tabindex="-1"></a>Use a bounding sphere to avoid checking the entire ray:</span>
<span id="cb19-953"><a href="#cb19-953" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-954"><a href="#cb19-954" aria-hidden="true" tabindex="-1"></a><span class="in">// First check if ray intersects bounding sphere</span></span>
<span id="cb19-955"><a href="#cb19-955" aria-hidden="true" tabindex="-1"></a><span class="in">// Only compute implicit function if inside bounds</span></span>
<span id="cb19-956"><a href="#cb19-956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-957"><a href="#cb19-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-958"><a href="#cb19-958" aria-hidden="true" tabindex="-1"></a>**Expected output:** A rendered algebraic surface with proper lighting showing its geometric features.</span>
<span id="cb19-959"><a href="#cb19-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-960"><a href="#cb19-960" aria-hidden="true" tabindex="-1"></a>**Reflection question:** After implementing this, compare the effort to using SDFs. Which approach would you prefer for a complex scene with many objects?</span>
<span id="cb19-961"><a href="#cb19-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-962"><a href="#cb19-962" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-963"><a href="#cb19-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-964"><a href="#cb19-964" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optional Exercises</span></span>
<span id="cb19-965"><a href="#cb19-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-966"><a href="#cb19-966" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1. Specular Lighting (Phong Model)</span></span>
<span id="cb19-967"><a href="#cb19-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-968"><a href="#cb19-968" aria-hidden="true" tabindex="-1"></a>Add shiny highlights using the Phong reflection model:</span>
<span id="cb19-969"><a href="#cb19-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-970"><a href="#cb19-970" aria-hidden="true" tabindex="-1"></a>$$\text{specular} = (R \cdot V)^n$$</span>
<span id="cb19-971"><a href="#cb19-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-972"><a href="#cb19-972" aria-hidden="true" tabindex="-1"></a>where $R$ is reflected light direction, $V$ is view direction, $n$ is shininess.</span>
<span id="cb19-973"><a href="#cb19-973" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-974"><a href="#cb19-974" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 R = reflect(-lightDir, normal);  // Reflected light</span></span>
<span id="cb19-975"><a href="#cb19-975" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 V = -rayDir;                      // View direction</span></span>
<span id="cb19-976"><a href="#cb19-976" aria-hidden="true" tabindex="-1"></a><span class="in">float spec = pow(max(0.0, dot(R, V)), 32.0);</span></span>
<span id="cb19-977"><a href="#cb19-977" aria-hidden="true" tabindex="-1"></a><span class="in">color += vec3(1.0) * spec * 0.5;  // White specular highlight</span></span>
<span id="cb19-978"><a href="#cb19-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-979"><a href="#cb19-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-980"><a href="#cb19-980" aria-hidden="true" tabindex="-1"></a>Try different shininess values (8, 16, 32, 64, 128) to see the effect!</span>
<span id="cb19-981"><a href="#cb19-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-982"><a href="#cb19-982" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2. Camera Movement</span></span>
<span id="cb19-983"><a href="#cb19-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-984"><a href="#cb19-984" aria-hidden="true" tabindex="-1"></a>Implement an orbiting camera using time:</span>
<span id="cb19-985"><a href="#cb19-985" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-986"><a href="#cb19-986" aria-hidden="true" tabindex="-1"></a><span class="in">float angle = iTime * 0.5;</span></span>
<span id="cb19-987"><a href="#cb19-987" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 rayOrigin = vec3(3.0 * cos(angle), 1.0, 3.0 * sin(angle));</span></span>
<span id="cb19-988"><a href="#cb19-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-989"><a href="#cb19-989" aria-hidden="true" tabindex="-1"></a><span class="in">// Look-at matrix</span></span>
<span id="cb19-990"><a href="#cb19-990" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 target = vec3(0.0, 0.0, -3.0);</span></span>
<span id="cb19-991"><a href="#cb19-991" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 forward = normalize(target - rayOrigin);</span></span>
<span id="cb19-992"><a href="#cb19-992" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 right = normalize(cross(vec3(0, 1, 0), forward));</span></span>
<span id="cb19-993"><a href="#cb19-993" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 up = cross(forward, right);</span></span>
<span id="cb19-994"><a href="#cb19-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-995"><a href="#cb19-995" aria-hidden="true" tabindex="-1"></a><span class="in">// Transform ray direction</span></span>
<span id="cb19-996"><a href="#cb19-996" aria-hidden="true" tabindex="-1"></a><span class="in">vec3 rd = normalize(uv.x * right + uv.y * up + focalLength * forward);</span></span>
<span id="cb19-997"><a href="#cb19-997" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-998"><a href="#cb19-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-999"><a href="#cb19-999" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3. Complex SDF Scene</span></span>
<span id="cb19-1000"><a href="#cb19-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1001"><a href="#cb19-1001" aria-hidden="true" tabindex="-1"></a>Create a scene with 5+ objects using different SDFs from <span class="co">[</span><span class="ot">Quilez's library</span><span class="co">](https://iquilezles.org/articles/distfunctions/)</span>:</span>
<span id="cb19-1002"><a href="#cb19-1002" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Mix primitives: spheres, boxes, cylinders, tori, cones</span>
<span id="cb19-1003"><a href="#cb19-1003" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Position them creatively</span>
<span id="cb19-1004"><a href="#cb19-1004" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use different materials</span>
<span id="cb19-1005"><a href="#cb19-1005" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Add interesting lighting</span>
<span id="cb19-1006"><a href="#cb19-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1007"><a href="#cb19-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4. Soft Shadows (Preview of Day 5)</span></span>
<span id="cb19-1008"><a href="#cb19-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1009"><a href="#cb19-1009" aria-hidden="true" tabindex="-1"></a>Cast rays from the surface toward the light to check for occlusion:</span>
<span id="cb19-1010"><a href="#cb19-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```glsl</span></span>
<span id="cb19-1011"><a href="#cb19-1011" aria-hidden="true" tabindex="-1"></a><span class="in">float softShadow(vec3 pos, vec3 lightDir) {</span></span>
<span id="cb19-1012"><a href="#cb19-1012" aria-hidden="true" tabindex="-1"></a><span class="in">    float t = 0.01;  // Start slightly above surface</span></span>
<span id="cb19-1013"><a href="#cb19-1013" aria-hidden="true" tabindex="-1"></a><span class="in">    float shadow = 1.0;</span></span>
<span id="cb19-1014"><a href="#cb19-1014" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-1015"><a href="#cb19-1015" aria-hidden="true" tabindex="-1"></a><span class="in">    for(int i = 0; i &lt; 50; i++) {</span></span>
<span id="cb19-1016"><a href="#cb19-1016" aria-hidden="true" tabindex="-1"></a><span class="in">        float d = sceneSDF(pos + lightDir * t);</span></span>
<span id="cb19-1017"><a href="#cb19-1017" aria-hidden="true" tabindex="-1"></a><span class="in">        shadow = min(shadow, 8.0 * d / t);  // Penumbra factor</span></span>
<span id="cb19-1018"><a href="#cb19-1018" aria-hidden="true" tabindex="-1"></a><span class="in">        t += d;</span></span>
<span id="cb19-1019"><a href="#cb19-1019" aria-hidden="true" tabindex="-1"></a><span class="in">        if(t &gt; 10.0 || d &lt; 0.001) break;</span></span>
<span id="cb19-1020"><a href="#cb19-1020" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb19-1021"><a href="#cb19-1021" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb19-1022"><a href="#cb19-1022" aria-hidden="true" tabindex="-1"></a><span class="in">    return clamp(shadow, 0.0, 1.0);</span></span>
<span id="cb19-1023"><a href="#cb19-1023" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb19-1024"><a href="#cb19-1024" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1025"><a href="#cb19-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1026"><a href="#cb19-1026" aria-hidden="true" tabindex="-1"></a>Apply this to your diffuse lighting for more realistic shadows!</span>
<span id="cb19-1027"><a href="#cb19-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1028"><a href="#cb19-1028" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-1029"><a href="#cb19-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1030"><a href="#cb19-1030" aria-hidden="true" tabindex="-1"></a><span class="fu">## Looking Ahead to Day 5</span></span>
<span id="cb19-1031"><a href="#cb19-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1032"><a href="#cb19-1032" aria-hidden="true" tabindex="-1"></a>Tomorrow we'll explore advanced raymarching techniques that would be nearly impossible with analytical methods:</span>
<span id="cb19-1033"><a href="#cb19-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1034"><a href="#cb19-1034" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Domain operations**: Infinite repetition, symmetry, twisting</span>
<span id="cb19-1035"><a href="#cb19-1035" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Boolean operations**: Union, intersection, smooth blending</span>
<span id="cb19-1036"><a href="#cb19-1036" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**3D fractals**: Menger sponge, Mandelbulb via iterated transformations</span>
<span id="cb19-1037"><a href="#cb19-1037" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Advanced lighting**: Ambient occlusion, global illumination</span>
<span id="cb19-1038"><a href="#cb19-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1039"><a href="#cb19-1039" aria-hidden="true" tabindex="-1"></a>Make sure you're comfortable with:</span>
<span id="cb19-1040"><a href="#cb19-1040" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The raymarching algorithm (it's the foundation)</span>
<span id="cb19-1041"><a href="#cb19-1041" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How SDFs compose (taking minimum/maximum)</span>
<span id="cb19-1042"><a href="#cb19-1042" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Normal estimation via gradients</span>
<span id="cb19-1043"><a href="#cb19-1043" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The material tracking pattern we developed</span>
<span id="cb19-1044"><a href="#cb19-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1045"><a href="#cb19-1045" aria-hidden="true" tabindex="-1"></a>See you tomorrow!</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>