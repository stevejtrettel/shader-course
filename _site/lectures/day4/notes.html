<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Steve Trettel">

<title>notes – GPU-Accelerated Mathematical Illustration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e62aa0a8c28b52a0e19b1cebeabd7fd3.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-f0463eacbf7faa50df92658b97a72515.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e62aa0a8c28b52a0e19b1cebeabd7fd3.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-d72af2198ff6241fba5e91235accbade.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-9ba55aa6988265aad246d48a0606a5a7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-d72af2198ff6241fba5e91235accbade.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../lectures/day4/notes.html">Day 4: Ray Marching</a></li><li class="breadcrumb-item"><a href="../../lectures/day4/notes.html">Lecture Notes</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">GPU-Accelerated Mathematical Illustration</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 1: Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day1/notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day1/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day1/shaders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shader Code</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 2: Dynamics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day2/notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day2/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day2/shaders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shader Code</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 3: Tilings</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day3/notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day3/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day3/shaders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shader Code</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 4: Ray Marching</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day4/notes.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture Notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day4/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../lectures/day4/shaders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shader Code</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../GPU-Accelerated-Mathematical-Illustration.pdf" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Download PDF</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#day-4-3d-rendering" id="toc-day-4-3d-rendering" class="nav-link active" data-scroll-target="#day-4-3d-rendering"><span class="header-section-number">1</span> Day 4: 3D Rendering</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">1.1</span> Overview</a></li>
  <li><a href="#cameras-and-rays" id="toc-cameras-and-rays" class="nav-link" data-scroll-target="#cameras-and-rays"><span class="header-section-number">1.2</span> Cameras and Rays</a>
  <ul class="collapse">
  <li><a href="#the-pinhole-camera" id="toc-the-pinhole-camera" class="nav-link" data-scroll-target="#the-pinhole-camera">The Pinhole Camera</a></li>
  <li><a href="#coordinate-system" id="toc-coordinate-system" class="nav-link" data-scroll-target="#coordinate-system">Coordinate System</a></li>
  <li><a href="#rays" id="toc-rays" class="nav-link" data-scroll-target="#rays">Rays</a></li>
  <li><a href="#field-of-view" id="toc-field-of-view" class="nav-link" data-scroll-target="#field-of-view">Field of View</a></li>
  <li><a href="#generating-rays" id="toc-generating-rays" class="nav-link" data-scroll-target="#generating-rays">Generating Rays</a></li>
  <li><a href="#visualizing-rays" id="toc-visualizing-rays" class="nav-link" data-scroll-target="#visualizing-rays">Visualizing Rays</a></li>
  </ul></li>
  <li><a href="#raytracing" id="toc-raytracing" class="nav-link" data-scroll-target="#raytracing"><span class="header-section-number">1.3</span> Raytracing</a>
  <ul class="collapse">
  <li><a href="#intersection" id="toc-intersection" class="nav-link" data-scroll-target="#intersection">Intersection</a></li>
  <li><a href="#surface-normals" id="toc-surface-normals" class="nav-link" data-scroll-target="#surface-normals">Surface Normals</a></li>
  <li><a href="#lighting" id="toc-lighting" class="nav-link" data-scroll-target="#lighting">Lighting</a></li>
  </ul></li>
  <li><a href="#the-limits-of-analytical-methods" id="toc-the-limits-of-analytical-methods" class="nav-link" data-scroll-target="#the-limits-of-analytical-methods"><span class="header-section-number">1.4</span> The Limits of Analytical Methods</a>
  <ul class="collapse">
  <li><a href="#the-torus" id="toc-the-torus" class="nav-link" data-scroll-target="#the-torus">The Torus</a></li>
  <li><a href="#ray-torus-intersection" id="toc-ray-torus-intersection" class="nav-link" data-scroll-target="#ray-torus-intersection">Ray-Torus Intersection</a></li>
  <li><a href="#torus-normal" id="toc-torus-normal" class="nav-link" data-scroll-target="#torus-normal">Torus Normal</a></li>
  <li><a href="#putting-it-together" id="toc-putting-it-together" class="nav-link" data-scroll-target="#putting-it-together">Putting It Together</a></li>
  <li><a href="#the-tradeoff" id="toc-the-tradeoff" class="nav-link" data-scroll-target="#the-tradeoff">The Tradeoff</a></li>
  </ul></li>
  <li><a href="#signed-distance-functions" id="toc-signed-distance-functions" class="nav-link" data-scroll-target="#signed-distance-functions"><span class="header-section-number">1.5</span> Signed Distance Functions</a>
  <ul class="collapse">
  <li><a href="#a-different-approach" id="toc-a-different-approach" class="nav-link" data-scroll-target="#a-different-approach">A Different Approach</a></li>
  <li><a href="#definition" id="toc-definition" class="nav-link" data-scroll-target="#definition">Definition</a></li>
  <li><a href="#visualizing-sdfs" id="toc-visualizing-sdfs" class="nav-link" data-scroll-target="#visualizing-sdfs">Visualizing SDFs</a></li>
  <li><a href="#d-primitives" id="toc-d-primitives" class="nav-link" data-scroll-target="#d-primitives">3D Primitives</a></li>
  <li><a href="#normals-from-sdfs" id="toc-normals-from-sdfs" class="nav-link" data-scroll-target="#normals-from-sdfs">Normals from SDFs</a></li>
  </ul></li>
  <li><a href="#raymarching" id="toc-raymarching" class="nav-link" data-scroll-target="#raymarching"><span class="header-section-number">1.6</span> Raymarching</a>
  <ul class="collapse">
  <li><a href="#the-algorithm" id="toc-the-algorithm" class="nav-link" data-scroll-target="#the-algorithm">The Algorithm</a></li>
  <li><a href="#raymarched-sphere" id="toc-raymarched-sphere" class="nav-link" data-scroll-target="#raymarched-sphere">Raymarched Sphere</a></li>
  <li><a href="#raymarched-torus" id="toc-raymarched-torus" class="nav-link" data-scroll-target="#raymarched-torus">Raymarched Torus</a></li>
  </ul></li>
  <li><a href="#building-scenes" id="toc-building-scenes" class="nav-link" data-scroll-target="#building-scenes"><span class="header-section-number">1.7</span> Building Scenes</a>
  <ul class="collapse">
  <li><a href="#combining-objects" id="toc-combining-objects" class="nav-link" data-scroll-target="#combining-objects">Combining Objects</a></li>
  <li><a href="#materials" id="toc-materials" class="nav-link" data-scroll-target="#materials">Materials</a></li>
  <li><a href="#a-complete-scene" id="toc-a-complete-scene" class="nav-link" data-scroll-target="#a-complete-scene">A Complete Scene</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">1.8</span> Exercises</a>
  <ul class="collapse">
  <li><a href="#checkpoints" id="toc-checkpoints" class="nav-link" data-scroll-target="#checkpoints">Checkpoints</a></li>
  <li><a href="#explorations" id="toc-explorations" class="nav-link" data-scroll-target="#explorations">Explorations</a></li>
  <li><a href="#challenges" id="toc-challenges" class="nav-link" data-scroll-target="#challenges">Challenges</a></li>
  <li><a href="#project" id="toc-project" class="nav-link" data-scroll-target="#project">Project</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../lectures/day4/notes.html">Day 4: Ray Marching</a></li><li class="breadcrumb-item"><a href="../../lectures/day4/notes.html">Lecture Notes</a></li></ol></nav>
<div class="quarto-title">
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Steve Trettel </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="day-4-3d-rendering" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Day 4: 3D Rendering</h1>
<section id="overview" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1.1</span> Overview</h2>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/barth-sextic-final</code> not found.</div>
</div>

<p>This is the <strong>Barth sextic</strong> — an algebraic surface with 50 singular points and icosahedral symmetry, rendered entirely on the GPU.</p>
<p>This chapter covers a lot of ground. In class, we’ll focus on the fundamentals: cameras, rays, signed distance functions, and the raymarching algorithm. But if you work through the exercises and the final project, you can build something like what you see above — a rotating algebraic variety with multi-colored lighting and shadows.</p>
<p>We’ll start with the classical approach — solving ray-surface intersections analytically — and see why it becomes unwieldy for complex geometry. Then we’ll develop a more flexible technique: <strong>raymarching</strong> with signed distance functions. This approach lets us render almost anything we can describe mathematically, including the algebraic varieties that have fascinated geometers for centuries.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Learning Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of today, you will be able to:</p>
<ul>
<li>Set up a camera and generate rays for each pixel</li>
<li>Compute ray-surface intersections analytically</li>
<li>Understand why analytical methods become challenging for complex geometry</li>
<li>Use signed distance functions as an alternative representation</li>
<li>Implement the raymarching algorithm (sphere tracing)</li>
<li>Build scenes with multiple objects and materials</li>
</ul>
</div>
</div>
</section>
<section id="cameras-and-rays" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="cameras-and-rays"><span class="header-section-number">1.2</span> Cameras and Rays</h2>
<p>We want to draw 3D scenes on a 2D screen. The basic question: for each pixel, what color should it be?</p>
<p>The answer comes from simulating how light reaches a camera. In the real world, light bounces around a scene and some of it enters a camera through its lens, forming an image. Simulating this fully is expensive, so we reverse the process: instead of tracing light from sources to the camera, we trace <em>rays</em> from the camera out into the scene. For each pixel, we ask: what does this ray hit, and what color is that surface?</p>
<section id="the-pinhole-camera" class="level3">
<h3 class="anchored" data-anchor-id="the-pinhole-camera">The Pinhole Camera</h3>
<p>The simplest camera model is the <strong>pinhole camera</strong>: all light enters through a single point. This means every ray passes through the same origin—the camera position. The only thing that varies from pixel to pixel is the ray’s <em>direction</em>.</p>
<p>Real cameras have lenses with finite aperture, which create depth of field and focus effects. We ignore all of that. The pinhole model is mathematically clean: one point, many directions.</p>
</section>
<section id="coordinate-system" class="level3">
<h3 class="anchored" data-anchor-id="coordinate-system">Coordinate System</h3>
<p>We need to agree on which way is “up.” We’ll use the standard graphics convention:</p>
<ul>
<li><strong>Y-axis</strong> points up</li>
<li><strong>Z-axis</strong> points toward the camera (out of the screen)</li>
<li><strong>X-axis</strong> points right</li>
<li>Right-handed coordinate system</li>
</ul>
<p>Our camera sits at the origin, looking down the negative Z-axis. The scene lives in front of the camera, at negative Z values.</p>
</section>
<section id="rays" class="level3">
<h3 class="anchored" data-anchor-id="rays">Rays</h3>
<p>A ray is a half-line: it starts at a point and extends infinitely in one direction. We parameterize it as:</p>
<p><span class="math display">\[\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}\]</span></p>
<p>where <span class="math inline">\(\mathbf{o}\)</span> is the <strong>origin</strong> (camera position), <span class="math inline">\(\mathbf{d}\)</span> is the <strong>direction</strong> (unit vector), and <span class="math inline">\(t \geq 0\)</span> is the parameter. Points with <span class="math inline">\(t &gt; 0\)</span> lie in front of the camera; <span class="math inline">\(t = 0\)</span> is the camera itself.</p>
<p>A ray has two parts: where it starts and where it points. We bundle these into a struct:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Ray <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> origin<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> dir<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>For our pinhole camera, the origin is the same for every ray—the camera position at <span class="math inline">\((0, 0, 0)\)</span>. Only the direction varies, depending on which pixel we’re computing.</p>
</section>
<section id="field-of-view" class="level3">
<h3 class="anchored" data-anchor-id="field-of-view">Field of View</h3>
<p>The <strong>field of view</strong> (FOV) controls how wide the camera sees. To understand it precisely, imagine an <strong>image plane</strong> sitting at distance <span class="math inline">\(f\)</span> in front of the camera (at <span class="math inline">\(z = -f\)</span>). We set up coordinates so the visible portion of this plane spans <span class="math inline">\([-1, 1]\)</span> in both <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>. Each pixel maps to a point on this plane, and the ray direction is the vector from the camera through that point.</p>
<!-- TODO: figure showing camera at origin, image plane at z=-f, ray to corner -->
<p>The FOV is the angle between rays hitting opposite edges of the screen. Half that angle, <span class="math inline">\(\theta = \text{FOV}/2\)</span>, is the angle from the center ray to the edge. A ray to the top edge of the image plane reaches the point <span class="math inline">\((0, 1, -f)\)</span>, forming a right triangle with opposite side 1 and adjacent side <span class="math inline">\(f\)</span>. So <span class="math inline">\(\tan(\theta) = 1/f\)</span>, giving us:</p>
<p><span class="math display">\[f = \frac{1}{\tan(\text{FOV}/2)}\]</span></p>
<p>The intuition: a wide FOV means the image plane is close, so rays spread out sharply. A narrow FOV means the image plane is far, so rays stay nearly parallel—like a telephoto lens.</p>
</section>
<section id="generating-rays" class="level3">
<h3 class="anchored" data-anchor-id="generating-rays">Generating Rays</h3>
<p>For a pixel at screen position <code>fragCoord</code>, we compute its ray in three steps:</p>
<ol type="1">
<li><strong>Normalize</strong> pixel coordinates to <span class="math inline">\([-1, 1]^2\)</span></li>
<li><strong>Correct</strong> for aspect ratio so circles render as circles</li>
<li><strong>Form</strong> the direction vector toward the image plane and normalize it</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Ray <span class="fu">generateRay</span><span class="op">(</span><span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Map pixel coordinates to [-1, 1]</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Correct for aspect ratio</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Focal length from field of view</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">90.0</span><span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> f <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    Ray ray<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">origin</span> <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">dir</span> <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">,</span> <span class="op">-</span>f<span class="op">));</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ray<span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The direction’s <span class="math inline">\(z\)</span>-component is <span class="math inline">\(-f\)</span> because we’re looking down the negative Z-axis. The <code>normalize</code> ensures our direction is a unit vector, which simplifies intersection calculations later.</p>
</section>
<section id="visualizing-rays" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-rays">Visualizing Rays</h3>
<p>Let’s verify our setup by coloring each pixel according to its ray direction:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/ray-visualization</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Ray <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> origin<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> dir<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>Ray <span class="fu">generateRay</span><span class="op">(</span><span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>fragCoord <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2.0</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">x</span> <span class="op">*=</span> iResolution<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> iResolution<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> fov <span class="op">=</span> <span class="fl">90.0</span><span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> f <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">tan</span><span class="op">(</span><span class="bu">radians</span><span class="op">(</span>fov<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    Ray ray<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">origin</span> <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">dir</span> <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>uv<span class="op">,</span> <span class="op">-</span>f<span class="op">));</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ray<span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Map direction components from [-1,1] to [0,1] for display</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color <span class="op">=</span> ray<span class="op">.</span><span class="fu">dir</span> <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The center of the screen is bluish (ray pointing straight into <span class="math inline">\(-Z\)</span>), while the edges shift toward red and green (larger <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> components). This gradient confirms our rays fan out correctly from the camera.</p>
</section>
</section>
<section id="raytracing" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="raytracing"><span class="header-section-number">1.3</span> Raytracing</h2>
<p>We have rays. Now we need to find where they hit things.</p>
<p>The core problem: given a ray <span class="math inline">\(\mathbf{r}(t) = \mathbf{o} + t\mathbf{d}\)</span> and a surface, find the value of <span class="math inline">\(t\)</span> where they intersect. Once we know the intersection point, we can compute its color based on lighting and material properties.</p>
<section id="intersection" class="level3">
<h3 class="anchored" data-anchor-id="intersection">Intersection</h3>
<p>We’ll start with the simplest 3D shape: a sphere. A sphere of radius <span class="math inline">\(r\)</span> centered at <span class="math inline">\(\mathbf{c}\)</span> is the set of points satisfying:</p>
<p><span class="math display">\[|\mathbf{p} - \mathbf{c}|^2 = r^2\]</span></p>
<p>To find where our ray intersects this sphere, we substitute the ray equation for <span class="math inline">\(\mathbf{p}\)</span>:</p>
<p><span class="math display">\[|\mathbf{o} + t\mathbf{d} - \mathbf{c}|^2 = r^2\]</span></p>
<p>Let <span class="math inline">\(\boldsymbol{\delta} = \mathbf{o} - \mathbf{c}\)</span> be the vector from the sphere’s center to the ray’s origin. Expanding:</p>
<p><span class="math display">\[|\boldsymbol{\delta} + t\mathbf{d}|^2 = r^2\]</span> <span class="math display">\[|\boldsymbol{\delta}|^2 + 2t(\boldsymbol{\delta} \cdot \mathbf{d}) + t^2|\mathbf{d}|^2 = r^2\]</span></p>
<p>Since <span class="math inline">\(\mathbf{d}\)</span> is a unit vector, <span class="math inline">\(|\mathbf{d}|^2 = 1\)</span>. Rearranging into standard quadratic form <span class="math inline">\(at^2 + bt + c = 0\)</span>:</p>
<p><span class="math display">\[t^2 + 2(\boldsymbol{\delta} \cdot \mathbf{d})t + (|\boldsymbol{\delta}|^2 - r^2) = 0\]</span></p>
<p>The discriminant <span class="math inline">\(\Delta = b^2 - 4ac\)</span> tells us how many solutions exist:</p>
<ul>
<li><span class="math inline">\(\Delta &lt; 0\)</span>: no intersection (ray misses the sphere)</li>
<li><span class="math inline">\(\Delta = 0\)</span>: one intersection (ray grazes the sphere)</li>
<li><span class="math inline">\(\Delta &gt; 0\)</span>: two intersections (ray enters and exits)</li>
</ul>
<p>When <span class="math inline">\(\Delta \geq 0\)</span>, we get:</p>
<p><span class="math display">\[t = -(\boldsymbol{\delta} \cdot \mathbf{d}) \pm \sqrt{(\boldsymbol{\delta} \cdot \mathbf{d})^2 - |\boldsymbol{\delta}|^2 + r^2}\]</span></p>
<p>We want the smallest positive <span class="math inline">\(t\)</span> — the first intersection in front of the camera.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">intersectSphere</span><span class="op">(</span>Ray ray<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> delta <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">-</span> center<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> b <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>delta<span class="op">,</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>delta<span class="op">,</span> delta<span class="op">)</span> <span class="op">-</span> radius <span class="op">*</span> radius<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> discriminant <span class="op">=</span> b <span class="op">*</span> b <span class="op">-</span> c<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>discriminant <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>  <span class="co">// No intersection</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sqrtDisc <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>discriminant<span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t1 <span class="op">=</span> <span class="op">-</span>b <span class="op">-</span> sqrtDisc<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t2 <span class="op">=</span> <span class="op">-</span>b <span class="op">+</span> sqrtDisc<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> t1<span class="op">;</span>  <span class="co">// First intersection in front</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> t2<span class="op">;</span>  <span class="co">// We're inside the sphere</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>              <span class="co">// Sphere is behind us</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We return <span class="math inline">\(-1\)</span> as a sentinel value meaning “no intersection.” Since valid hits have <span class="math inline">\(t &gt; 0\)</span> (the intersection is in front of the camera), any negative value would work — <span class="math inline">\(-1\)</span> is just conventional. When we use this function, we check <code>if (t &gt; 0.0)</code> to see if we hit anything.</p>
<p>Let’s test it:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/sphere-flat</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> sphereCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphereRadius <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectSphere</span><span class="op">(</span>ray<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span>  <span class="co">// Red</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ray missed - background color</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>It works — but it looks like a flat red disk! We can’t see the sphere’s curvature because every hit pixel gets the same color. We need lighting.</p>
</section>
<section id="surface-normals" class="level3">
<h3 class="anchored" data-anchor-id="surface-normals">Surface Normals</h3>
<p>Lighting depends on how a surface is oriented relative to the light. The <strong>surface normal</strong> is a unit vector perpendicular to the surface at a given point. For a sphere, the normal at point <span class="math inline">\(\mathbf{p}\)</span> points directly away from the center:</p>
<p><span class="math display">\[\mathbf{n} = \frac{\mathbf{p} - \mathbf{c}}{r}\]</span></p>
<p>This is just the direction from the center to the surface, normalized.</p>
<p>We can visualize the normals by mapping them to colors, just like we did with ray directions:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/sphere-normals</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> sphereCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphereRadius <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectSphere</span><span class="op">(</span>ray<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="op">(</span>hitPoint <span class="op">-</span> sphereCenter<span class="op">)</span> <span class="op">/</span> sphereRadius<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> normal <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">;</span>  <span class="co">// Map [-1,1] to [0,1]</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ray missed - background color</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now we see the sphere’s shape! The normal points right (red) on the right side, up (green) on top, and toward us (blue) in the center. This is exactly the information we need for lighting.</p>
</section>
<section id="lighting" class="level3">
<h3 class="anchored" data-anchor-id="lighting">Lighting</h3>
<section id="diffuse" class="level4">
<h4 class="anchored" data-anchor-id="diffuse">Diffuse</h4>
<p>A matte surface scatters incoming light equally in all directions. The brightness depends only on the angle between the surface normal and the light direction: when light hits head-on, the surface is bright; when light hits at a glancing angle, less energy is deposited and the surface is dim.</p>
<p>This is <strong>Lambertian</strong> shading. If <span class="math inline">\(\mathbf{n}\)</span> is the surface normal and <span class="math inline">\(\mathbf{l}\)</span> is the direction toward the light, the brightness is:</p>
<p><span class="math display">\[I_{\text{diffuse}} = \max(0, \mathbf{n} \cdot \mathbf{l})\]</span></p>
<p>The <span class="math inline">\(\max\)</span> ensures surfaces facing away from the light don’t go negative.</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/sphere-diffuse</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scene</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> sphereCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphereRadius <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectSphere</span><span class="op">(</span>ray<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Compute hit point and normal</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="op">(</span>hitPoint <span class="op">-</span> sphereCenter<span class="op">)</span> <span class="op">/</span> sphereRadius<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Lighting</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span>  <span class="co">// Direction toward light</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Shading</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> sphereColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> ambient <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> sphereColor <span class="op">*</span> <span class="op">(</span>ambient <span class="op">+</span> diffuse<span class="op">);</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ray missed - background color</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now the sphere looks 3D! The side facing the light is bright, and it falls off smoothly into shadow. We’ve added a small <strong>ambient</strong> term (0.1) so the dark side isn’t completely black — in the real world, indirect light would fill in the shadows.</p>
</section>
<section id="specular" class="level4">
<h4 class="anchored" data-anchor-id="specular">Specular</h4>
<p>Shiny surfaces have <strong>highlights</strong> — bright spots where light reflects directly toward the viewer. This is <strong>specular</strong> reflection.</p>
<p>The Phong model computes specular highlights by comparing the reflection direction to the view direction. If <span class="math inline">\(\mathbf{r}\)</span> is the light direction reflected about the normal, and <span class="math inline">\(\mathbf{v}\)</span> is the direction toward the camera, then:</p>
<p><span class="math display">\[I_{\text{specular}} = \max(0, \mathbf{r} \cdot \mathbf{v})^n\]</span></p>
<p>The exponent <span class="math inline">\(n\)</span> controls how tight the highlight is: large <span class="math inline">\(n\)</span> gives a small, sharp highlight (like polished metal); small <span class="math inline">\(n\)</span> gives a broad, soft highlight (like plastic).</p>
<p>GLSL has a built-in <code>reflect</code> function: <code>reflect(-lightDir, normal)</code> gives the reflection of the incoming light direction about the normal.</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/sphere-lit</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scene</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> sphereCenter <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphereRadius <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectSphere</span><span class="op">(</span>ray<span class="op">,</span> sphereCenter<span class="op">,</span> sphereRadius<span class="op">);</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Compute hit point and normal</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="op">(</span>hitPoint <span class="op">-</span> sphereCenter<span class="op">)</span> <span class="op">/</span> sphereRadius<span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Directions</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span>  <span class="co">// Toward light</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> viewDir <span class="op">=</span> <span class="op">-</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span>                         <span class="co">// Toward camera</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectDir <span class="op">=</span> <span class="bu">reflect</span><span class="op">(-</span>lightDir<span class="op">,</span> normal<span class="op">);</span>    <span class="co">// Light reflected about normal</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Diffuse: brightness based on angle to light</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Specular: bright spot where reflection aligns with view</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> shininess <span class="op">=</span> <span class="fl">32.0</span><span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> specular <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>reflectDir<span class="op">,</span> viewDir<span class="op">)),</span> shininess<span class="op">);</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Combine lighting</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> sphereColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> ambient <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> sphereColor <span class="op">*</span> <span class="op">(</span>ambient <span class="op">+</span> diffuse<span class="op">)</span> <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> specular <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ray missed - background color</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The sphere now has a shiny highlight! Try changing the shininess from 32 to other values — 8 gives a soft plastic look, 128 gives a tight metallic gleam.</p>
</section>
</section>
</section>
<section id="the-limits-of-analytical-methods" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="the-limits-of-analytical-methods"><span class="header-section-number">1.4</span> The Limits of Analytical Methods</h2>
<p>The sphere worked beautifully: substitute the ray equation, get a quadratic, solve with a formula you learned in high school. What about other shapes?</p>
<section id="the-torus" class="level3">
<h3 class="anchored" data-anchor-id="the-torus">The Torus</h3>
<p>A torus is the surface you get by revolving a circle around an axis — a donut shape. It’s defined by two radii: the <strong>major radius</strong> <span class="math inline">\(R\)</span> (distance from the center of the torus to the center of the tube) and the <strong>minor radius</strong> <span class="math inline">\(r\)</span> (the radius of the tube itself).</p>
<!-- TODO: figure showing torus with R and r labeled -->
<p>The implicit equation for a torus centered at the origin with the axis along <span class="math inline">\(Y\)</span> is:</p>
<p><span class="math display">\[\left(\sqrt{x^2 + z^2} - R\right)^2 + y^2 = r^2\]</span></p>
<p>The inner square root computes the distance from the Y-axis; subtracting <span class="math inline">\(R\)</span> gives the distance from the “core circle” of the torus; that quantity squared plus <span class="math inline">\(y^2\)</span> equals <span class="math inline">\(r^2\)</span> defines a tube of radius <span class="math inline">\(r\)</span> around that core.</p>
</section>
<section id="ray-torus-intersection" class="level3">
<h3 class="anchored" data-anchor-id="ray-torus-intersection">Ray-Torus Intersection</h3>
<p>To find where a ray hits this surface, we substitute <span class="math inline">\(\mathbf{p} = \mathbf{o} + t\mathbf{d}\)</span> as before. The square root makes this awkward, so we first isolate and square it:</p>
<p><span class="math display">\[\sqrt{x^2 + z^2} = R \pm \sqrt{r^2 - y^2}\]</span></p>
<p>After substituting the ray equation and squaring twice to eliminate the radicals, we get a <strong>quartic polynomial</strong> in <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[a_4 t^4 + a_3 t^3 + a_2 t^2 + a_1 t + a_0 = 0\]</span></p>
<p>The coefficients <span class="math inline">\(a_i\)</span> are complicated expressions involving the ray origin, direction, and the two radii. Unlike the quadratic case, there’s no simple formula you can memorize. Solving a quartic requires either:</p>
<ul>
<li>The <a href="https://en.wikipedia.org/wiki/Quartic_function#General_formula_for_roots">quartic formula</a> (which exists but is unwieldy), or</li>
<li>Numerical methods (Newton’s method, bisection), or</li>
<li>Clever algebraic manipulation to reduce it to simpler equations</li>
</ul>
<p>Inigo Quilez, the creator of Shadertoy, worked out an elegant analytical solution. Here it is:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Torus intersection by Inigo Quilez</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">// https://iquilezles.org/articles/intersectors/</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">intersectTorus</span><span class="op">(</span>Ray ray<span class="op">,</span> <span class="dt">vec2</span> tor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> po <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Ra2 <span class="op">=</span> tor<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> tor<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> ra2 <span class="op">=</span> tor<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> m <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>ray<span class="op">.</span><span class="fu">origin</span><span class="op">,</span> ray<span class="op">.</span><span class="fu">origin</span><span class="op">);</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> n <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>ray<span class="op">.</span><span class="fu">origin</span><span class="op">,</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bounding sphere check</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> h <span class="op">=</span> n<span class="op">*</span>n <span class="op">-</span> m <span class="op">+</span> <span class="op">(</span>tor<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>tor<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find quartic coefficients</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k <span class="op">=</span> <span class="op">(</span>m <span class="op">-</span> ra2 <span class="op">-</span> Ra2<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k3 <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k2 <span class="op">=</span> n<span class="op">*</span>n <span class="op">+</span> Ra2<span class="op">*</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">.</span><span class="fu">z</span><span class="op">*</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">.</span><span class="fu">z</span> <span class="op">+</span> k<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k1 <span class="op">=</span> k<span class="op">*</span>n <span class="op">+</span> Ra2<span class="op">*</span>ray<span class="op">.</span><span class="fu">origin</span><span class="op">.</span><span class="fu">z</span><span class="op">*</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> k0 <span class="op">=</span> k<span class="op">*</span>k <span class="op">+</span> Ra2<span class="op">*</span>ray<span class="op">.</span><span class="fu">origin</span><span class="op">.</span><span class="fu">z</span><span class="op">*</span>ray<span class="op">.</span><span class="fu">origin</span><span class="op">.</span><span class="fu">z</span> <span class="op">-</span> Ra2<span class="op">*</span>ra2<span class="op">;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prevent numerical issues</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>k3<span class="op">*(</span>k3<span class="op">*</span>k3 <span class="op">-</span> k2<span class="op">)</span> <span class="op">+</span> k1<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        po <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> tmp <span class="op">=</span> k1<span class="op">;</span> k1 <span class="op">=</span> k3<span class="op">;</span> k3 <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        k0 <span class="op">=</span> <span class="fl">1.0</span><span class="op">/</span>k0<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        k1 <span class="op">=</span> k1<span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        k2 <span class="op">=</span> k2<span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        k3 <span class="op">=</span> k3<span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c2 <span class="op">=</span> <span class="fl">2.0</span><span class="op">*</span>k2 <span class="op">-</span> <span class="fl">3.0</span><span class="op">*</span>k3<span class="op">*</span>k3<span class="op">;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c1 <span class="op">=</span> k3<span class="op">*(</span>k3<span class="op">*</span>k3 <span class="op">-</span> k2<span class="op">)</span> <span class="op">+</span> k1<span class="op">;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c0 <span class="op">=</span> k3<span class="op">*(</span>k3<span class="op">*(-</span><span class="fl">3.0</span><span class="op">*</span>k3<span class="op">*</span>k3 <span class="op">+</span> <span class="fl">4.0</span><span class="op">*</span>k2<span class="op">)</span> <span class="op">-</span> <span class="fl">8.0</span><span class="op">*</span>k1<span class="op">)</span> <span class="op">+</span> <span class="fl">4.0</span><span class="op">*</span>k0<span class="op">;</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    c2 <span class="op">/=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">*=</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">/=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Q <span class="op">=</span> c2<span class="op">*</span>c2 <span class="op">+</span> c0<span class="op">;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> R <span class="op">=</span> <span class="fl">3.0</span><span class="op">*</span>c0<span class="op">*</span>c2 <span class="op">-</span> c2<span class="op">*</span>c2<span class="op">*</span>c2 <span class="op">-</span> c1<span class="op">*</span>c1<span class="op">;</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> h2 <span class="op">=</span> R<span class="op">*</span>R <span class="op">-</span> Q<span class="op">*</span>Q<span class="op">*</span>Q<span class="op">;</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h2 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4 intersections</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> sQ <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>Q<span class="op">);</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="fl">2.0</span><span class="op">*</span>sQ<span class="op">*</span><span class="bu">cos</span><span class="op">(</span><span class="bu">acos</span><span class="op">(</span>R<span class="op">/(</span>sQ<span class="op">*</span>Q<span class="op">))</span> <span class="op">/</span> <span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2 intersections</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> sQ <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">sqrt</span><span class="op">(</span>h2<span class="op">)</span> <span class="op">+</span> <span class="bu">abs</span><span class="op">(</span>R<span class="op">),</span> <span class="fl">1.0</span><span class="op">/</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="bu">sign</span><span class="op">(</span>R<span class="op">)*</span><span class="bu">abs</span><span class="op">(</span>sQ <span class="op">+</span> Q<span class="op">/</span>sQ<span class="op">);</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> c2 <span class="op">-</span> z<span class="op">;</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d1 <span class="op">=</span> z <span class="op">-</span> <span class="fl">3.0</span><span class="op">*</span>c2<span class="op">;</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d2 <span class="op">=</span> z<span class="op">*</span>z <span class="op">-</span> <span class="fl">3.0</span><span class="op">*</span>c0<span class="op">;</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>d1<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1.0e-4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>d2 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>d2<span class="op">);</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>d1 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        d1 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>d1<span class="op">/</span><span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> c1<span class="op">/</span>d1<span class="op">;</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> result <span class="op">=</span> <span class="fl">1e20</span><span class="op">;</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> d1<span class="op">*</span>d1 <span class="op">-</span> z <span class="op">+</span> d2<span class="op">;</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>h2<span class="op">);</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t1 <span class="op">=</span> <span class="op">-</span>d1 <span class="op">-</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t2 <span class="op">=</span> <span class="op">-</span>d1 <span class="op">+</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>        t1 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t1 <span class="op">:</span> t1<span class="op">;</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>        t2 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t2 <span class="op">:</span> t2<span class="op">;</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> t1<span class="op">;</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>result<span class="op">,</span> t2<span class="op">);</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> d1<span class="op">*</span>d1 <span class="op">-</span> z <span class="op">-</span> d2<span class="op">;</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>h2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>h2<span class="op">);</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t1 <span class="op">=</span> d1 <span class="op">-</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> t2 <span class="op">=</span> d1 <span class="op">+</span> h2 <span class="op">-</span> k3<span class="op">;</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>        t1 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t1 <span class="op">:</span> t1<span class="op">;</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        t2 <span class="op">=</span> <span class="op">(</span>po <span class="op">&lt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">?</span> <span class="fl">2.0</span><span class="op">/</span>t2 <span class="op">:</span> t2<span class="op">;</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t1 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>result<span class="op">,</span> t1<span class="op">);</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> result <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>result<span class="op">,</span> t2<span class="op">);</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span>result <span class="op">&gt;</span> <span class="fl">1e10</span><span class="op">)</span> <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> result<span class="op">;</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>That’s about 80 lines to intersect a ray with a torus. Compare that to the 15 lines for a sphere.</p>
</section>
<section id="torus-normal" class="level3">
<h3 class="anchored" data-anchor-id="torus-normal">Torus Normal</h3>
<p>For lighting, we need the surface normal. For any implicit surface <span class="math inline">\(F(\mathbf{p}) = 0\)</span>, the normal is the gradient of <span class="math inline">\(F\)</span>, normalized:</p>
<p><span class="math display">\[\mathbf{n} = \frac{\nabla F}{|\nabla F|}\]</span></p>
<p>For the torus, this works out to:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">torusNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec2</span> tor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> R <span class="op">=</span> tor<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> denom <span class="op">=</span> <span class="bu">sqrt</span><span class="op">(</span>p<span class="op">.</span><span class="fu">x</span><span class="op">*</span>p<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> p<span class="op">.</span><span class="fu">y</span><span class="op">*</span>p<span class="op">.</span><span class="fu">y</span><span class="op">);</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> R<span class="op">/</span>denom<span class="op">),</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> R<span class="op">/</span>denom<span class="op">),</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span><span class="fu">z</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">));</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="putting-it-together" class="level3">
<h3 class="anchored" data-anchor-id="putting-it-together">Putting It Together</h3>
<p>With intersection and normal in hand, we can render a lit torus:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/torus-analytical</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Torus parameters: (major radius, minor radius)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> torus <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">);</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Move torus in front of camera</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">origin</span><span class="op">.</span><span class="fu">z</span> <span class="op">+=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">intersectTorus</span><span class="op">(</span>ray<span class="op">,</span> torus<span class="op">);</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">torusNormal</span><span class="op">(</span>hitPoint<span class="op">,</span> torus<span class="op">);</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Lighting (same as sphere)</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> viewDir <span class="op">=</span> <span class="op">-</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectDir <span class="op">=</span> <span class="bu">reflect</span><span class="op">(-</span>lightDir<span class="op">,</span> normal<span class="op">);</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> specular <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>reflectDir<span class="op">,</span> viewDir<span class="op">)),</span> <span class="fl">32.0</span><span class="op">);</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> torusColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> ambient <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> torusColor <span class="op">*</span> <span class="op">(</span>ambient <span class="op">+</span> diffuse<span class="op">)</span> <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> specular <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>It works! The torus renders correctly with proper lighting and that satisfying donut shape.</p>
<p>To see the torus from different angles, let’s make it rotate. We’ll explore how to animate and transform objects in the exercises.</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/torus-rotating</code> not found.</div>
</div>

</section>
<section id="the-tradeoff" class="level3">
<h3 class="anchored" data-anchor-id="the-tradeoff">The Tradeoff</h3>
<p>Analytical ray intersection gives exact results and can be very fast — there’s no iteration, just direct computation. For mathematical visualization, where precision matters and you’re rendering well-understood algebraic surfaces, this approach is sometimes exactly what you want.</p>
<p>But the complexity grows quickly with the degree of the surface. A sphere (degree 2) gives a quadratic. A torus (degree 4) gives a quartic. Higher-degree surfaces require solving higher-degree polynomials, and combining multiple objects requires even more sophisticated algebra.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>What About Meshes?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The other major approach in computer graphics is to approximate surfaces with <strong>triangle meshes</strong> — thousands or millions of tiny triangles. This is still intersection-based: we write a ray-triangle intersection routine (which is a simple linear system), then test every triangle. Clever data structures (BVHs, k-d trees) make it fast to find which triangles a ray might hit without testing all of them.</p>
<p>This is how most video games and production renderers work. But it requires having mesh data — vertices, faces, connectivity — which is a lot of infrastructure. For mathematical visualization, where we work with implicit surfaces and procedural geometry, SDFs and raymarching are more natural. We define shapes with equations, not polygon soup.</p>
</div>
</div>
<p>In the next section, we’ll see a different approach that trades some precision for dramatic simplicity.</p>
</section>
</section>
<section id="signed-distance-functions" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="signed-distance-functions"><span class="header-section-number">1.5</span> Signed Distance Functions</h2>
<p>We’ve seen that analytical intersection works but scales poorly with geometric complexity. The core problem is that we’re asking a hard question: “where exactly does this ray hit the surface?” For a sphere, that’s a quadratic equation. For a torus, a quartic. For more complex surfaces, the algebra becomes intractable.</p>
<p>What if we asked an easier question instead?</p>
<section id="a-different-approach" class="level3">
<h3 class="anchored" data-anchor-id="a-different-approach">A Different Approach</h3>
<p>Suppose we have a function that, given any point <span class="math inline">\(\mathbf{p}\)</span> in space, tells us the distance to the nearest surface. Not <em>which</em> surface, not <em>where</em> on the surface — just how far.</p>
<p>Now imagine walking along a ray from the camera. At each step, we ask: “how far is the surface from here?” If the answer is <span class="math inline">\(d\)</span>, we know it’s safe to step forward by <span class="math inline">\(d\)</span> — we can’t possibly hit anything closer than that. So we step forward, ask again, step again. Eventually one of two things happens:</p>
<ul>
<li>The distance gets very small — we’ve arrived at the surface</li>
<li>We’ve walked very far without hitting anything — the ray misses</li>
</ul>
<p>This is <strong>raymarching</strong>. Instead of solving for the exact intersection, we iterate our way there. And the function that answers “how far to the surface?” is called a <strong>signed distance function</strong> (SDF).</p>
</section>
<section id="definition" class="level3">
<h3 class="anchored" data-anchor-id="definition">Definition</h3>
<p>A signed distance function maps every point in space to a number:</p>
<p><span class="math display">\[d(\mathbf{p}) = \begin{cases}
&gt; 0 &amp; \text{outside the surface} \\
= 0 &amp; \text{on the surface} \\
&lt; 0 &amp; \text{inside the surface}
\end{cases}\]</span></p>
<p>The magnitude <span class="math inline">\(|d(\mathbf{p})|\)</span> is the Euclidean distance to the nearest point on the surface. The sign tells you which side you’re on.</p>
<p>The sign matters because surfaces have an inside and an outside. When raymarching, we typically start outside an object and walk until we reach the surface (where <span class="math inline">\(d \approx 0\)</span>). But the sign also lets us do things like carve holes in objects or detect when the camera is inside something.</p>
</section>
<section id="visualizing-sdfs" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-sdfs">Visualizing SDFs</h3>
<p>Before we use SDFs for 3D rendering, let’s build intuition in 2D. We can visualize an SDF by coloring the plane according to distance: one color outside, another inside, with contour lines showing level sets.</p>
<p>The simplest SDF is a circle of radius <span class="math inline">\(r\)</span> centered at the origin:</p>
<p><span class="math display">\[d(\mathbf{p}) = |\mathbf{p}| - r\]</span></p>
<p>If you’re at distance <span class="math inline">\(|\mathbf{p}|\)</span> from the origin, your signed distance to the circle is how much farther (positive) or closer (negative) you are than <span class="math inline">\(r\)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdCircle</span><span class="op">(</span><span class="dt">vec2</span> p<span class="op">,</span> <span class="dt">float</span> r<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p<span class="op">)</span> <span class="op">-</span> r<span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/sdf-circle-2d</code> not found.</div>
</div>

<p>The contour lines are level sets of the SDF — curves where <span class="math inline">\(d(\mathbf{p}) = k\)</span> for various values of <span class="math inline">\(k\)</span>. On the boundary (<span class="math inline">\(k = 0\)</span>), you’re exactly on the circle. The contours inside are negative; the contours outside are positive.</p>
<p>A box is more interesting. For an axis-aligned box with half-widths <span class="math inline">\((w, h)\)</span>, the SDF is:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdBox</span><span class="op">(</span><span class="dt">vec2</span> p<span class="op">,</span> <span class="dt">vec2</span> halfSize<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> d <span class="op">=</span> <span class="bu">abs</span><span class="op">(</span>p<span class="op">)</span> <span class="op">-</span> halfSize<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>d<span class="op">,</span> <span class="fl">0.0</span><span class="op">))</span> <span class="op">+</span> <span class="bu">min</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>d<span class="op">.</span><span class="fu">x</span><span class="op">,</span> d<span class="op">.</span><span class="fu">y</span><span class="op">),</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The formula has two parts: outside the box, we measure distance to the nearest corner or edge; inside, we take the largest (least negative) coordinate distance.</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/sdf-box-2d</code> not found.</div>
</div>

<p>Notice how the contour lines “round out” near the corners. The SDF doesn’t know the box has sharp corners — it just measures distance, and distance from a corner is distance from a point.</p>
</section>
<section id="d-primitives" class="level3">
<h3 class="anchored" data-anchor-id="d-primitives">3D Primitives</h3>
<p>The same idea extends to 3D. Here are SDFs for the shapes we care about:</p>
<p><strong>Sphere:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>One line. Compare to our 15-line analytical intersection.</p>
<p><strong>Torus:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdTorus</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec2</span> tor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// tor.x = major radius, tor.y = minor radius</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> q <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span><span class="bu">length</span><span class="op">(</span>p<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">-</span> tor<span class="op">.</span><span class="fu">x</span><span class="op">,</span> p<span class="op">.</span><span class="fu">z</span><span class="op">);</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>q<span class="op">)</span> <span class="op">-</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Four lines. Compare to the 80-line quartic solver.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>GLSL: Swizzling
</div>
</div>
<div class="callout-body-container callout-body">
<p>GLSL lets you extract and rearrange vector components using <strong>swizzle notation</strong>. Writing <code>p.xy</code> creates a <code>vec2</code> containing the x and y components of <code>p</code>. You can use any combination: <code>p.xz</code>, <code>p.zyx</code>, even <code>p.xxx</code>. This is handy for working with different planes — <code>length(p.xy)</code> gives the distance from the Z-axis, treating the xy-plane as 2D.</p>
</div>
</div>
<p>The logic: <code>length(p.xy) - tor.x</code> gives the distance from the central ring (a circle of radius <span class="math inline">\(R\)</span> in the xy-plane). Then we measure distance from <em>that</em> to the point, accounting for the <span class="math inline">\(z\)</span> coordinate, and subtract the tube radius.</p>
<p><strong>Box:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdBox</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> halfSize<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> d <span class="op">=</span> <span class="bu">abs</span><span class="op">(</span>p<span class="op">)</span> <span class="op">-</span> halfSize<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>d<span class="op">,</span> <span class="fl">0.0</span><span class="op">))</span> <span class="op">+</span> <span class="bu">min</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>d<span class="op">.</span><span class="fu">x</span><span class="op">,</span> <span class="bu">max</span><span class="op">(</span>d<span class="op">.</span><span class="fu">y</span><span class="op">,</span> d<span class="op">.</span><span class="fu">z</span><span class="op">)),</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Same idea as 2D, extended to three dimensions.</p>
<p><strong>Plane:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdPlane</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">float</span> height<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> p<span class="op">.</span><span class="fu">y</span> <span class="op">-</span> height<span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>A horizontal plane at <span class="math inline">\(y = h\)</span>. Points above have positive distance; points below have negative distance. This will be our ground plane.</p>
</section>
<section id="normals-from-sdfs" class="level3">
<h3 class="anchored" data-anchor-id="normals-from-sdfs">Normals from SDFs</h3>
<p>For lighting, we need surface normals. An SDF is an implicit function — the surface is the level set where <span class="math inline">\(d(\mathbf{p}) = 0\)</span>. As we saw with the torus, the gradient of an implicit function points perpendicular to its level sets. So <span class="math inline">\(\nabla d\)</span> gives us the normal direction.</p>
<p>We estimate the gradient numerically using finite differences:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">estimateNormal</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">)),</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">)),</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">sceneSDF</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">));</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This works for <em>any</em> SDF — spheres, tori, boxes, or shapes we haven’t even defined yet. We evaluate the SDF at six nearby points and see which direction it increases fastest. That’s the normal.</p>
</section>
</section>
<section id="raymarching" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="raymarching"><span class="header-section-number">1.6</span> Raymarching</h2>
<p>We’ve defined SDFs and explained the idea: march along the ray, using the distance field to take safe steps. Now let’s implement it.</p>
<section id="the-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="the-algorithm">The Algorithm</h3>
<p>Starting from the ray origin, we repeatedly:</p>
<ol type="1">
<li>Evaluate the SDF at our current position</li>
<li>Step forward along the ray by that distance</li>
<li>Check if we’re close enough to the surface (hit) or too far away (miss)</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">raymarch</span><span class="op">(</span>Ray ray<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span>  <span class="co">// Distance traveled along ray</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> p <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span>  <span class="co">// Current position</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>p<span class="op">);</span>               <span class="co">// Distance to nearest surface</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>d <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> t<span class="op">;</span>  <span class="co">// Hit: we're close enough</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span>  <span class="co">// Step forward by the safe distance</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">100.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>  <span class="co">// Miss: we've gone too far</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span>  <span class="co">// Gave up: too many steps</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The threshold <code>0.001</code> controls how close we need to get before declaring a hit — smaller means more precision but more steps. The maximum distance <code>100.0</code> and iteration count <code>100</code> are practical limits to avoid infinite loops.</p>
</section>
<section id="raymarched-sphere" class="level3">
<h3 class="anchored" data-anchor-id="raymarched-sphere">Raymarched Sphere</h3>
<p>Let’s render a sphere using raymarching instead of analytical intersection:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>With our <code>estimateNormal</code> function from the previous section and the same lighting code we used for analytical rendering:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/raymarch-sphere</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">raymarch</span><span class="op">(</span>ray<span class="op">);</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">estimateNormal</span><span class="op">(</span>hitPoint<span class="op">);</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Same lighting as before</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> viewDir <span class="op">=</span> <span class="op">-</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectDir <span class="op">=</span> <span class="bu">reflect</span><span class="op">(-</span>lightDir<span class="op">,</span> normal<span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> specular <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>reflectDir<span class="op">,</span> viewDir<span class="op">)),</span> <span class="fl">32.0</span><span class="op">);</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> sphereColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> ambient <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> sphereColor <span class="op">*</span> <span class="op">(</span>ambient <span class="op">+</span> diffuse<span class="op">)</span> <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> specular <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The result looks identical to our analytical sphere — same shape, same lighting, same specular highlight. But we found the intersection by marching, not by solving a quadratic.</p>
</section>
<section id="raymarched-torus" class="level3">
<h3 class="anchored" data-anchor-id="raymarched-torus">Raymarched Torus</h3>
<p>Now for the payoff. To render a torus, we change <em>one function</em>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdTorus</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec2</span> tor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec2</span> q <span class="op">=</span> <span class="dt">vec2</span><span class="op">(</span><span class="bu">length</span><span class="op">(</span>p<span class="op">.</span><span class="fu">xy</span><span class="op">)</span> <span class="op">-</span> tor<span class="op">.</span><span class="fu">x</span><span class="op">,</span> p<span class="op">.</span><span class="fu">z</span><span class="op">);</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>q<span class="op">)</span> <span class="op">-</span> tor<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">sdTorus</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">));</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>That’s it. The raymarching loop doesn’t change. The normal estimation doesn’t change. The lighting doesn’t change. We swap four lines of SDF code for four different lines, and:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/raymarch-torus</code> not found.</div>
</div>

<p>Compare this to the analytical torus: 80 lines of quartic algebra reduced to 4 lines of distance calculation. The raymarching framework absorbs all the complexity — we just need to answer “how far is the surface?”</p>
</section>
</section>
<section id="building-scenes" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="building-scenes"><span class="header-section-number">1.7</span> Building Scenes</h2>
<p>We can render a sphere. We can render a torus. How do we render both at once?</p>
<section id="combining-objects" class="level3">
<h3 class="anchored" data-anchor-id="combining-objects">Combining Objects</h3>
<p>The SDF tells us the distance to the nearest surface. If we have two objects, the nearest surface is whichever one is closer. So we just take the minimum:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphere <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(-</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> torus <span class="op">=</span> <span class="fu">sdTorus</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">));</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">min</span><span class="op">(</span>sphere<span class="op">,</span> torus<span class="op">);</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>That’s it. The raymarcher doesn’t change — it still asks “how far to the nearest surface?” and marches accordingly. Now “nearest surface” might be the sphere or the torus depending on where we are.</p>
<p>Adding more objects is the same pattern:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphere <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(-</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> torus <span class="op">=</span> <span class="fu">sdTorus</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">));</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> ground <span class="op">=</span> <span class="fu">sdPlane</span><span class="op">(</span>p<span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">min</span><span class="op">(</span>sphere<span class="op">,</span> <span class="bu">min</span><span class="op">(</span>torus<span class="op">,</span> ground<span class="op">));</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Constructive Solid Geometry
</div>
</div>
<div class="callout-body-container callout-body">
<p>There’s something elegant happening here. An SDF represents a shape as a function <span class="math inline">\(f: \mathbb{R}^3 \to \mathbb{R}\)</span>, where the shape is the zero set <span class="math inline">\(\{p : f(p) = 0\}\)</span>. Set operations on shapes become pointwise operations on functions:</p>
<ul>
<li><strong>Union</strong> <span class="math inline">\(A \cup B\)</span>: <span class="math inline">\(\min(f_A, f_B)\)</span></li>
<li><strong>Intersection</strong> <span class="math inline">\(A \cap B\)</span>: <span class="math inline">\(\max(f_A, f_B)\)</span></li>
<li><strong>Complement</strong> <span class="math inline">\(A^c\)</span>: <span class="math inline">\(-f_A\)</span></li>
</ul>
<p>This is <strong>constructive solid geometry</strong> (CSG) — building complex shapes from simple primitives via boolean operations. With SDFs, CSG is just arithmetic. We’ll explore intersection and subtraction in the exercises.</p>
</div>
</div>
</section>
<section id="materials" class="level3">
<h3 class="anchored" data-anchor-id="materials">Materials</h3>
<p>We can combine objects, but now everything is the same color. To shade each object differently, we need to know <em>which</em> object we hit.</p>
<p>A simple approach: track a material ID as we build the scene. When we find a new closest surface, record which object it belongs to.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Which object is closest: 1 = sphere, 2 = torus, 3 = ground</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> materialID<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d <span class="op">=</span> <span class="fl">1e10</span><span class="op">;</span>  <span class="co">// Start with large distance</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sphere</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sphere <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(-</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>sphere <span class="op">&lt;</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> sphere<span class="op">;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        materialID <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Torus</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> torus <span class="op">=</span> <span class="fu">sdTorus</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">));</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>torus <span class="op">&lt;</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> torus<span class="op">;</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        materialID <span class="op">=</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ground plane</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> ground <span class="op">=</span> <span class="fu">sdPlane</span><span class="op">(</span>p<span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>ground <span class="op">&lt;</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> ground<span class="op">;</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        materialID <span class="op">=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> d<span class="op">;</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then we look up the color based on the ID:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">getMaterialColor</span><span class="op">(</span><span class="dt">float</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>id <span class="op">&lt;</span> <span class="fl">1.5</span><span class="op">)</span> <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span>  <span class="co">// Sphere: red</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>id <span class="op">&lt;</span> <span class="fl">2.5</span><span class="op">)</span> <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span>  <span class="co">// Torus: cyan</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">);</span>                 <span class="co">// Ground: gray</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This pattern — a global variable modified inside <code>sceneSDF</code> — isn’t the most elegant. It’s a side effect hidden inside what looks like a pure function. But it’s simple, it’s the common idiom in Shadertoy, and it works. For a cleaner approach, you could return a struct containing both distance and material ID; we’ll explore this in the exercises.</p>
</section>
<section id="a-complete-scene" class="level3">
<h3 class="anchored" data-anchor-id="a-complete-scene">A Complete Scene</h3>
<p>Putting it all together:</p>
<div class="callout callout-warning">
  <div class="callout-header">Missing Demo</div>
  <div class="callout-body">Shader demo <code>day4/scene-multi</code> not found.</div>
</div>

<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">mainImage</span><span class="op">(</span><span class="dt">out</span> <span class="dt">vec4</span> fragColor<span class="op">,</span> <span class="dt">in</span> <span class="dt">vec2</span> fragCoord<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">origin</span><span class="op">.</span><span class="fu">z</span> <span class="op">+=</span> <span class="fl">5.0</span><span class="op">;</span>  <span class="co">// Move camera back</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    ray<span class="op">.</span><span class="fu">origin</span><span class="op">.</span><span class="fu">y</span> <span class="op">+=</span> <span class="fl">1.0</span><span class="op">;</span>  <span class="co">// Move camera up</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fu">raymarch</span><span class="op">(</span>ray<span class="op">);</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> color<span class="op">;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> hitPoint <span class="op">=</span> ray<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> normal <span class="op">=</span> <span class="fu">estimateNormal</span><span class="op">(</span>hitPoint<span class="op">);</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Lighting</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> viewDir <span class="op">=</span> <span class="op">-</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectDir <span class="op">=</span> <span class="bu">reflect</span><span class="op">(-</span>lightDir<span class="op">,</span> normal<span class="op">);</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> specular <span class="op">=</span> <span class="bu">pow</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>reflectDir<span class="op">,</span> viewDir<span class="op">)),</span> <span class="fl">32.0</span><span class="op">);</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> matColor <span class="op">=</span> <span class="fu">getMaterialColor</span><span class="op">(</span>materialID<span class="op">);</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> ambient <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> matColor <span class="op">*</span> <span class="op">(</span>ambient <span class="op">+</span> diffuse<span class="op">)</span> <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> specular <span class="op">*</span> <span class="fl">0.3</span><span class="op">;</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    fragColor <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Three objects, three colors, one unified raymarching framework. Adding more objects is just more calls to <code>min()</code>.</p>
</section>
</section>
<section id="exercises" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="exercises"><span class="header-section-number">1.8</span> Exercises</h2>
<section id="checkpoints" class="level3">
<h3 class="anchored" data-anchor-id="checkpoints">Checkpoints</h3>
<p>These exercises verify your understanding of the core concepts. Each one should take just a few minutes.</p>
<p><strong>Checkpoint 1: Move the Sphere</strong></p>
<p>In the raymarched sphere demo (A10), the sphere is centered at <code>vec3(0.0, 0.0, -3.0)</code>. Move it to the right by changing the center to <code>vec3(1.0, 0.0, -3.0)</code>. Then try moving it up, down, closer, farther. What happens if you move it behind the camera (positive z)?</p>
<p><strong>Checkpoint 2: Torus Proportions</strong></p>
<p>In the raymarched torus demo (A11), the torus has major radius 1.0 and minor radius 0.4. Try:</p>
<ul>
<li>A thin ring: <code>vec2(1.0, 0.1)</code></li>
<li>A fat donut: <code>vec2(1.0, 0.8)</code></li>
<li>A small tight ring: <code>vec2(0.5, 0.2)</code></li>
</ul>
<p>What happens when the minor radius exceeds the major radius?</p>
<p><strong>Checkpoint 3: Add an Object</strong></p>
<p>In the multi-object scene (A12), add a second sphere on the right side of the scene. You’ll need to:</p>
<ol type="1">
<li>Add the SDF evaluation</li>
<li>Check if it’s the closest surface</li>
<li>Assign it a new material ID (4.0)</li>
<li>Add a color for material 4 in <code>getMaterialColor</code></li>
</ol>
<p><strong>Checkpoint 4: Change the Palette</strong></p>
<p>In the multi-object scene (A12), change the color scheme. Try:</p>
<ul>
<li>A sunset palette: orange sphere, pink torus, dark purple ground</li>
<li>A nature palette: green sphere, brown torus, tan ground</li>
<li>Your own palette</li>
</ul>
<p><strong>Checkpoint 5: Move the Light</strong></p>
<p>The light direction is <code>normalize(vec3(1.0, 1.0, 1.0))</code> — coming from the upper-right-front. Try:</p>
<ul>
<li>Light from directly above: <code>vec3(0.0, 1.0, 0.0)</code></li>
<li>Light from the left: <code>vec3(-1.0, 0.5, 0.5)</code></li>
<li>Light from behind the camera: <code>vec3(0.0, 0.0, 1.0)</code></li>
</ul>
<p>How does the shading change? Where do the specular highlights move?</p>
<p><strong>Checkpoint 6: Field of View</strong></p>
<p>In <code>generateRay</code>, the FOV is set to 90 degrees. Try:</p>
<ul>
<li>Wide angle (120°): objects appear smaller, more of the scene is visible</li>
<li>Telephoto (30°): objects appear larger, zoomed in, less distortion</li>
</ul>
<p>What FOV feels most natural to you?</p>
</section>
<section id="explorations" class="level3">
<h3 class="anchored" data-anchor-id="explorations">Explorations</h3>
<p>These exercises go deeper into specific topics. Each one might take 15-30 minutes.</p>
<p><strong>Exploration 1: Two Lights</strong></p>
<p>Add a second light source to the scene. You’ll need to:</p>
<ol type="1">
<li>Define a second light direction (try <code>normalize(vec3(-1.0, 0.5, -0.5))</code> for a fill light)</li>
<li>Compute diffuse and specular for both lights</li>
<li>Add the contributions together</li>
</ol>
<p>For a nice effect, make the main light white and the fill light slightly colored (e.g., multiply by <code>vec3(0.3, 0.3, 0.5)</code> for a cool fill). This is a common technique in photography and film: a warm key light with a cool fill.</p>
<p><strong>Exploration 2: Fog</strong></p>
<p>Add distance-based fog to create atmosphere and depth. After raymarching, you have <code>t</code> — the distance to the hit point. Use this to blend toward a fog color:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> fogColor <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.6</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">);</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> fogAmount <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">exp</span><span class="op">(-</span>t <span class="op">*</span> <span class="fl">0.1</span><span class="op">);</span>  <span class="co">// Exponential fog</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="bu">mix</span><span class="op">(</span>color<span class="op">,</span> fogColor<span class="op">,</span> fogAmount<span class="op">);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To see the effect clearly, create a scene with several objects at different distances — try a row of spheres receding into the distance:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sdPlane</span><span class="op">(</span>p<span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">float</span> i <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="fl">5.0</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>d<span class="op">,</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span> <span class="op">-</span> i <span class="op">*</span> <span class="fl">3.0</span><span class="op">),</span> <span class="fl">0.8</span><span class="op">));</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> d<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Exploration 3: Animation</strong></p>
<p>Make the scene come alive with <code>iTime</code>. Here’s a pulsing sphere:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdPulsingSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> baseRadius<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> r <span class="op">=</span> baseRadius <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="bu">sin</span><span class="op">(</span>iTime <span class="op">*</span> <span class="fl">3.0</span><span class="op">));</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> r<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now try your own animations:</p>
<ul>
<li>A torus that rotates (hint: rotate <code>p</code> before passing to <code>sdTorus</code>)</li>
<li>A sphere that orbits another sphere</li>
<li>Objects that bounce up and down</li>
<li>A “breathing” scene where everything pulses together</li>
</ul>
<p><strong>Exploration 4: Cone SDF</strong></p>
<p>Let’s derive SDFs for shapes with rotational symmetry.</p>
<p>A cylinder is the set of points within distance <span class="math inline">\(r\)</span> of an axis, bounded by two heights. For a cylinder along the Y-axis, we measure distance from the Y-axis by ignoring the y-coordinate:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sdCylinder</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">float</span> r<span class="op">,</span> <span class="dt">float</span> h<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dRadial <span class="op">=</span> <span class="bu">length</span><span class="op">(</span>p<span class="op">.</span><span class="fu">xz</span><span class="op">)</span> <span class="op">-</span> r<span class="op">;</span>    <span class="co">// Distance from curved surface</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dVertical <span class="op">=</span> <span class="bu">abs</span><span class="op">(</span>p<span class="op">.</span><span class="fu">y</span><span class="op">)</span> <span class="op">-</span> h<span class="op">;</span>       <span class="co">// Distance from caps (half-height h)</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">min</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>dRadial<span class="op">,</span> dVertical<span class="op">),</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">+</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>           <span class="bu">length</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span><span class="dt">vec2</span><span class="op">(</span>dRadial<span class="op">,</span> dVertical<span class="op">),</span> <span class="fl">0.0</span><span class="op">));</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This combines a “2D circle” (in xz) with a “1D segment” (in y) — the same pattern as the box SDF.</p>
<p><strong>Your task:</strong> Derive the SDF for a cone. A cone has its tip at the origin, opens upward along the Y-axis, and has a half-angle <span class="math inline">\(\theta\)</span>. Think about:</p>
<ul>
<li>At height <span class="math inline">\(y\)</span>, what’s the radius of the cone at that level?</li>
<li>How do you measure distance from a slanted surface?</li>
<li>How do you cap the cone at a maximum height?</li>
</ul>
<p>Hint: The key insight is that at height <span class="math inline">\(y\)</span>, the cone’s radius is <span class="math inline">\(y \tan(\theta)\)</span>. The radial distance becomes <code>length(p.xz) - p.y * tan(angle)</code>.</p>
<p>Add both a cylinder and a cone to your scene to verify they work.</p>
<p><strong>Exploration 5: Smooth Blending</strong></p>
<p>The <code>min</code> function creates hard unions — objects meet at sharp seams. For organic shapes, we want smooth blending. The <strong>smooth minimum</strong> interpolates between distances:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">smin</span><span class="op">(</span><span class="dt">float</span> a<span class="op">,</span> <span class="dt">float</span> b<span class="op">,</span> <span class="dt">float</span> k<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> h <span class="op">=</span> <span class="bu">max</span><span class="op">(</span>k <span class="op">-</span> <span class="bu">abs</span><span class="op">(</span>a <span class="op">-</span> b<span class="op">),</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">/</span> k<span class="op">;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">min</span><span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">-</span> h <span class="op">*</span> h <span class="op">*</span> k <span class="op">*</span> <span class="fl">0.25</span><span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The parameter <code>k</code> controls the blending radius — larger <code>k</code> means smoother blends.</p>
<p>Create a “metaball” or “lava lamp” effect:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> s1 <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(-</span><span class="fl">0.8</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> s2 <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.8</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">smin</span><span class="op">(</span>s1<span class="op">,</span> s2<span class="op">,</span> <span class="fl">0.5</span><span class="op">);</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now animate the spheres moving toward and away from each other. Watch them merge and separate!</p>
<p><strong>Exploration 6: Normal Coloring</strong></p>
<p>Surface normals aren’t just for lighting — they can be the color itself. This is a classic debugging visualization that also creates beautiful abstract images.</p>
<p>The normal vector has components in <span class="math inline">\([-1, 1]\)</span>, but colors need to be in <span class="math inline">\([0, 1]\)</span>. Remap with:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> color <span class="op">=</span> normal <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now surfaces facing right (+X) are red, surfaces facing up (+Y) are green, and surfaces facing the camera (+Z) are blue. Mixtures create cyan, magenta, yellow.</p>
<p>Try this on your multi-object scene. Notice how it reveals the surface geometry in a way that solid colors hide. This is also useful for debugging — if you see unexpected colors, your normals might be wrong.</p>
<p>Extend this:</p>
<ul>
<li>Try <code>abs(normal)</code> instead — what changes?</li>
<li>Use only one component: <code>vec3(normal.y * 0.5 + 0.5)</code> for a height-based coloring</li>
<li>Animate: blend between normal coloring and your regular material colors</li>
</ul>
</section>
<section id="challenges" class="level3">
<h3 class="anchored" data-anchor-id="challenges">Challenges</h3>
<p>These are substantial projects that extend the techniques from the lecture. Each might take an hour or more.</p>
<p><strong>Challenge 1: CSG Operations</strong></p>
<p>We used <code>min</code> for union. Implement intersection and subtraction:</p>
<ul>
<li><strong>Intersection</strong>: <code>max(a, b)</code> — only points inside <em>both</em> shapes</li>
<li><strong>Subtraction</strong>: <code>max(a, -b)</code> — points inside A but outside B</li>
</ul>
<p>Practice with these shapes:</p>
<ul>
<li>A cube with a spherical cavity (intersection of cube and inverted sphere)</li>
<li>The intersection of two spheres (lens shape)</li>
<li>A sphere with a cylindrical hole through it</li>
</ul>
<p>Then put it all together: <strong>make a coffee cup</strong>. You’ll need:</p>
<ul>
<li>A cylinder for the body</li>
<li>A smaller cylinder subtracted for the hollow interior</li>
<li>A torus attached with <code>smin</code> for the handle</li>
</ul>
<p><strong>Challenge 2: Infinite Repetition</strong></p>
<p>The <code>mod</code> function can repeat space, creating infinite grids of objects:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> spacing <span class="op">=</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">4.0</span><span class="op">);</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> q <span class="op">=</span> <span class="bu">mod</span><span class="op">(</span>p <span class="op">+</span> spacing <span class="op">*</span> <span class="fl">0.5</span><span class="op">,</span> spacing<span class="op">)</span> <span class="op">-</span> spacing <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">sdSphere</span><span class="op">(</span>q<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This creates an infinite 3D grid of spheres. Experiment with:</p>
<ul>
<li>Different spacing in different directions</li>
<li>Repeating only in 2D (an infinite floor of objects)</li>
<li>Combining repeated and non-repeated objects</li>
<li>Alternating shapes using <code>floor(p / spacing)</code></li>
</ul>
<p><strong>Challenge 3: Orbiting Camera</strong></p>
<p>Implement a camera that orbits around the scene. You’ll need a rotation matrix:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="dt">mat3</span> <span class="fu">rotateY</span><span class="op">(</span><span class="dt">float</span> angle<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> c <span class="op">=</span> <span class="bu">cos</span><span class="op">(</span>angle<span class="op">);</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> s <span class="op">=</span> <span class="bu">sin</span><span class="op">(</span>angle<span class="op">);</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="dt">mat3</span><span class="op">(</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        c<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> s<span class="op">,</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>s<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> c</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In <code>mainImage</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> angle <span class="op">=</span> iTime <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span>  <span class="co">// Rotate over time</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="dt">mat3</span> rot <span class="op">=</span> <span class="fu">rotateY</span><span class="op">(</span>angle<span class="op">);</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>Ray ray <span class="op">=</span> <span class="fu">generateRay</span><span class="op">(</span>fragCoord<span class="op">);</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>ray<span class="op">.</span><span class="fu">origin</span> <span class="op">=</span> rot <span class="op">*</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">2.0</span><span class="op">,</span> <span class="fl">5.0</span><span class="op">);</span>  <span class="co">// Camera position, rotated</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>ray<span class="op">.</span><span class="fu">dir</span> <span class="op">=</span> rot <span class="op">*</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">;</span>                  <span class="co">// View direction, rotated</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This rotates the camera around a fixed scene. Alternatively, you could keep the camera fixed and rotate <code>p</code> inside <code>sceneSDF</code> — this rotates the scene instead of the camera. Try both and see which feels more natural.</p>
<p>Extend this to:</p>
<ul>
<li>Add vertical bobbing with <code>sin(iTime)</code></li>
<li>Let the camera tilt (rotation around X)</li>
<li>Zoom in and out over time</li>
</ul>
<p><strong>Challenge 4: Reflections</strong></p>
<p>Make the ground plane into a mirror. The idea: when a ray hits a reflective surface, compute the reflection direction and raymarch again.</p>
<p>We check which object we hit using <code>materialID</code>, and only reflect off the ground:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> color <span class="op">=</span> <span class="fu">shade</span><span class="op">(</span>hitPoint<span class="op">,</span> normal<span class="op">,</span> ray<span class="op">.</span><span class="fu">dir</span><span class="op">);</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Only reflect off the ground (material 3)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>materialID <span class="op">&gt;</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> reflectDir <span class="op">=</span> <span class="bu">reflect</span><span class="op">(</span>ray<span class="op">.</span><span class="fu">dir</span><span class="op">,</span> normal<span class="op">);</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    Ray reflectedRay<span class="op">;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    reflectedRay<span class="op">.</span><span class="fu">origin</span> <span class="op">=</span> hitPoint <span class="op">+</span> normal <span class="op">*</span> <span class="fl">0.01</span><span class="op">;</span>  <span class="co">// Offset to avoid self-intersection</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    reflectedRay<span class="op">.</span><span class="fu">dir</span> <span class="op">=</span> reflectDir<span class="op">;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t2 <span class="op">=</span> <span class="fu">raymarch</span><span class="op">(</span>reflectedRay<span class="op">);</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>t2 <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectedHit <span class="op">=</span> reflectedRay<span class="op">.</span><span class="fu">origin</span> <span class="op">+</span> t2 <span class="op">*</span> reflectedRay<span class="op">.</span><span class="fu">dir</span><span class="op">;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectedNormal <span class="op">=</span> <span class="fu">estimateNormal</span><span class="op">(</span>reflectedHit<span class="op">);</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vec3</span> reflectedColor <span class="op">=</span> <span class="fu">shade</span><span class="op">(</span>reflectedHit<span class="op">,</span> reflectedNormal<span class="op">,</span> reflectedRay<span class="op">.</span><span class="fu">dir</span><span class="op">);</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="bu">mix</span><span class="op">(</span>color<span class="op">,</span> reflectedColor<span class="op">,</span> <span class="fl">0.5</span><span class="op">);</span>  <span class="co">// 50% reflective</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The small offset (<code>normal * 0.01</code>) prevents the reflected ray from immediately hitting the same surface it started from.</p>
<p><strong>Challenge 5: Struct-Based Materials</strong></p>
<p>Refactor the global <code>materialID</code> pattern into a cleaner struct-based design:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Surface <span class="op">{</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dist<span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> matID<span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>Surface <span class="fu">sdSphere</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">,</span> <span class="dt">vec3</span> center<span class="op">,</span> <span class="dt">float</span> radius<span class="op">,</span> <span class="dt">float</span> matID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">Surface</span><span class="op">(</span><span class="bu">length</span><span class="op">(</span>p <span class="op">-</span> center<span class="op">)</span> <span class="op">-</span> radius<span class="op">,</span> matID<span class="op">);</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>Surface <span class="fu">opUnion</span><span class="op">(</span>Surface a<span class="op">,</span> Surface b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">(</span>a<span class="op">.</span><span class="fu">dist</span> <span class="op">&lt;</span> b<span class="op">.</span><span class="fu">dist</span><span class="op">)</span> <span class="op">?</span> a <span class="op">:</span> b<span class="op">;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>Surface <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    Surface s <span class="op">=</span> <span class="fu">sdSphere</span><span class="op">(</span>p<span class="op">,</span> <span class="dt">vec3</span><span class="op">(-</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="fu">opUnion</span><span class="op">(</span>s<span class="op">,</span> <span class="fu">sdTorus</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">),</span> <span class="fl">2.0</span><span class="op">));</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="fu">opUnion</span><span class="op">(</span>s<span class="op">,</span> <span class="fu">sdPlane</span><span class="op">(</span>p<span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">3.0</span><span class="op">));</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> s<span class="op">;</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>You’ll need to update:</p>
<ul>
<li>All SDF primitives to return <code>Surface</code></li>
<li>The <code>raymarch</code> function to work with <code>Surface.dist</code></li>
<li>The <code>estimateNormal</code> function (it only needs distance, so call <code>sceneSDF(p).dist</code>)</li>
</ul>
<p>This is more code, but the material tracking is now explicit and composable.</p>
<p><strong>Challenge 6: Hard Shadows</strong></p>
<p>Shadows add tremendous depth to a scene. The idea: before shading a point, check if there’s anything between it and the light.</p>
<p>We already know how to check if a ray hits something — that’s raymarching! For shadows, we raymarch from the hit point toward the light:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">hardShadow</span><span class="op">(</span><span class="dt">vec3</span> origin<span class="op">,</span> <span class="dt">vec3</span> lightDir<span class="op">,</span> <span class="dt">float</span> maxDist<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> t <span class="op">=</span> <span class="fl">0.02</span><span class="op">;</span>  <span class="co">// Start slightly away from surface</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> d <span class="op">=</span> <span class="fu">sceneSDF</span><span class="op">(</span>origin <span class="op">+</span> lightDir <span class="op">*</span> t<span class="op">);</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>d <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span> <span class="kw">return</span> <span class="fl">0.0</span><span class="op">;</span>  <span class="co">// Hit something — in shadow</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        t <span class="op">+=</span> d<span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>t <span class="op">&gt;</span> maxDist<span class="op">)</span> <span class="kw">break</span><span class="op">;</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fl">1.0</span><span class="op">;</span>  <span class="co">// Reached the light — not in shadow</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Use it in your lighting calculation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> lightDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">2.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> shadow <span class="op">=</span> <span class="fu">hardShadow</span><span class="op">(</span>hitPoint <span class="op">+</span> normal <span class="op">*</span> <span class="fl">0.02</span><span class="op">,</span> lightDir<span class="op">,</span> <span class="fl">10.0</span><span class="op">);</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> diffuse <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">dot</span><span class="op">(</span>normal<span class="op">,</span> lightDir<span class="op">));</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> matColor <span class="op">*</span> <span class="op">(</span>ambient <span class="op">+</span> diffuse <span class="op">*</span> shadow<span class="op">);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The offset <code>normal * 0.02</code> prevents the shadow ray from immediately hitting the surface it started from (self-shadowing artifacts).</p>
<p>Things to try:</p>
<ul>
<li>Add shadows to your multi-object scene</li>
<li>Use different shadow intensities (multiply by 0.5 instead of 0.0 for softer shadows)</li>
<li>Only cast shadows from your key light, not fill lights</li>
</ul>
</section>
<section id="project" class="level3">
<h3 class="anchored" data-anchor-id="project">Project</h3>
<p><strong>Algebraic Variety Rendering</strong></p>
<p>An <strong>algebraic variety</strong> is the zero set of a polynomial — a surface defined by <span class="math inline">\(f(x, y, z) = 0\)</span>. These surfaces have been studied for centuries, and some of them are strikingly beautiful. In this project, you’ll build a raymarcher that can render any algebraic variety.</p>
<section id="distance-estimation" class="level4">
<h4 class="anchored" data-anchor-id="distance-estimation">Distance Estimation</h4>
<p>We can’t compute an exact SDF for a general polynomial, but we can <em>estimate</em> the distance. The key insight: near the surface, the function value <span class="math inline">\(f(\mathbf{p})\)</span> is approximately proportional to distance, with the gradient <span class="math inline">\(\nabla f\)</span> telling us how fast <span class="math inline">\(f\)</span> changes.</p>
<p>This gives us the <strong>distance estimate</strong>:</p>
<p><span class="math display">\[d \approx \frac{|f(\mathbf{p})|}{|\nabla f(\mathbf{p})|}\]</span></p>
<p>This isn’t a true SDF — it can overestimate or underestimate — but it’s good enough for raymarching if we’re conservative. In practice, we often scale it down slightly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">estimateDistance</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> f <span class="op">=</span> <span class="fu">polynomial</span><span class="op">(</span>p<span class="op">);</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span> grad <span class="op">=</span> <span class="fu">gradient</span><span class="op">(</span>p<span class="op">);</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="bu">abs</span><span class="op">(</span>f<span class="op">)</span> <span class="op">/</span> <span class="bu">length</span><span class="op">(</span>grad<span class="op">);</span>  <span class="co">// Factor of 0.5 for safety</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>You’ll need to compute the gradient. You can either derive it analytically from the polynomial (faster, exact), or estimate it numerically with finite differences (easier, works for any polynomial):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> <span class="fu">gradient</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="dt">vec3</span><span class="op">(</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">polynomial</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">polynomial</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span>eps<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">)),</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">polynomial</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">-</span> <span class="fu">polynomial</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> eps<span class="op">,</span> <span class="dv">0</span><span class="op">)),</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">polynomial</span><span class="op">(</span>p <span class="op">+</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span> <span class="op">-</span> <span class="fu">polynomial</span><span class="op">(</span>p <span class="op">-</span> <span class="dt">vec3</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> eps<span class="op">))</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> eps<span class="op">);</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="bounding-volume" class="level4">
<h4 class="anchored" data-anchor-id="bounding-volume">Bounding Volume</h4>
<p>Algebraic varieties can extend to infinity or have complex topology. To raymarch efficiently, first intersect with a bounding sphere or box:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">sceneSDF</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bounding sphere</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> bounds <span class="op">=</span> <span class="bu">length</span><span class="op">(</span>p<span class="op">)</span> <span class="op">-</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>bounds <span class="op">&gt;</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> bounds<span class="op">;</span>  <span class="co">// Outside bounds: use sphere distance</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inside bounds: use variety distance estimate</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">estimateDistance</span><span class="op">(</span>p<span class="op">);</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This lets us skip the expensive polynomial evaluation until we’re close.</p>
</section>
<section id="normals" class="level4">
<h4 class="anchored" data-anchor-id="normals">Normals</h4>
<p>For lighting, the gradient gives us the normal direction:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> normal <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span><span class="fu">gradient</span><span class="op">(</span>hitPoint<span class="op">));</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>If the gradient points “inward” relative to your camera, you may need to flip it.</p>
</section>
<section id="rotation" class="level4">
<h4 class="anchored" data-anchor-id="rotation">Rotation</h4>
<p>To view the variety from different angles, rotate the point before evaluating:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">polynomial</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">rotateY</span><span class="op">(</span>iTime <span class="op">*</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">*</span> p<span class="op">;</span>  <span class="co">// Slow rotation</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... evaluate polynomial ...</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="a-gallery-of-varieties" class="level4">
<h4 class="anchored" data-anchor-id="a-gallery-of-varieties">A Gallery of Varieties</h4>
<p>Here are some beautiful algebraic surfaces to try. Each is written as <span class="math inline">\(f(x,y,z) = 0\)</span>.</p>
<p><strong>Barth Sextic</strong> (degree 6) — 50 double points, icosahedral symmetry:</p>
<p><span class="math display">\[4(\phi^2 x^2 - y^2)(\phi^2 y^2 - z^2)(\phi^2 z^2 - x^2) - (1 + 2\phi)(x^2 + y^2 + z^2 - 1)^2 = 0\]</span></p>
<p>where <span class="math inline">\(\phi = \frac{1 + \sqrt{5}}{2}\)</span> is the golden ratio.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">barthSextic</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> phi <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> <span class="bu">sqrt</span><span class="op">(</span><span class="fl">5.0</span><span class="op">))</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> phi2 <span class="op">=</span> phi <span class="op">*</span> phi<span class="op">;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x2 <span class="op">=</span> p<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> y2 <span class="op">=</span> p<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z2 <span class="op">=</span> p<span class="op">.</span><span class="fu">z</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> a <span class="op">=</span> <span class="op">(</span>phi2 <span class="op">*</span> x2 <span class="op">-</span> y2<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>phi2 <span class="op">*</span> y2 <span class="op">-</span> z2<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>phi2 <span class="op">*</span> z2 <span class="op">-</span> x2<span class="op">);</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> b <span class="op">=</span> <span class="op">(</span>x2 <span class="op">+</span> y2 <span class="op">+</span> z2 <span class="op">-</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fl">4.0</span> <span class="op">*</span> a <span class="op">-</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> <span class="fl">2.0</span> <span class="op">*</span> phi<span class="op">)</span> <span class="op">*</span> b <span class="op">*</span> b<span class="op">;</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Clebsch Diagonal Cubic</strong> (degree 3) — contains exactly 27 lines:</p>
<p><span class="math display">\[81(x^3 + y^3 + z^3) - 189(x^2 y + x^2 z + y^2 x + y^2 z + z^2 x + z^2 y) + 54xyz + 126(xy + xz + yz) - 9(x^2 + y^2 + z^2) - 9(x + y + z) + 1 = 0\]</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">clebschCubic</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x <span class="op">=</span> p<span class="op">.</span><span class="fu">x</span><span class="op">,</span> y <span class="op">=</span> p<span class="op">.</span><span class="fu">y</span><span class="op">,</span> z <span class="op">=</span> p<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x2 <span class="op">=</span> x<span class="op">*</span>x<span class="op">,</span> y2 <span class="op">=</span> y<span class="op">*</span>y<span class="op">,</span> z2 <span class="op">=</span> z<span class="op">*</span>z<span class="op">;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x3 <span class="op">=</span> x2<span class="op">*</span>x<span class="op">,</span> y3 <span class="op">=</span> y2<span class="op">*</span>y<span class="op">,</span> z3 <span class="op">=</span> z2<span class="op">*</span>z<span class="op">;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fl">81.0</span><span class="op">*(</span>x3 <span class="op">+</span> y3 <span class="op">+</span> z3<span class="op">)</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> <span class="fl">189.0</span><span class="op">*(</span>x2<span class="op">*</span>y <span class="op">+</span> x2<span class="op">*</span>z <span class="op">+</span> y2<span class="op">*</span>x <span class="op">+</span> y2<span class="op">*</span>z <span class="op">+</span> z2<span class="op">*</span>x <span class="op">+</span> z2<span class="op">*</span>y<span class="op">)</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>         <span class="op">+</span> <span class="fl">54.0</span><span class="op">*</span>x<span class="op">*</span>y<span class="op">*</span>z</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>         <span class="op">+</span> <span class="fl">126.0</span><span class="op">*(</span>x<span class="op">*</span>y <span class="op">+</span> x<span class="op">*</span>z <span class="op">+</span> y<span class="op">*</span>z<span class="op">)</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> <span class="fl">9.0</span><span class="op">*(</span>x2 <span class="op">+</span> y2 <span class="op">+</span> z2<span class="op">)</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> <span class="fl">9.0</span><span class="op">*(</span>x <span class="op">+</span> y <span class="op">+</span> z<span class="op">)</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>         <span class="op">+</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Cayley Cubic</strong> (degree 3) — 4 nodes:</p>
<p><span class="math display">\[x^2 + y^2 - x^2 z + y^2 z + z^2 - 1 = 0\]</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">cayleyCubic</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x2 <span class="op">=</span> p<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> y2 <span class="op">=</span> p<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z2 <span class="op">=</span> p<span class="op">.</span><span class="fu">z</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> x2 <span class="op">+</span> y2 <span class="op">-</span> x2 <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span> <span class="op">+</span> y2 <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span> <span class="op">+</span> z2 <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Kummer Surface</strong> (degree 4) — 16 nodes:</p>
<p><span class="math display">\[(x^2 + y^2 + z^2 - \mu^2)^2 - \lambda \cdot p_0 p_1 p_2 p_3 = 0\]</span></p>
<p>where <span class="math inline">\(p_i\)</span> are planes forming a tetrahedron. A simplified version:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">kummerSurface</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x2 <span class="op">=</span> p<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> y2 <span class="op">=</span> p<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z2 <span class="op">=</span> p<span class="op">.</span><span class="fu">z</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> sum <span class="op">=</span> x2 <span class="op">+</span> y2 <span class="op">+</span> z2<span class="op">;</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> prod <span class="op">=</span> x2 <span class="op">*</span> y2 <span class="op">+</span> y2 <span class="op">*</span> z2 <span class="op">+</span> z2 <span class="op">*</span> x2<span class="op">;</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> mu <span class="op">=</span> <span class="fl">1.3</span><span class="op">;</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> lambda <span class="op">=</span> <span class="fl">3.0</span><span class="op">;</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> a <span class="op">=</span> sum <span class="op">-</span> mu <span class="op">*</span> mu<span class="op">;</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">*</span> a <span class="op">-</span> lambda <span class="op">*</span> prod<span class="op">;</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Heart Surface</strong> (degree 6) — for fun:</p>
<p><span class="math display">\[(x^2 + \frac{9}{4}y^2 + z^2 - 1)^3 - x^2 z^3 - \frac{9}{80}y^2 z^3 = 0\]</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode glsl code-with-copy"><code class="sourceCode glsl"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">heartSurface</span><span class="op">(</span><span class="dt">vec3</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x2 <span class="op">=</span> p<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> y2 <span class="op">=</span> p<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z2 <span class="op">=</span> p<span class="op">.</span><span class="fu">z</span> <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> z3 <span class="op">=</span> z2 <span class="op">*</span> p<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> a <span class="op">=</span> x2 <span class="op">+</span> <span class="fl">2.25</span> <span class="op">*</span> y2 <span class="op">+</span> z2 <span class="op">-</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">*</span> a <span class="op">*</span> a <span class="op">-</span> x2 <span class="op">*</span> z3 <span class="op">-</span> <span class="fl">0.1125</span> <span class="op">*</span> y2 <span class="op">*</span> z3<span class="op">;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="your-task" class="level4">
<h4 class="anchored" data-anchor-id="your-task">Your Task</h4>
<p>Build a beautiful scene featuring an algebraic variety. Your shader should:</p>
<ol type="1">
<li>Implement distance estimation for at least one variety</li>
<li>Use a bounding volume for efficiency</li>
<li>Include proper lighting with surface normals</li>
</ol>
<p>Beyond that, get creative! Some ideas:</p>
<ul>
<li>Add a reflective floor beneath the variety</li>
<li>Use multiple colored lights</li>
<li>Add fog for atmosphere</li>
<li>Make the variety rotate slowly</li>
<li>Try different varieties and find your favorite</li>
<li>Combine multiple varieties in one scene</li>
</ul>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>